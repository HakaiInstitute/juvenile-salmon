---
title: "Juvenile Sockeye Salmon Stock ID Report: 2015 — 2016"
output:
  rmarkdown::pdf_document:
    
    fig_caption: yes
    includes:
      in_header: figure_opts.tex
    latex_engine: xelatex
sansfont: Times New Roman
fontsize: 12pt

header-includes:
- \usepackage{booktabs}
- \usepackage{sectsty} \sectionfont{\centering \emph}
      
---

\begin{center}
\large
— Hakai Institute Juvenile Salmon Program —
\end{center}

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE, error=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(hakaisalmon, suppressMessages())
library(tidyverse)
library(forcats)
library(lubridate)
library(ggjoy)
library(knitr)
library(here)

```

## Aim 

To provide a summary of Hakai Institute Juvenile Salmon program sockeye stock 
proportions caught in 2015 and 2016.

## Background

The Hakai Institute Juvenile Salmon Program was launched in the spring of 2015 in a collaborative partnership with UBC, SFU, Salmon Coast, Pacific Salmon Foundation, and DFO. The program operates in the [Discovery Islands and Johnstone Strait](https://www.arcgis.com/home/webmap/viewer.html?webmap=f5593697e54143dbb1b5019d70490b68&extent=-127.5928,49.4993,-123.5361,51.0439) and thus provides information on the health of juvenile Fraser River salmon after passage through: 

1) Strait of Georgia – stratified high plankton biomass zone; and 

2) Discovery Islands & Johnstone Strait – highly-mixed low-plankton-biomass zone, and area of high wild-farmed fish interactions.

## Program Objectives

1) Determine migration timing and pathways; 

2) Migration habitat mapping - oceanographic conditions along the migration route;

3) Understand the dynamics of the plankton food-webs that underpin juvenile salmon growth and
health;

4) Understand parasite and pathogen infection dynamics and their impact on juvenile salmon growth and
health.

## Key Parameters Reported
* Stock ID proportions by year
* Stock ID by site and by region
* Stock ID by site, region, and two-week period

Please direct questions or comments to Brian Hunt (B.Hunt@oceans.ubc.ca) and/or Brett Johnson (Brett.Johnson@hakai.org). 

__Report prepared by:__ Brett Johnson, Carly Janusson, Julian Gan, and Brian Hunt  
__Date:__ `r Sys.Date()`  

```{r Table to share}
summary_table <- hakaisalmon::survey_seines_fish_stock_id %>% 
  filter(prob_1 > .6) %>% 
  mutate(year = as.factor(year(survey_date))) %>% 
  drop_na(stock_1) %>% 
  select(year, site_id, stock_1, region_1) %>% 
  group_by(year, site_id, stock_1) %>% 
  summarize(n = n()) %>%
  drop_na(n) %>% 
  spread(key = site_id , value = n, fill = 0) %>% 
  ungroup()

write_csv(summary_table, "./data/annual_stock_summary.csv")

tidy_summary_table  <- summary_table %>% 
  gather(`D01`,`D02`,`D03`,`D04`,`D05`,`D06`,`D07`,`D08`,`D09`,`D10`,`D11`,`D20`,`D21`,`D22`,`D24`,`D25`,`D27`,`J01`,`J02`,`J03`,`J04`,`J05`,`J06`,`J07`,`J08`,`J09`,`J10`, key = "site_id", value = "n_taken") %>% 
  filter(n_taken > 0)

tidy_summary_table$stock_1 <- as_factor(tidy_summary_table$stock_1)
```

## Genetic Stock ID Proportions

The genetic stock which a sockeye originates from was identified using the cBayes
program by Department of Fisheries and Oceans staff based in the Molecular
Genetics Lab at the Pacific Biological Station in Nanaimo, BC.

We've only included stocks that had a stock assignment probability of greater 
than 60%.

Over 50 unique stocks were assigned and the follwoing plots were summarized by
calculating the proportion of the most dominant stocks. A table is included with
this report that details the number of stocks observed at every site over 2015 
and 2016.

### Propotions by year
```{r GSI summmary, message = FALSE, fig.cap= "Genetic stock ID proportions summarized year. Stocks that contributed less than 6 % are lumped as NA and if a stock assignment "}
# Calculate GSI proportion for sockeye by both regions
by_year <- tidy_summary_table %>% 
  group_by(year, stock_1) %>% 
  mutate(n = sum(n_taken)) %>% 
  select(-n_taken, -site_id) %>% 
  distinct() %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(proportion = n / sum(n)) %>% 
  filter(proportion >= 0.03) %>% 
  arrange(desc(proportion)) %>% 
  ungroup()

prop_remaining <- by_year %>% 
  group_by(year) %>% 
  summarize(remaining = 1 - sum(proportion))

prop_remaining_2015 <- as.numeric(prop_remaining[1,2])
prop_remaining_2016 <- as.numeric(prop_remaining[2,2])

by_year<- by_year %>% 
  add_row(year = 2015, stock_1 = NA, proportion = prop_remaining_2015) %>% 
  add_row(year = 2016, stock_1 = NA, proportion = prop_remaining_2016) 

by_year_plot <- ggplot(by_year, aes(x = year, y = proportion, 
                                    fill = fct_reorder(stock_1, proportion))) +
  geom_bar(colour="black", stat="identity", position = 'stack') +
  scale_fill_discrete(name="Genetic Stock")

by_year_plot
ggsave("./final_figs/year_stock_summary.png")
```

### Proportions by region and year
```{r}
by_region_by_year <- survey_seines_fish_stock_id %>% 
  filter(stock_1 > .6) %>% 
  mutate(year = as.factor(year(survey_date))) %>% 
  group_by(year, region, stock_1) %>% 
  summarize(n = n()) %>%
  mutate(proportion = n / sum(n)) %>% 
  filter(proportion >= 0.04) %>%
  arrange(desc(proportion)) %>% 
  ungroup()

prop_remaining <- by_region_by_year %>% 
  group_by(year, region) %>%
  summarize(remaining = 1 - sum(proportion))
  
  
prop_remaining_2015_DI <- as.numeric(prop_remaining[1,3])
prop_remaining_2015_JS <- as.numeric(prop_remaining[2,3])
prop_remaining_2016_DI <- as.numeric(prop_remaining[3,3])
prop_remaining_2016_JS <- as.numeric(prop_remaining[4,3])

by_region_by_year<- by_region_by_year %>%  
add_row(year = 2015, region = "DI", stock_1 = NA, proportion = prop_remaining_2015_DI) %>% 
add_row(year = 2015, region = "JS", stock_1 = NA, proportion = prop_remaining_2015_JS) %>% 
add_row(year = 2016, region = "DI", stock_1 = NA, proportion = prop_remaining_2016_DI) %>% 
add_row(year = 2016, region = "JS", stock_1 = NA, proportion = prop_remaining_2016_JS)

(by_region_by_year_plot <- ggplot(by_region_by_year, aes(x = region, y = proportion, fill = stock_1)) +
  geom_bar(colour="black", stat="identity", position = 'stack')) +
  facet_grid(~year)
```


### Proportions by region, year, and sampling_week
```{r}

```



\newpage

