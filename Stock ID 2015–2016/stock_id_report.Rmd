---
title: "Discovery Islands and Johnstone Strait Stock ID Report: 2015 — 2016"
output:
  rmarkdown::pdf_document:
    
    fig_caption: yes
    includes:
      in_header: figure_opts.tex
    latex_engine: xelatex
sansfont: Times New Roman
fontsize: 12pt

header-includes:
- \usepackage{booktabs}
- \usepackage{sectsty} \sectionfont{\centering \emph}
      
---

\begin{center}
\large
— Hakai Institute Juvenile Salmon Program —
\end{center}

```{r setup, echo = FALSE, warning=FALSE, message=FALSE, error=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hakaisalmon)
library(tidyverse)
library(forcats)
library(lubridate)
library(ggjoy)
library(knitr)
library(here)

```

## Aim 

To provide a summary of Hakai Institute Juvenile Salmon program sockeye stock 
proportions caught in 2015 and 2016.

## Background

The Hakai Institute Juvenile Salmon Program was launched in the spring of 2015 in a collaborative partnership with UBC, SFU, Salmon Coast, Pacific Salmon Foundation, and DFO. The program operates in the Discovery Islands and Johnstone Strait (Figure 1) and thus provides information on the health of juvenile Fraser River salmon after passage through: 

1) Strait of Georgia – stratified high plankton biomass zone; and 

2) Discovery Islands & Johnstone Strait – highly-mixed low-plankton-biomass zone, and area of high wild-farmed fish interactions.

## Program Objectives

1) Determine migration timing and pathways; 

2) Migration habitat mapping - oceanographic conditions along the migration route;

3) Understand the dynamics of the plankton food-webs that underpin juvenile salmon growth and
health;

4) Understand parasite and pathogen infection dynamics and their impact on juvenile salmon growth and
health.

## Key Parameters Reported
* Stock ID by region
* Stock ID by site and by region
* Stock ID by site, region, and two-week period

![Salmon sampling locations in the Discovery Islands and Johnstone Strait in 2017 (yellow circles).](./final_figures/map_2017.pdf)

We are endeavouring to provide useful information for the entire salmon research community. As such we welcome any feedback. Please direct questions or comments to Brian Hunt (B.Hunt@oceans.ubc.ca) and/or Brett Johnson (Brett.Johnson@hakai.org). 

__Report prepared by:__ Brett Johnson, Carly Janusson, Julian Gan, and Brian Hunt  
__Updated:__ `r Sys.Date()`  

## Genetic Stock ID Proportions

```{r GSI summmary, fig.cap= "Genetic stock ID proportions by region and by year."}
# Calculate GSI proportion for sockeye by both regions
by_region_by_year <- survey_seines_fish_stock_id %>% 
  filter(stock_1 > .6) %>% 
  mutate(year = as.factor(year(survey_date))) %>% 
  group_by(year, region, stock_1) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  filter(proportion >= 0.04) %>% 
  arrange(desc(proportion)) %>% 
  ungroup()

prop_remaining <- by_region_by_year %>% 
  group_by(year, region) %>% 
  summarize(remaining = 1 - sum(proportion))

prop_remaining_2015_DI <- as.numeric(prop_remaining[1,3])
prop_remaining_2015_JS <- as.numeric(prop_remaining[2,3])
prop_remaining_2016_DI <- as.numeric(prop_remaining[3,3])
prop_remaining_2016_JS <- as.numeric(prop_remaining[4,3])

by_region_by_year<- by_region_by_year %>% 
  add_row(year = 2015, region = "DI", stock_1 = NA, proportion = prop_remaining_2015_DI) %>% 
  add_row(year = 2015, region = "JS", stock_1 = NA, proportion = prop_remaining_2015_JS) %>% 
  add_row(year = 2016, region = "DI", stock_1 = NA, proportion = prop_remaining_2016_DI) %>% 
  add_row(year = 2016, region = "JS", stock_1 = NA, proportion = prop_remaining_2016_JS)

by_region_by_year_plot <- ggplot(by_region_by_year, aes(x = region, y = proportion, fill = stock_1)) +
  geom_bar(colour="black", stat="identity", position = 'stack') +
  facet_grid(~year) 

by_region_by_year_plot
ggsave("./final_figs/year_region_stock.png")
```

### Cumulative Abundance of Sockeye by Region
```{r Sockeye Cumulative Abundance, echo = FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.cap = "The cumulative abundance of sockeye captured in the Discovery Islands and Johnstone Strait in 2017."}
# Create new columns for cumulative sums of each species captured
# Average multiple seines conducted in the same region on the same day

# This summarises and averages cpue grouped by region and sampling day
cum_abund_by_region <- field_2017 %>% 
                filter(!survey.id %in% c("DE457","DE458","DE459","DE460","DE461","DE462","DE463","DE464")) %>%
                        # The line above removes Sam James's MSc seines from this analysis becuse they are outside the 
                        # standardized effort required for cumulative abundance analysis to be unbiased. 
                select(date, region, so.total,pi.total,cu.total,co.total, he.total) %>%
                replace(is.na(.),0) %>% 
                na.omit() %>% 
                group_by(region, date) %>% 
                summarise(daily.so = mean(so.total), 
                          daily.pi = mean(pi.total),
                          daily.cu = mean(cu.total),
                          daily.co = mean(co.total),
                          daily.he = mean(he.total)
                )

# This replaces cpue for each day and each region with the cumulative sum for each species, and then tidys the data so that each row is only one observation
cum_abund_by_region <- cum_abund_by_region %>% 
                    transmute(date = date,
                              so.cum.abund = cumsum(daily.so), 
                              pi.cum.abund = cumsum(daily.pi),
                              cu.cum.abund = cumsum(daily.cu),
                              co.cum.abund = cumsum(daily.co),
                              he.cum.abund = cumsum(daily.he)
                              ) %>% 
                    gather(so.cum.abund, pi.cum.abund, cu.cum.abund,
                           co.cum.abund, he.cum.abund, key = "species", value = "cum.abund")        

# This plots cumulative abundnace of sockeye grouped by region

so_cum_abund_plot <- ggplot(data = filter(cum_abund_by_region, species == "so.cum.abund"),
        mapping = aes(x = date, y = cum.abund)) +
        geom_point(mapping = aes(colour= region)) +
        geom_line(mapping = aes(colour = region)) +
        ylab("Sockeye cumulatve abundance") + xlab("Date") +
        scale_colour_discrete(name = "",
                        breaks=c("DI","JS"),
                        labels=c("Discovery Islands", "Johnstone Strait"))+
        theme(legend.justification=c(1,0),legend.background = element_rect(fill="white")) +  
                theme(legend.text = element_text(colour="black", size = 12)) +                         theme(axis.text=element_text(size=12),
                axis.title=element_text(size=12,face="bold"))+
        theme(legend.justification=c(1,0), legend.position=c(.4,.8),
             legend.background = element_rect(fill="white")) 
so_cum_abund_plot
ggsave("./final_figures/sockeye_cumulative_abundance.png")



```

### Sockeye Catch Per Unit Effort

```{r Sockeye CPUE, echo = FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.cap="Catch per unit effort of juvenile sockeye salmon in 2017 averaged over one week periods for each region."}

so_cpue <- field_2017 %>%
        replace(is.na(.),0) %>%
        group_by(region, date, sampling.week) %>% 
        summarise(so.cpue = mean(so.total, na.rm = TRUE), 
                  so.cpue.sd = sd(so.total, na.rm = T),
                  n = n()) %>% 
        mutate(SE = so.cpue.sd / sqrt(n)) %>% 
        ungroup() %>% 
        group_by(region, sampling.week) %>% 
        summarise(so.cpue = mean(so.cpue, na.rm = TRUE), 
                  so.cpue.sd = sd(so.cpue, na.rm = T),
                  n = n()) # Eventually I should correct these SE bars because they show SE of the sampling weeks means of the daily means



so_cpue$sampling.week <- as.factor(so_cpue$sampling.week)

so_cpue_plot <- ggplot(data = so_cpue, aes(x = sampling.week, y = so.cpue, colour = region, group = region))+
        geom_line()+
        geom_point(position = position_dodge(width = 0.05))+
        #geom_errorbar(aes(ymin = so.cpue - SE, ymax = so.cpue + SE), width = 0.2, position = position_dodge(width = 0.15))+
        xlab("Date") +
        ylab("Sockeye CPUE") +
        coord_cartesian(ylim= 0:300, xlim = 1:11) +
        scale_x_discrete(breaks=c("2","3","4", "5", "6", "7", "8", "9", "10", "11"),
                        labels=c("May 12","May 19","May 26", "June 2", "June 9", "June 16",
                         "June 23", "June 30", "July 6", "July 14")) +
        scale_colour_discrete(name = "",
                        breaks=c("DI","JS"),
                        labels=c("Discovery Islands", "Johnstone Strait"))+
        theme(legend.justification=c(1,0), legend.position=c(.4,.8),
             legend.background = element_rect(fill="white")) + 
                theme(legend.text = element_text(colour="black", size = 12)) +                         theme(axis.text=element_text(size=12),
                axis.title=element_text(size=12,face="bold"))
so_cpue_plot        
ggsave("./final_figures/Sockeye_CPUE.png")


```

\newpage

