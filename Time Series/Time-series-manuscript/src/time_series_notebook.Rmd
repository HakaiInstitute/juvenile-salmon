---
title: "Notebook - Hakai Institute Juvenile Salmon Program Time Series"
author: "Brett Johnson"
date: "February 5, 2018"
output: 
  html_document:
    theme: "sandstone"
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
---

This is my lab notebook for ideas, literature review, and exploratory data analysis related to the preparation of a manuscript for reporting yearly time series data of the Hakai Institute Juvenile Salmon Program.

# Objectives
The objectives of this manuscript are to:

* Introduce the Juvenile Salmon Program
* Describe briefly the methods related to field program 
* Present time series of data
* Point to papers that present deeper analysis of time series data

# Key Parameters Reported

## Fish Metrics
* Salmon CPUE
* Spp. composition. Plot per week, per migration corridor
* Stock specific relative condition factor
* Lengths
* Weights
* Parasite loads

## Oceanography
* Chl a - Justin sorting out phaepigments...
* Phyto Biomass
* Nutrients - Depending on when they are analyzed 
* Zoop biomass	
* Temp CTD binning
* Salinity CTD binning

Overlap with other current analyses include
* Salish Sea Marine Survival Project: Run-timing, GSI, CPUE, Relative Condition, Lengths, Weights
* In-season reports: Sea lice, temp, chl a

New analysis (No overlap)

* Salinity, Nutrients, Zoop biomass, Phyto biomass. (Kang has these time series)

# Literature Review
## Migration dynamics 
Stock specific run timing and migration routes add a layer of
complexity to understanding salmon early marine survival. Run timing interacts
with plankton bloom timing and can be critical to the feeding conditions
experienced by juvenile salmon. Migration routes and rates determine the extent
to which specific populations interact with feeding hotspots / barrens as well
as potential sources of pathogen transmission (e.g., sympatric wild host fishes
and / or aquaculture facilities). As such, knowledge of stock specific migration
behavior within the Discovery Islands is critical to inform stock specific risk
assessment.

Put into context work done by Neville and Beamish to estimate residence period
and distribution. Oceanographic Conditions Fraser River sockeye experience a
wide range of oceanographic conditions along their juvenile outmigration. The
majority of juvenile salmon exit the Strait of Georgia through the Discovery
Islands / Johnstone Strait into Queen Charlotte Sound. Oceanographic conditions
differ substantially across these regions, affecting plankton productivity and
hence food availability for the juvenile fish. The Strait of Georgia basin and
Queen Charlotte Sound are typically stratified and exhibit high primary
production during the spring / summer months (Jackson et al., 2015). Conversely,
the Discovery Islands / Johnstone Strait region is subject to high tidal mixing
which is expected to reduce primary production through light limitation,
concomitantly supporting lower zooplankton (juvenile salmon prey) biomass
(McKinnell et al., 2014). Predicted poor feeding conditions in the Discovery
Islands / Johnstone Strait make this region a potential choke point for juvenile
salmon that may determine their capacity to survive changes in productivity in
the Strait of Georgia and / or Queen Charlotte Sound. This concept was recently
formalised as the “Trophic Gauntlet Hypothesis” by McKinnell et al. (2014).
Although this hypothesis is as yet untested, in part due to a lack of
oceanographic / prey data for the Discovery Islands / Johnstone Strait region,
growth hormone (IGF1) data do indicate poor juvenile salmon growth in this
region (Ferriss et al., 2014). Similarly, smolts that took longer to migrate
from the northern Strait of Georgia to Queen Charlotte Sound had lower survival
rates compared to those fish which moved quickly through the region (Furey et
al. 2015).”

Spring plankton blooms are occurring earlier as climate changes (Chittenden et
al. 2010). Phytoplankton bloom timing is variable in the Strait of Georgia and
can occur anytime from late February to April (Allen and Latornell 2015).
Drivers of phytoplankton bloom timing include light availability, mixing of
phytoplankton over depth from strong winds (increased mixing means less growth
of phytoplankton) and fresh-water run-off (Allen and Latornell 2015). As a
result there may be a mismatch between peak zooplankton prey production and
arrival of juvenile salmon entering the marine environment. Smolt to adult
survival has been found to be 1.5 - 3 times higher in hatchery coho salmon (O.
kisutch) that were released to coincide with high marine productivity
(Chittenden et al. 2010). Regional oceanographic conditions are subject to
anthropogenic impacts (e.g., pollution), climate cycles (e.g., ENSO, PDO) and
long term climate change. Through changing light and nutrient availability,
anthropogenic and physical forcing (e.g., wind, cloud cover, freshet timing,
spring warming) can cause variations in the timing of plankton blooms (Allen and
Wolfe, 2013), the subsequent biomass accumulation (Jackson et al., 2015), and
the quality of that biomass as food for juvenile salmon (El-Sabaawi et al.,
2009).

## Fish Growth and Health Growth 

Elaborate on critical size critical period
hypothesis… ie Beamish and Mahnken 2001.

Growth rates in the early marine phase of migrating sockeye have been shown to
influence marine survival rates (Farley et al. 2011). Concordantly, abundance of
Harrison River sockeye in the Strait of Georgia in September, after being
subject to biooceanographic conditions in the Strait for several months, was
found to be the best predictor of subsequent escapement (Beamish et al. 2016).
This suggests that conditions in the Strait of Georgia and the first months at
sea are important in determining brood year survival.”
Multiple factors are expected to impact juvenile salmon survival during the
early marine phase, with food availability for growth considered to be the
leading contender followed by pathogen and parasite infection (Cohen, 2012b;
Peterman et al., 2010). Strong correlative evidence supports the role of feeding
conditions in salmon stock fluctuations (Beamish et al., 2012; Thomson et al.,
2012), yet few studies have examined plankton prey quality and quantity and
explicitly linked this to the growth and condition of fish. Condition Speak to
fulton’s condition factor and elaborate on ideas from paper from Chesapeake bay

## Parasites and Pathogens

An additional area of uncertainty and research priority
is the role of pathogens and parasites in the survival of salmon during their
early marine phase (Cohen, 2012a; Cohen, 2012b; Cohen, 2012c). The Discovery
Islands / Johnstone Strait host the majority of British Columbia’s salmon farms.
Since this region is the primary migration route for wild Fraser River salmon
there is the potential for pathogens and parasites to be transmitted between
wild and farmed fish (Cohen, 2012b; Cohen, 2012c). Parasites and pathogens can
be a source of significant mortality in wild salmon (Miller et al., 2014) and
can cause catastrophic losses in salmon aquaculture (Mennerat et al., 2010).
However, our current understanding of infectious disease dynamics in wild and
farmed fish, and their interactions, are limited. There are a large number of
pathogens that naturally infect wild Pacific salmon (Miller et al., 2014), and
the domesticated environments in aquaculture may change the population dynamics
and phenotypic traits of pathogens in ways that may threaten both wild and
farmed salmon (Mennerat et al., 2010). Thus, understanding the ecology and
evolution of pathogens in this context is essential for the sustainable
management of both wild and farmed salmon in British Columbia.
Pathogens and parasites may have both direct (lethal) and indirect (sub-lethal)
effects. In addition to having the potential to cause direct mortality,
pathogens can compromise the ability of salmon to grow (Sandell et al., 2015),
compete for food (Godwin et al., 2015), and avoid predators (Krkošek et al.,
2011; Mesa et al., 1998). Because these indirect effects can reduce foraging
success they would be expected, if occurring, to amplify the projected poor
feeding conditions in the Discovery Islands / Johnstone Strait. This highlights
the importance of understanding infection dynamics in addition to feeding
conditions in the region. Infection dynamics are expected to depend on exposure
to pathogens outside of the region, as well as a combination of wild fish
migration paths, residence time in the vicinity of farmed fish net pens, and
factors influencing transmission, such as the persistence of pathogens and
parasites in the water column (Miller et al., 2014).


  __Beamish, R. J., Pearsall, I. a, & Healey, M. C. (2003). A history of the research on the early Marine life of Pacific salmon off Canada’s Pacific coast. NPAFC Bulletin, 3(3), 1–40.__

To read:
Groot and Cooke 1987
Brett 1965
Hart 1980
Johnson and Groot 1963
Groot 1972
Foerester 1968
Hartt 1980
Dell 1986

“Levings and Kotyk (1983) carried out two trawling surveys for juvenile sal- monids (chum, pink, coho, chinook and steelhead) in Discovery Passage and nearby channels in the north- ern Strait of Georgia. This was part of a sampling program established to examine the dispersal of wild chinook fry and juvenile marked chinook from re- lease experiments at Quinsam hatchery into the Campbell River (Fig. 1) estuary.”

“Beamish, R. J., Pearsall, I. a, & Healey, M. C. (2003). A history of the research on the early marine life of Pacific salmon off Canada’s Pacific coast. NPAFC Bulletin, 3(3), 1–40.”

“Upon leaving the Fraser River estuary, most smolts proceed along the mainland coast north- ward but some are flushed west across the Strait of Georgia by the Fraser River plume and tidal currents towards the Gulf Islands. Once among the Gulf Is- lands, these smolts turn north and migrate diagonally back across the Strait to join up with the smolts that have moved directly north from the river mouth (Groot and Cooke 1987). Groot”

__Brodeur, R. D., Myers, K. W., & Helle, J. H. (2003). Research conducted by the United States on the early ocean life history of Pacific salmon. North Pacific Anadromous Fish Commission Bulletin Number 3, (3), 89–131.__

To read:
Brodeur and Pearcy (1986)
Pearcy and FIsher 1990
Straty 1974 
Looks like a good one
Farley et al. (1999, 2000a, 2001a, c)

# Analysis Notebook

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(hakaisalmon)
library(tidyverse)
library(lubridate)
library(ggridges)
library(here)
theme_set(theme_gray(base_size = 14))
```

## Migration Dynamics {.tabset}

### Migration Timing and Abundance

We decided that plotting CPUE is not possinle without bias, due to our method of targetting surface activity, sampling different sites every year which have inherently different catchabilities, and due to changes in protocol over the first 3 years of sampling.

```{r MT averaged by week}
# Note: This figure is deprecated and is no longer used as method of estimating migration timing and abundance

cpue <-  select(survey_seines, survey_date, sampling_week, site_id, region, so_total, collection_protocol, survey_type, set_type) %>%
  # Basically our unit of effort is when we set the net. Some sites have poor catchability for our seine. We used surface activity as an indicator for catchability of the site, as well as for a proxy for abundance. If no surface activity was observed, then no set was conducted. If no set was conducted, it's because there were either no fish present, or the catchability of fish was low. 
  # Only include sites that have been consistently fished over the last few years. This is necessary because our survey effort at other sites was inconsistent. Also we learned that after June, the southern sites in the Discovery Islands stratified and became too warm for fish to be at the surface.
  filter(collection_protocol == "SEMSP", survey_type == "standard",
         set_type == "targeted", site_id %in% c("D07", "D09", "D22", "D27",
                                                "D10", "D08", "D34", "D20",
                                                "J03", "J02", "J09", "J11")) %>%
  mutate(year = year(survey_date)) %>%
  select(-site_id, -survey_date, - collection_protocol, -survey_type, -set_type) %>% 
  # Drop any instances where so_total is NA. There should be very few instances when there was an NA for sockeye.
  drop_na() %>% 
  group_by(year, region, sampling_week) %>% 
  summarise_each(funs(mean, sd, cpue.se=sd(.) / sqrt(n())))

cpue$year <- as.factor(cpue$year)
labels <- c(DI = "Discovery Islands", JS = "Johnstone Strait")
cpue$sampling_week <- as_factor(cpue$sampling_week)
dodge <- position_dodge(width=0.5)
  
cpue_plot_error_bars <- ggplot(data = cpue, aes(x = sampling_week, y = mean,
                                     colour = year, group = year)) +
  geom_errorbar(aes(ymin = mean - cpue.se, ymax = mean + cpue.se),
  position = position_dodge(width = 0.15),
  width = 0.3) +
  facet_wrap(~ region, nrow = 2, scales = "free_y",
             labeller = labeller(region = labels)) +
  geom_line(size = 1.5) +
  geom_point(size = 2, position = position_dodge(width = 0.15)) +
  xlab("Date") +
  ylab("Sockeye CPUE") +
  theme(legend.justification = c(1, 0), legend.position = c(.83, .67)) +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))


cpue_plot_error_bars
ggsave(here::here("Time Series", "Time-series-manuscript", "figs", "cpue_plot_error_bars.png"), width = 6, height = 4)
```

### Migration Timing and Rate

In an effort to paramaterize migration timing I assign a peak abundance date in each region by averaging the date of capture for the 218,242 fish that we have caught, and plot the mean and standard deviations according to a normal distriubtion. This plot then estimates migration timing, but not abundance as the height of the distribution is infuenced by the standard deviation, and not abundance.

```{r MT averaged by date}

tidy_catch <- survey_seines %>%
  # remove ad-hoc collections from migration timing calcs
  filter(survey_type == "standard", collection_protocol == "SEMSP", set_type == "targeted") %>% 
  filter(site_id %in% c("D07", "D09", "D22", "D27", "D10", "D08", "D34",
                        "D20", "J03", "J02", "J09", "J11")) %>%
  select(survey_date, seine_id, region, so_total, pi_total, cu_total, co_total, he_total, lat, lon) %>% 
  # filter out instances when sockeye were not caught because in 2015 we only enumerated sets that had sockeye in them, and moving forward we plan on enumerating all sets. If we included sets that had zero sockeye in 2017 and 2018 then our CPUE of sockeye in 2015 and 2016 would be biased high. Therefore this abundance metrics are strictly based on seines which had sockeye and we are then measuring how many of each species are in a seine, from seines with sockeye, as our metric of all species abundance and proportion. This is the only way to resolved inconsistent sampling strategies between years.
  filter(so_total > 0) %>% 
  mutate(year = year(survey_date)) %>% 
  # remove instances when there was not a complete enumeration of all species in the seine
  drop_na() %>% 
  gather(`so_total`, `pi_total`, `cu_total`, `co_total`, `he_total`, key = "species",
         value = "n") 

tidy_catch <- as.data.frame(tidy_catch)
# make the unit of observation one fish, based on total catch numbers in seine_data
catch_expanded <- tidy_catch[rep(row.names(tidy_catch), tidy_catch$n), 1:7] %>% 
  mutate(yday = yday(survey_date), year = year(survey_date)) 

# Create one row for every sockeye ever caught based on a summary by seines
tidy_so_catch <- tidy_catch %>% 
  filter(species == "so_total")
  
so_catch_expanded <- tidy_so_catch[rep(row.names(tidy_so_catch), tidy_so_catch$n), 1:7] %>% 
  mutate(yday = yday(survey_date), year = year(survey_date)) 

# Calculate mean and standard deviation of the julian date of every fish caught
so_mt <- so_catch_expanded %>% 
  group_by(year, region) %>% 
             summarize(avg_date = mean(yday),
                       sd = round(sd(yday),0))

# extract mean and sd
di_mean_date_2015 <- as.numeric(so_mt[1,3])
di_sd_2015 <- as.numeric(so_mt[1,4])
js_mean_date_2015 <- as.numeric(so_mt[2,3])
js_sd_2015 <- as.numeric(so_mt[2,4])
di_mean_date_2016 <- as.numeric(so_mt[3,3])
di_sd_2016 <- as.numeric(so_mt[3,4])
js_mean_date_2016 <- as.numeric(so_mt[4,3])
js_sd_2016 <- as.numeric(so_mt[4,4])
di_mean_date_2017 <- as.numeric(so_mt[5,3])
di_sd_2017 <- as.numeric(so_mt[5,4])
js_mean_date_2017 <- as.numeric(so_mt[6,3])
js_sd_2017 <- as.numeric(so_mt[6,4])

date_range <- tibble(dates = c(121:182))

# Generate a normal distriubtion by random sampling a random normal distruvution based on annual mean capture date and sd
di_sim_set <- tibble("2015" = rnorm(1000000, di_mean_date_2015, di_sd_2015),
                      "2016" = rnorm(1000000, di_mean_date_2016, di_sd_2016),
                      "2017" = rnorm(1000000, di_mean_date_2017, di_sd_2017),
                     "region" = "DI") %>% 
  gather(`2015`, `2016`, `2017`, key = "year", value = "yday")

js_sim_set <- tibble("2015" = rnorm(1000000, js_mean_date_2015, js_sd_2015),
                      "2016" = rnorm(1000000, js_mean_date_2016, js_sd_2016),
                      "2017" = rnorm(1000000, js_mean_date_2017, js_sd_2017),
                     "region" = "JS") %>% 
  gather(`2015`, `2016`, `2017`, key = "year", value = "yday")

sim_set <- rbind(di_sim_set,js_sim_set)
labels <- c(DI = "Discovery Islands", JS = "Johnstone Strait")
cdat <- sim_set %>% 
  group_by(region, year) %>% 
  summarise(mean = mean(yday, na.rm = TRUE))


(ggplot(sim_set, aes(x = yday, y = region, fill = region)) +
         geom_density_ridges(alpha = 0.6)+
  facet_grid(year ~ .) +
  scale_x_continuous(breaks=c(121, 151, 182),
                      labels=c("May 1", "June 1", "July 1")) +
    coord_cartesian(xlim =  115:195) +
  ylab("Sockeye Abundance (Kernel Density)") +
  xlab("Date") +
  geom_vline(data=cdat, aes(xintercept=mean, colour = year),
               linetype="dashed", size=1) +
  theme_gray(base_size = 14) +
  theme(legend.position="none"))

ggsave(here::here("Time Series", "Time-series-manuscript","figs", "ndist_migration_date.png"), width = 6, height = 4)


# TODO rm() all the outputs created from this chunk
# TODO plot anual average?


diff <- c(so_mt[2,3] - so_mt[1,3], so_mt[4,3] - so_mt[3,3], so_mt[6,3] - so_mt[5,3])
years <- c(2015, 2016, 2017)

annual_peak_diff <- tibble(years, mean = round(as.numeric(diff),1))

(average_time <- mean(annual_peak_diff$mean))

```

```{r density histo}

(histo <- so_catch_expanded %>% 
  ggplot(aes(yday, fill = region)) +
  geom_histogram(binwidth = 7) +
  facet_grid(region ~ year) +
  scale_x_continuous(breaks = c(135, 152, 166, 182, 196), 
                     labels = c("May 15", "June 1", "June 15", "July 1", "July 15")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) + 
  theme(legend.position="none")+
  xlab("Count") +
  ylab("Date"))
```

```{r migration distance and rate}
avg_loc <- catch_expanded %>% 
  group_by(region) %>% 
  summarise(avg_lat = mean(lat), avg_lon = mean(lon))

# I plotted a path between these two lat lons in google earth and got the following measurement

m_travelled <- 113980

m_per_day <- 113980 / average_time
km_per_day <- m_per_day / 1000

# calculate average body lengths in mm
mean_so_fl <- as.numeric(survey_seines_fish %>% 
  filter(species == "SO") %>% 
  summarise(mean_so_fl = mean (fork_length, na.rm = T)))

#Change body length units to meters
mean_so_fl <- mean_so_fl / 1000

body_lengths_distance <- m_travelled / mean_so_fl

# calculate body lengths per second
avg_seconds <- 60*60*24*6.1

body_lengths_per_sec <- as.numeric(body_lengths_distance / avg_seconds)
```


```{r cum abund migration date}
#####

so_cum_abund_di_2015 <- catch_expanded %>% 
  filter(year == "2015", species == "so_total", region == "DI") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, region, yday) %>% 
  summarise(n = n()) %>%
  mutate(percent = cumsum(n / sum(n))*100) %>% 
  ungroup() %>% 
  transmute(year = year, survey_date = yday, region = region, percent = percent, so.cum.abund = cumsum(n))  



coefs <- coef(lm(logit(so_cum_abund_di_2015$percent/100) ~ so_cum_abund_di_2015$survey_date, date = so_cum_abund_di_2015))
coefs
phi2 <- coefs[1]
phi3 <- coefs[2]

wilson <- nls(so_cum_abund_di_2015$percent ~ phi1/(1+exp(-(phi2+phi3*so_cum_abund_di_2015$survey_date))),
              start = list(phi1 = 100, phi2 = phi2, phi3=phi3), data=so_cum_abund_di_2015, trace = TRUE)
summary(wilson)

min <- min(so_cum_abund_di_2015$survey_date)
max <- max(so_cum_abund_di_2015$survey_date)

#set parameters
phi1<-100
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(seq(min, to = max, by = 1)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted abundance

predict_DI_2015 <-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
predict_DI_2015 <- predict_DI_2015 %>% 
  mutate(region = "DI", year = "2015")

#####

so_cum_abund_js_2015 <- catch_expanded %>% 
  filter(year == "2015", species == "so_total", region == "JS") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, region, yday) %>% 
  summarise(n = n()) %>%
  mutate(percent = cumsum(n / sum(n))*100) %>% 
  ungroup() %>% 
  transmute(year = year, survey_date = yday, region = region, percent = percent, so.cum.abund = cumsum(n)) 


coefs <- coef(lm(logit(so_cum_abund_js_2015$percent/100) ~ so_cum_abund_js_2015$survey_date, date = so_cum_abund_js_2015))
coefs
phi2 <- coefs[1]
phi3 <- coefs[2]

wilson <- nls(so_cum_abund_js_2015$percent ~ phi1/(1+exp(-(phi2+phi3*so_cum_abund_js_2015$survey_date))),
              start = list(phi1 = 100, phi2 = phi2, phi3=phi3), data=so_cum_abund_js_2015, trace = TRUE)
summary(wilson)

min <- min(so_cum_abund_js_2015$survey_date)
max <- max(so_cum_abund_js_2015$survey_date)

#set parameters
phi1<-100
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(seq(min, to = max, by = 1)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted abundance

predict_JS_2015 <-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
predict_JS_2015 <- predict_JS_2015 %>% 
  mutate(region = "JS", year = "2015")

#####

so_cum_abund_di_2016 <- catch_expanded %>% 
  filter(year == "2016", species == "so_total", region == "DI") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, region, yday) %>% 
  summarise(n = n()) %>%
  mutate(percent = cumsum(n / sum(n))*100) %>% 
  ungroup() %>% 
  transmute(year = year, survey_date = yday, region = region, percent = percent, so.cum.abund = cumsum(n)) 


coefs <- coef(lm(logit(so_cum_abund_di_2016$percent/100) ~ so_cum_abund_di_2016$survey_date, date = so_cum_abund_di_2016))
coefs
phi2 <- coefs[1]
phi3 <- coefs[2]

wilson <- nls(so_cum_abund_di_2016$percent ~ phi1/(1+exp(-(phi2+phi3*so_cum_abund_di_2016$survey_date))),
              start = list(phi1 = 100, phi2 = phi2, phi3=phi3), data=so_cum_abund_di_2016, trace = TRUE)
summary(wilson)

min <- min(so_cum_abund_di_2016$survey_date)
max <- max(so_cum_abund_di_2016$survey_date)

#set parameters
phi1<-100
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(seq(min, to = max, by = 1)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted abundance

predict_DI_2016 <-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
predict_DI_2016 <- predict_DI_2016 %>% 
  mutate(region = "DI", year = "2016")

#####

so_cum_abund_js_2016 <- catch_expanded %>% 
  filter(year == "2016", species == "so_total", region == "JS") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, region, yday) %>%  
  summarise(n = n()) %>%
  mutate(percent = cumsum(n / sum(n))*100) %>% 
  ungroup() %>% 
  transmute(year = year,survey_date = yday, region = region, percent = percent, so.cum.abund = cumsum(n)) 


coefs <- coef(lm(logit(so_cum_abund_js_2016$percent/100) ~ so_cum_abund_js_2016$survey_date, date = so_cum_abund_js_2016))
coefs
phi2 <- coefs[1]
phi3 <- coefs[2]

wilson <- nls(so_cum_abund_js_2016$percent ~ phi1/(1+exp(-(phi2+phi3*so_cum_abund_js_2016$survey_date))),
              start = list(phi1 = 100, phi2 = phi2, phi3=phi3), data=so_cum_abund_js_2016, trace = TRUE)
summary(wilson)

min <- min(so_cum_abund_js_2016$survey_date)
max <- max(so_cum_abund_js_2016$survey_date)

#set parameters
phi1<-100
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(seq(min, to = max, by = 1)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted abundance

predict_JS_2016 <-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
predict_JS_2016 <- predict_JS_2016 %>% 
  mutate(region = "JS", year = "2016")

#####

so_cum_abund_di_2017 <- catch_expanded %>% 
  filter(year == "2017", species == "so_total", region == "DI") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, region, yday) %>% 
  summarise(n = n()) %>%
  mutate(percent = cumsum(n / sum(n))*100) %>% 
  ungroup() %>% 
  transmute(year = year, survey_date = yday, region = region, percent = percent, so.cum.abund = cumsum(n)) 


coefs <- coef(lm(logit(so_cum_abund_di_2017$percent/100) ~ so_cum_abund_di_2017$survey_date, date = so_cum_abund_di_2017))
coefs
phi2 <- coefs[1]
phi3 <- coefs[2]

wilson <- nls(so_cum_abund_di_2017$percent ~ phi1/(1+exp(-(phi2+phi3*so_cum_abund_di_2017$survey_date))),
              start = list(phi1 = 100, phi2 = phi2, phi3=phi3), data=so_cum_abund_di_2017, trace = TRUE)
summary(wilson)

min <- min(so_cum_abund_di_2017$survey_date)
max <- max(so_cum_abund_di_2017$survey_date)

#set parameters
phi1<-100
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(seq(min, to = max, by = 1)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted abundance

predict_DI_2017 <-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
predict_DI_2017 <- predict_DI_2017 %>% 
  mutate(region = "DI", year = "2017")

#####

so_cum_abund_js_2017 <- catch_expanded %>% 
  filter(year == "2017", species == "so_total", region == "JS") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, region, yday) %>% 
  summarise(n = n()) %>%
  mutate(percent = cumsum(n / sum(n))*100) %>% 
  ungroup() %>% 
  transmute(year = year, survey_date = yday, region = region, percent = percent, so.cum.abund = cumsum(n))


coefs <- coef(lm(logit(so_cum_abund_js_2017$percent/100) ~ so_cum_abund_js_2017$survey_date, date = so_cum_abund_js_2017))
coefs
phi2 <- coefs[1]
phi3 <- coefs[2]

wilson <- nls(so_cum_abund_js_2017$percent ~ phi1/(1+exp(-(phi2+phi3*so_cum_abund_js_2017$survey_date))),
              start = list(phi1 = 100, phi2 = phi2, phi3=phi3), data=so_cum_abund_js_2017, trace = TRUE)
summary(wilson)

min <- min(so_cum_abund_js_2017$survey_date)
max <- max(so_cum_abund_js_2017$survey_date)

#set parameters
phi1<-100
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(seq(min, to = max, by = 1)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted abundance

predict_JS_2017 <-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
predict_JS_2017 <- predict_JS_2017 %>% 
  mutate(region = "JS", year = "2017")


prediction <- rbind(predict_DI_2015, predict_JS_2015, predict_DI_2016, predict_JS_2016,
      predict_DI_2017, predict_JS_2017) %>% 
  dplyr::rename(survey_date = x)

actual <- rbind(so_cum_abund_di_2015, so_cum_abund_di_2016, so_cum_abund_di_2017,
                so_cum_abund_js_2015, so_cum_abund_js_2016, so_cum_abund_js_2017)

prediction$year <- as.numeric(prediction$year)
prediction <- left_join(prediction, actual, by )

ggplot(data=prediction,aes(x = survey_date, y = y, group = region, shape = region))+
  labs(x='Date', y='% of total catch')+
  #geom_point(size=1)+
  #scale_x_continuous(breaks=c(0,250,500,750, 1000,1250))+
  #scale_y_continuous(breaks=c(0,10,20,30,40,50,60,70,80))+
  geom_line(aes(linetype=region)) +
  geom_point(aes(x = survey_date, y = percent)) +
  facet_grid(year~.) +
  scale_x_continuous(breaks = c(135, 152, 166, 182, 196), 
                     labels = c("May 15", "June 1", "June 15", "July 1", "July 15")) 
  


```

### Migration Abundance

To assess the abundance of each species I plot the average CPUE 

```{r Abundance}

# Migration abundance is based on the average abundance from seines that have complete enumeration of all species from in the seine, and seines with > 0 sockeye because tidy_catch was created using drop_na() so that if a row had NA for any species totals then it was dropped. This relieves the concern that CPUE would be based on only the instances when sockeye were caught because in 2015 and to a lesser extent in 2016 we only enumerated the catch if sockeye were present. What we did was went back in to 2015 and 2016 data and looked at how many seines were conducted for a given survey. If there were multiple seines conducted, but no species composition recorded then we assumed that the catch of sockeye was zero for those sets because the protocol was to only retain and enumerate sets which had sockeye. We ccould not assume howver, that the catch of other species was zero because there may have been pink and chum which simply were not retained. The abundance figures created below are based on the instances when sockeye were caught.  
annual_cpue <- tidy_catch %>% 
  group_by(year, region, species) %>% 
  summarize(mean = mean(n, na.rm = TRUE))

annual_cpue$species <- as_factor(annual_cpue$species) 
annual_cpue$species <- fct_relevel(annual_cpue$species, "so_total", "cu_total", "pi_total", "co_total", "he_total")

ggplot(annual_cpue, aes(x = species, y = mean, fill = species)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  ylab("Mean Abundance") +
  xlab("Species") +
  scale_x_discrete(breaks=c("so_total","cu_total","pi_total","co_total", "he_total"),
                          labels=c("sockeye", "chum", "pink", "herring", "coho")) +
  facet_grid(region~year) +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))

ggsave(here::here("Time Series", "Time-series-manuscript", "figs", "annual_abundance.png"), width = 6, height = 4)
```

### Species Composition

Here I average the proportion each species contributed to the annual species composition. This is based only on instances when the net was set. 
```{r}
proportions <- catch_expanded %>%
  group_by(year, region, species) %>%
  summarize(n = n()) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

ggplot(data = proportions, aes(x = year, y = proportion, fill = species)) +
      geom_bar(stat="identity", position = 'stack') +
      scale_fill_discrete(name = "Species",
                          breaks=c("so_total","cu_total","pi_total","co_total", "he_total"),
                          labels=c("sockeye", "chum", "pink", "herring", "coho")) + 
  xlab("Year") +
  ylab("Proportion") +
  facet_wrap(~region)

ggsave(here::here("Time Series", "Time-series-manuscript", "figs", "annual_proportion.png"), width = 6, height = 4)
           
```

# Heat Map

It would be good to produce one plot to rule them all, one plot to bind them... anyways you get the point. I want one plot that summarizes annual parameters. 

As a starting point these parameters should include:

* CPUE
* Peak migration date
* Length
* Motile sealice abundance
* SST Temp
* Sea-Surface salinity
* Zooplankton biomass
* Chl a
* Nutrients
* Phyto
```{r}
```


