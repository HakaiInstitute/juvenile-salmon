---
title: "Notebook - Hakai Institute Juvenile Salmon Program Time Series"
author: "Brett Johnson"
date: "February 5, 2018"
output: 
  html_document:
    theme: "sandstone"
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
---

This is my lab notebook for ideas, literature review, and exploratory data analysis related to the preparation of a manuscript for reporting yearly time series data of the Hakai Institute Juvenile Salmon Program.

# Objectives
The objectives of this manuscript are to:

* Introduce the Juvenile Salmon Program
* Describe briefly the methods related to field program 
* Present time series of data
* Point to papers that present deeper analysis of time series data

# Key Parameters Reported

## Fish Metrics
* Salmon CPUE
* Spp. composition. Plot per week, per migration corridor
* Stock specific relative condition factor
* Lengths
* Weights
* Parasite loads

## Oceanography
* Chl a - Justin sorting out phaepigments...
* Phyto Biomass
* Nutrients - Depending on when they are analyzed 
* Zoop biomass	
* Temp CTD binning
* Salinity CTD binning

Overlap with other current analyses include
* Salish Sea Marine Survival Project: Run-timing, GSI, CPUE, Relative Condition, Lengths, Weights
* In-season reports: Sea lice, temp, chl a

New analysis (No overlap)

* Salinity, Nutrients, Zoop biomass, Phyto biomass. (Kang has these time series)

# Literature Review
## Migration dynamics 
Stock specific run timing and migration routes add a layer of
complexity to understanding salmon early marine survival. Run timing interacts
with plankton bloom timing and can be critical to the feeding conditions
experienced by juvenile salmon. Migration routes and rates determine the extent
to which specific populations interact with feeding hotspots / barrens as well
as potential sources of pathogen transmission (e.g., sympatric wild host fishes
and / or aquaculture facilities). As such, knowledge of stock specific migration
behavior within the Discovery Islands is critical to inform stock specific risk
assessment.

Put into context work done by Neville and Beamish to estimate residence period
and distribution. Oceanographic Conditions Fraser River sockeye experience a
wide range of oceanographic conditions along their juvenile outmigration. The
majority of juvenile salmon exit the Strait of Georgia through the Discovery
Islands / Johnstone Strait into Queen Charlotte Sound. Oceanographic conditions
differ substantially across these regions, affecting plankton productivity and
hence food availability for the juvenile fish. The Strait of Georgia basin and
Queen Charlotte Sound are typically stratified and exhibit high primary
production during the spring / summer months (Jackson et al., 2015). Conversely,
the Discovery Islands / Johnstone Strait region is subject to high tidal mixing
which is expected to reduce primary production through light limitation,
concomitantly supporting lower zooplankton (juvenile salmon prey) biomass
(McKinnell et al., 2014). Predicted poor feeding conditions in the Discovery
Islands / Johnstone Strait make this region a potential choke point for juvenile
salmon that may determine their capacity to survive changes in productivity in
the Strait of Georgia and / or Queen Charlotte Sound. This concept was recently
formalised as the “Trophic Gauntlet Hypothesis” by McKinnell et al. (2014).
Although this hypothesis is as yet untested, in part due to a lack of
oceanographic / prey data for the Discovery Islands / Johnstone Strait region,
growth hormone (IGF1) data do indicate poor juvenile salmon growth in this
region (Ferriss et al., 2014). Similarly, smolts that took longer to migrate
from the northern Strait of Georgia to Queen Charlotte Sound had lower survival
rates compared to those fish which moved quickly through the region (Furey et
al. 2015).”

Spring plankton blooms are occurring earlier as climate changes (Chittenden et
al. 2010). Phytoplankton bloom timing is variable in the Strait of Georgia and
can occur anytime from late February to April (Allen and Latornell 2015).
Drivers of phytoplankton bloom timing include light availability, mixing of
phytoplankton over depth from strong winds (increased mixing means less growth
of phytoplankton) and fresh-water run-off (Allen and Latornell 2015). As a
result there may be a mismatch between peak zooplankton prey production and
arrival of juvenile salmon entering the marine environment. Smolt to adult
survival has been found to be 1.5 - 3 times higher in hatchery coho salmon (O.
kisutch) that were released to coincide with high marine productivity
(Chittenden et al. 2010). Regional oceanographic conditions are subject to
anthropogenic impacts (e.g., pollution), climate cycles (e.g., ENSO, PDO) and
long term climate change. Through changing light and nutrient availability,
anthropogenic and physical forcing (e.g., wind, cloud cover, freshet timing,
spring warming) can cause variations in the timing of plankton blooms (Allen and
Wolfe, 2013), the subsequent biomass accumulation (Jackson et al., 2015), and
the quality of that biomass as food for juvenile salmon (El-Sabaawi et al.,
2009).

## Fish Growth and Health Growth 

Elaborate on critical size critical period
hypothesis… ie Beamish and Mahnken 2001.

Growth rates in the early marine phase of migrating sockeye have been shown to
influence marine survival rates (Farley et al. 2011). Concordantly, abundance of
Harrison River sockeye in the Strait of Georgia in September, after being
subject to biooceanographic conditions in the Strait for several months, was
found to be the best predictor of subsequent escapement (Beamish et al. 2016).
This suggests that conditions in the Strait of Georgia and the first months at
sea are important in determining brood year survival.”
Multiple factors are expected to impact juvenile salmon survival during the
early marine phase, with food availability for growth considered to be the
leading contender followed by pathogen and parasite infection (Cohen, 2012b;
Peterman et al., 2010). Strong correlative evidence supports the role of feeding
conditions in salmon stock fluctuations (Beamish et al., 2012; Thomson et al.,
2012), yet few studies have examined plankton prey quality and quantity and
explicitly linked this to the growth and condition of fish. Condition Speak to
fulton’s condition factor and elaborate on ideas from paper from Chesapeake bay

## Parasites and Pathogens

An additional area of uncertainty and research priority
is the role of pathogens and parasites in the survival of salmon during their
early marine phase (Cohen, 2012a; Cohen, 2012b; Cohen, 2012c). The Discovery
Islands / Johnstone Strait host the majority of British Columbia’s salmon farms.
Since this region is the primary migration route for wild Fraser River salmon
there is the potential for pathogens and parasites to be transmitted between
wild and farmed fish (Cohen, 2012b; Cohen, 2012c). Parasites and pathogens can
be a source of significant mortality in wild salmon (Miller et al., 2014) and
can cause catastrophic losses in salmon aquaculture (Mennerat et al., 2010).
However, our current understanding of infectious disease dynamics in wild and
farmed fish, and their interactions, are limited. There are a large number of
pathogens that naturally infect wild Pacific salmon (Miller et al., 2014), and
the domesticated environments in aquaculture may change the population dynamics
and phenotypic traits of pathogens in ways that may threaten both wild and
farmed salmon (Mennerat et al., 2010). Thus, understanding the ecology and
evolution of pathogens in this context is essential for the sustainable
management of both wild and farmed salmon in British Columbia.
Pathogens and parasites may have both direct (lethal) and indirect (sub-lethal)
effects. In addition to having the potential to cause direct mortality,
pathogens can compromise the ability of salmon to grow (Sandell et al., 2015),
compete for food (Godwin et al., 2015), and avoid predators (Krkošek et al.,
2011; Mesa et al., 1998). Because these indirect effects can reduce foraging
success they would be expected, if occurring, to amplify the projected poor
feeding conditions in the Discovery Islands / Johnstone Strait. This highlights
the importance of understanding infection dynamics in addition to feeding
conditions in the region. Infection dynamics are expected to depend on exposure
to pathogens outside of the region, as well as a combination of wild fish
migration paths, residence time in the vicinity of farmed fish net pens, and
factors influencing transmission, such as the persistence of pathogens and
parasites in the water column (Miller et al., 2014).


  __Beamish, R. J., Pearsall, I. a, & Healey, M. C. (2003). A history of the research on the early Marine life of Pacific salmon off Canada’s Pacific coast. NPAFC Bulletin, 3(3), 1–40.__

To read:
Groot and Cooke 1987
Brett 1965
Hart 1980
Johnson and Groot 1963
Groot 1972
Foerester 1968
Hartt 1980
Dell 1986

“Levings and Kotyk (1983) carried out two trawling surveys for juvenile sal- monids (chum, pink, coho, chinook and steelhead) in Discovery Passage and nearby channels in the north- ern Strait of Georgia. This was part of a sampling program established to examine the dispersal of wild chinook fry and juvenile marked chinook from re- lease experiments at Quinsam hatchery into the Campbell River (Fig. 1) estuary.”

“Beamish, R. J., Pearsall, I. a, & Healey, M. C. (2003). A history of the research on the early marine life of Pacific salmon off Canada’s Pacific coast. NPAFC Bulletin, 3(3), 1–40.”

“Upon leaving the Fraser River estuary, most smolts proceed along the mainland coast north- ward but some are flushed west across the Strait of Georgia by the Fraser River plume and tidal currents towards the Gulf Islands. Once among the Gulf Is- lands, these smolts turn north and migrate diagonally back across the Strait to join up with the smolts that have moved directly north from the river mouth (Groot and Cooke 1987). Groot”

__Brodeur, R. D., Myers, K. W., & Helle, J. H. (2003). Research conducted by the United States on the early ocean life history of Pacific salmon. North Pacific Anadromous Fish Commission Bulletin Number 3, (3), 89–131.__

To read:
Brodeur and Pearcy (1986)
Pearcy and FIsher 1990
Straty 1974 
Looks like a good one
Farley et al. (1999, 2000a, 2001a, c)

# Analysis Notebook

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(hakaisalmon)
library(tidyverse)
library(lubridate)
library(ggridges)
library(here)
theme_set(theme_gray(base_size = 14))
```

## Migration Dynamics {.tabset}

### Migration Timing and Abundance

First I plot a point and line graph(+/- 1 SE) of the catch of fish averaged over 1 week. For surveys where the net was not set because no fish were observed, I converted those catches to zero from NA. So in effect the unit of effort for this CPUE calculation is a survey in which we look for fish. The following plot therefore aims to summarize timing and abundance in the same plot.

```{r MT averaged by week}
cpue <-  select(survey_seines, survey_date, sampling_week, site_id, region, so_total) %>%
   # Only include sites that have been consistently fished over the last few years. This is necessary because our survey effort at other sites was inconsistent.
  filter(site_id %in% c("D07", "D09", "D22", "D27", "D10", "D08", "D34",
                        "D20", "J03", "J02", "J09", "J11")) %>%
  mutate(year = year(survey_date)) %>%
  select(-site_id, -survey_date) %>% 
  # Replace surveys that have NA for sockeye, ie. when the net wasn't set from a survey, assume zero fish present
  replace_na(list(so_total = 0)) %>% 
  group_by(year, region, sampling_week) %>% 
  summarise_each(funs(mean, sd, cpue.se=sd(.) / sqrt(n())))
  

cpue$year <- as.factor(cpue$year)
labels <- c(DI = "Discovery Islands", JS = "Johnstone Strait")
cpue$sampling_week <- as_factor(cpue$sampling_week)
dodge <- position_dodge(width=0.5)
  
cpue_plot_error_bars <- ggplot(data = cpue, aes(x = sampling_week, y = mean,
                                     colour = year, group = year)) +
  geom_errorbar(aes(ymin = mean - cpue.se, ymax = mean + cpue.se),
  position = position_dodge(width = 0.15),
  width = 0.3) +
  facet_wrap(~ region, nrow = 2, scales = "free_y",
             labeller = labeller(region = labels)) +
  geom_line(size = 1.5) +
  geom_point(size = 2, position = position_dodge(width = 0.15)) +
  xlab("Date") +
  ylab("Sockeye CPUE") +
  theme(legend.justification = c(1, 0), legend.position = c(.83, .67)) +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))


cpue_plot_error_bars
ggsave(here::here("Time Series", "Time-series-manuscript", "figs", "cpue_plot_error_bars.png"), width = 6, height = 4)
```

### Migration Timing and Rate

In an effort to paramaterize migration timing I assign a peak abundance date in each region by averaging the date of capture for the 218,242 fish that we have caught, and plot the mean and standard deviations according to a normal distriubtion. This plot then estimates migration timing, but not abundance as the height of the distribution is infuenced by the standard deviation, and not abundance.

```{r MT averaged by date}

tidy_catch <- survey_seines %>%
  # remove ad-hoc collections from migration timing calcs
  filter(survey_type == "standard") %>% 
  select(survey_date, seine_id, region, so_total, pi_total, cu_total, co_total, he_total) %>% 
  mutate(year = year(survey_date)) %>% 
  # remove instances when the net was not set because no surface activity was observed
  drop_na() %>% 
  gather(`so_total`, `pi_total`, `cu_total`, `co_total`, `he_total`, key = "species",
         value = "n") 

tidy_catch <- as.data.frame(tidy_catch)

# Create one row for every fish ever caught based on a summary by seines
catch_expanded <- tidy_catch[rep(row.names(tidy_catch), tidy_catch$n), 1:5] %>% 
  mutate(yday = yday(survey_date), year = year(survey_date)) 

# Calculare mean and standard deviation of the julian date of every fish caught
so_mt <- catch_expanded %>% 
  filter(species == "so_total") %>% 
  group_by(year, region) %>% 
             summarize(avg_date = mean(yday),
                       sd = round(sd(yday),0))

# extract mean and sd
di_mean_date_2015 <- as.numeric(so_mt[1,3])
di_sd_2015 <- as.numeric(so_mt[1,4])
js_mean_date_2015 <- as.numeric(so_mt[2,3])
js_sd_2015 <- as.numeric(so_mt[2,4])
di_mean_date_2016 <- as.numeric(so_mt[3,3])
di_sd_2016 <- as.numeric(so_mt[3,4])
js_mean_date_2016 <- as.numeric(so_mt[4,3])
js_sd_2016 <- as.numeric(so_mt[4,4])
di_mean_date_2017 <- as.numeric(so_mt[5,3])
di_sd_2017 <- as.numeric(so_mt[5,4])
js_mean_date_2017 <- as.numeric(so_mt[6,3])
js_sd_2017 <- as.numeric(so_mt[6,4])

date_range <- tibble(dates = c(121:182))

# Generate a normal distriubtion by random sampling a random normal distruvution based on annual mean capture date and sd
di_sim_set <- tibble("2015" = rnorm(1000000, di_mean_date_2015, di_sd_2015),
                      "2016" = rnorm(1000000, di_mean_date_2016, di_sd_2016),
                      "2017" = rnorm(1000000, di_mean_date_2017, di_sd_2017),
                     "region" = "DI") %>% 
  gather(`2015`, `2016`, `2017`, key = "year", value = "yday")

js_sim_set <- tibble("2015" = rnorm(1000000, js_mean_date_2015, js_sd_2015),
                      "2016" = rnorm(1000000, js_mean_date_2016, js_sd_2016),
                      "2017" = rnorm(1000000, js_mean_date_2017, js_sd_2017),
                     "region" = "JS") %>% 
  gather(`2015`, `2016`, `2017`, key = "year", value = "yday")

sim_set <- rbind(di_sim_set,js_sim_set)
labels <- c(DI = "Discovery Islands", JS = "Johnstone Strait")
cdat <- sim_set %>% 
  group_by(region, year) %>% 
  summarise(mean = mean(yday, na.rm = TRUE))


(ggplot(sim_set, aes(x = yday, y = region, fill = region)) +
         geom_density_ridges(alpha = 0.6)+
  facet_grid(year ~ .) +
  scale_x_continuous(breaks=c(121, 151, 182),
                      labels=c("May 1", "June 1", "July 1")) +
  ylab("Region") +
  xlab("Date") +
  geom_vline(data=cdat, aes(xintercept=mean, colour = year),
               linetype="dashed", size=1) +
  theme_gray(base_size = 14) +
  theme(legend.position="none"))
ggsave(here::here("Time Series", "Time-series-manuscript","figs", "ndist_migration_date.png"), width = 6, height = 4)


# TODO format plot with axis breaks that are dates, and adjsut the side label,
# to make it a top label.
# TODO rm() all the outputs created from this chunk
# TODO plot anual average?


diff <- c(so_mt[2,3] - so_mt[1,3], so_mt[4,3] - so_mt[3,3], so_mt[6,3] - so_mt[5,3])
years <- c(2015, 2016, 2017)

annual_peak_diff <- tibble(years, mean = round(as.numeric(diff),1))

(average_time <- mean(annual_peak_diff$mean))

```


```{r parabla migration rate}
parabola <-  select(survey_seines, survey_date, sampling_week, site_id, region, so_total) %>%
   # Only include sites that have been consistently fished over the last few years. This is necessary because our survey effort at other sites was inconsistent.
  filter(site_id %in% c("D07", "D09", "D22", "D27", "D10", "D08", "D34",
                        "D20", "J03", "J02", "J09", "J11")) %>%
  mutate(year = year(survey_date)) %>%
  select(-site_id) %>% 
  # Replace surveys that have NA for sockeye, ie. when the net wasn't set from a survey, assume zero fish present
  replace_na(list(so_total = 0)) %>% 
  group_by(year, region, survey_date) %>% 
  summarise_each(funs(mean, sd, cpue.se=sd(.) / sqrt(n())))

ggplot(parabola, aes(x = survey_date, y = log(so_total_mean))) +
         geom_point() +
  facet_wrap(region~year, scales = "free_x") +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1)
```

### Migration Abundance

To assess the abundance of each species I plot the average CPUE 

```{r CPUE}

annual_cpue <- tidy_catch %>% 
  group_by(year, region, species) %>% 
  summarize(mean = mean(n, na.rm = TRUE))

annual_cpue$species <- as_factor(annual_cpue$species) 
annual_cpue$species <- fct_relevel(annual_cpue$species, "so_total", "cu_total", "pi_total", "co_total", "he_total")



ggplot(annual_cpue, aes(x = species, y = mean, fill = species)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  ylab("Mean CPUE") +
  xlab("Year") +
  scale_x_discrete(breaks=c("so_total","cu_total","pi_total","co_total", "he_total"),
                          labels=c("sockeye", "chum", "pink", "herring", "coho")) +
  facet_grid(region~year) +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))

ggsave(here::here("Time Series", "Time-series-manuscript", "figs", "annual_abundance.png"), width = 6, height = 4)
```

### Species Composition

Here I average the proportion each species contributed to the annual species composition. This is based only on instances when the net was set. 
```{r}
proportions <- catch_expanded %>%
  group_by(year, region, species) %>%
  summarize(n = n()) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

ggplot(data = proportions, aes(x = year, y = proportion, fill = species)) +
      geom_bar(stat="identity", position = 'stack') +
      scale_fill_discrete(name = "Species",
                          breaks=c("so_total","cu_total","pi_total","co_total", "he_total"),
                          labels=c("sockeye", "chum", "pink", "herring", "coho")) + 
  xlab("Year") +
  ylab("Proportion") +
  facet_wrap(~region)

ggsave(here::here("Time Series", "Time-series-manuscript", "figs", "annual_proportion.png"), width = 6, height = 4)
           
```

# Heat Map

It would be good to produce one plot to rule them all, one plot to bind them... anyways you get the point. I want one plot that summarizes annual parameters. 

As a starting point these parameters should include:

* CPUE
* Peak migration date
* Length
* Motile sealice abundance
* SST Temp
* Sea-Surface salinity
* Zooplankton biomass
* Chl a
* Nutrients
* Phyto
```{r}
```


