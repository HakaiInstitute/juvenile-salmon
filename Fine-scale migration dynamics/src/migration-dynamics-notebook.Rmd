---
title: "Fine Scale Migration Dynamics"
author: "Brett Johnson"
date: "February 5, 2018"
output: 
  bookdown::html_document2:
    theme: "sandstone"
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
---
---
Draft Title: Fine scale migration dynamics of juvenile salmon

Focus on fine scale spatial distribution of outmigrating sockeye, pink and chum salmon, including:
* Size structure
* Stock composition
* Migration timing?
* Detailed descriptions of net design and operation.  
* Measurement process - make sure that these are aligned!

Data needs:
* DFO lat and longs

Lit Review:

__Gerbrandt, N., Sc, B., & Routledge, R. (2013). Early Marine Distribution of Out-Migrating Juvenile Sockeye Salmon ( Oncorhynchus nerka ). M.Sc. Thesis, Simon Fraser University.__

Most sockeye swim within 2 m of surface
Bigger fish enter more saline water
Systems that enter directly into highly saline waters have higher proportion of 2 year olds.
Populations migrating through systems with no surface freshwater layer actually swam deeper than populations with a fresh surface water layer.
Surface salinity and day of year were significant predictors of fork length
Beamish, R. J., Pearsall, I. a, & Healey, M. C. (2003). A history of the research on the early marine life of Pacific salmon off Canada’s Pacific coast. NPAFC Bulletin, 3(3), 1–40.

__Brodeur, R. D., Myers, K. W., & Helle, J. H. (2003). Research conducted by the United States on the early ocean life history of Pacific salmon. North Pacific Anadromous Fish Commission Bulletin Number 3, (3), 89–131.__

To read:
Straty 1974: Looks like a good one
Farley et al. (1999, 2000a, 2001a, c)
Straty and Jaenicke 1980
Straty 1981

"Historical marking studies indicate some separa-
tion in major stocks of juvenile Bristol Bay sockeye salmon as far seaward as Port Moller (Straty 1974). Differences that may contribute to stock-specific dis- tributions include time of out migration, travel dis- tance from the lake system of origin, age, and size."
  - This is more related to once they reach open ocean. 
  __Farley, E. V, Murphy, J. M., Wing, B. W., Moss, J. H., & Middleton, A. (2005). Distribution , Migration Pathways , and Size of Western Alaska Juvenile Salmon Along the Eastern Bering Sea Shelf. Alaska Fishery Research Bulletin, 11(1), 15–26.__
  
This paper used a GAM with distance from shore, distance from river mouth, and Julian date to understand what was affecting fork length
To read:
Hartt and Dell 1986; 
Isakson et al. 1986; 
Straty 1974

For pink, chum, chinook, and sockeye.
"In general, length of juvenile salmon increased with the distance from freshwater rearing locations (Figures 4a–e; 5a–c). The length of juvenile age-1.0 and -2.0 sockeye salmon increased with distance from river mouth and displayed a bell shaped curve offshore from the southern shoreline of the SBS region, with the largest fish distributed within middle Bristol Bay and the smallest fish along the southern and northern shorelines (Figures 4a and b)."
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(hakaisalmon)
library(here)
library(tidyverse)
library(ggridges)
library(lubridate)
library(knitr)
library(broom)
library(wesanderson)
library(vegan)
library(car)
mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
  condition <- eval(substitute(condition), .data, envir)
  .data[condition, ] <- .data[condition, ] %>% mutate(...)
  .data
}
spp_labels <- c(CU = "Chum", PI = "Pink", SO = "Sockeye", DI = "Discovery Islands", 
                JS = "Johnstone Strait")
collapse_fraser_sockeye_stocks_neville_pdf <- function(x) {
 as.factor(x) %>% 
    forcats::fct_collapse(x,
      Early_Stuart = c("Driftwood", "Narrows", "Dust", "Bivouac", "Rossette",
                       "Sinta", "Porter_Cr", "Forfar", "Blackwater", "Gluskie", 
                       "Paula", "Felix", "Kynock", "Hudson_Bay", "Sandpoint",
                       "FiveMile", "early stuart"),
      Chilliwack = c("Chilliw_lake", "DollyVarden_Cr"),
      Pitt = c("Pitt"),
      Nadina_Gates_Bowron_Nahatlatch = c("Nadina", "Gates_Cr", "Bowron",
                                                "Nahatlatch"),
      Early_Thompson = c("Seymour", "Scotch", "Eagle", "U_Adams", "Cayenne",
                         "Fennell", "early thompson"),
      Harrison_Widgeon = c("Harrison", "WidgeonSlough"),
      Late_Stuart_Stellako = c("Middle", "Pinchi_Cr", "Tachie", "Stellako",
                               "Kuzkwa_Cr", "late stuart"),
      Chilko = c("Chilko", "Chilko-North", "Chilko_south"),
      Quesnel = c("L_Horsefly", "U_Horsefly", "Horsefly", "McKinley", 
                  "Mitchell", "Wasko_Cr", "Blue_Lead_Ck", "Quesnel_Decept",
                  "Quesnel_Horsef", "Quesnel_Mitche", "Roaring", "quesnel", "Quesnel"),
      Raft_North_Thompson = c("Raft", "Thompson_N"),
      Birkenhead_Big_Silver = c("Birkenhead", "Big_Silver"),
      Late_Shuswap_Portage = c("Eagle_L", "Little", "L_Shuswap", "MiddleShuswap",
                               "L_Adams", "Portage_Cr", "late shuswap", "shuswap"),
      Weaver_Cultus = c("Weaver", "Cultus_Lake")
    )
}

life_aquatic_cont <- wes_palette("Zissou1", 100, type = "continuous")
life_aquatic_discrete <- wes_palette("Zissou1", 5, type = "discrete")

theme <- theme_bw(base_size = 14)
theme_set(theme)
# read in dfo data that Chrys Neville provided that I tidied up first in excel
dfo_data <- read_csv(here::here("Fine-scale migration dynamics", "data","dfo_data.csv"))

dfo_data <- dfo_data %>% 
  add_column(ufn = "ufn", .before = "org") %>% 
  select(-prob_1) %>% 
  mutate(collapsed_fraser_stocks = collapse_fraser_sockeye_stocks_neville_pdf(stock_1)) %>% 
  # Filter out sits that arent from the same DFO sampling station
  filter(!year_tow %in% c("2016_109", "2015_78", "2016_34", "2015_5", "2015_73",
                          "2015_9", "2015_37", "2015_20", "2016-106"))

# create a table of hakai data from the same site that I want to compare to
# dfo.
hakai_okisollo <- survey_seines_fish_stock_id %>% 
  filter(site_id == "D09") %>%
  # filter out sites that overlaps with DFO, or is very far from shore
  filter(!seine_id %in% c("DN390", "DN391", "DN401", "DN251", "DN336")) %>% 
  select(survey_date, site_id, lat, lon, species, fork_length, weight, stock_1,
         ufn) %>% 
  add_column(org = "hakai", .after = "ufn") %>% 
  add_column(DNA = NA, .after = "weight") %>% 
  add_column(year_tow = NA, .before = "survey_date") %>% 
  mutate(collapsed_fraser_stocks = collapse_fraser_sockeye_stocks_neville_pdf(stock_1)) 

okisollo <- rbind(hakai_okisollo, dfo_data) %>%
  # categorize sampling events into categorical week and recod the categories so
  # that the middle of the week is the label
  mutate(sampling_week = as.numeric((yday(survey_date) + 4) %/% 7)) %>%
  mutate(
  sampling_week = recode_factor(sampling_week,
  `18` = "May 5",
  `19` = "May 12" ,
  `20` = "May 19",
  `21` = "May 26",
  `22` = "June 2",
  `23` = "June 9",
  `24` = "June 16",
  `25` = "June 23",
  `26` = "June 30",
  `27` = "July 6",
  `28` = "July 13"
  )
  ) %>% 
  mutate(k = 10^5*(weight / fork_length ^ 3)) %>% 
  mutate(year = year(survey_date)) %>% 
  #Looks like dfo data has errors in it with a fork_length of 9 and 18
  filter(fork_length > 20)


```

# GSI 

## Stock Proportions {.tabset}

### Annual proportion
One of the first things I want to do is simply look at the stock ID proportions
across the whole year for both organizations to see very grossly if there are
obvious differences. 

It becomes clear that DFO caught a greater proportion of chilko (0.370) compared to Hakai (0.165). Also, DFO caught 20 % Stellako while Hakai caught a very low proportion.

```{r 2015 annual gsi, fig.cap= "Genetic stock proportions of all stocks of sockeye captured in 2015 in Okisollo channel"}

gsi_okisollo <- okisollo %>%
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  group_by(year, org, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(proportion) %>% 
  #filter(proportion > 0.01) %>% 
  filter(collapsed_fraser_stocks %in% c('Late_Shuswap_Portage', 'Chilko',
                                        'Quesnel', 'Early_Thompson', 'Late_Stuart_Stellako'))



ggplot(gsi_okisollo, aes(x = fct_reorder(collapsed_fraser_stocks, proportion), y = proportion, fill = org)) +
  geom_bar(stat="identity", position = position_dodge()) + 
  ggtitle("Genetic Stock Proportions") +
  facet_wrap(~year) +
  xlab("") + 
  ylab("Proportion") +
  scale_fill_discrete(name = "Habitat") +
  coord_flip() +
  theme(legend.position="bottom") + 
  scale_fill_discrete(name  ="Habitat",
                            breaks=c("DFO", "hakai"),
                            labels=c("Mid-channel", "Nearshore"))


ggsave(here::here("Fine-scale migration dynamics", "figs", "annual_gsi.png"), width = 9, height = 6)

# Non-stacked bar graph


#TODO: update figure lables and include N
#TODO: filter hakai prob_1 to > 0.6

```

```{r 2015 weekly gsi}
gsi_weekly_okisollo <- okisollo %>%
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  group_by(year, org, sampling_week, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(org)

  
ggplot(gsi_weekly_okisollo, aes(x = org, y = proportion, fill = collapsed_fraser_stocks)) +
  geom_bar(colour="black", stat="identity", position = 'stack') + 
  ggtitle("Genetic Stock Proportions") +
  facet_grid(year ~ sampling_week) +
  xlab("Habitat") + 
  scale_x_discrete(breaks=c("DFO", "hakai"),
                      labels=c("Mid-channel", "Nearshore"))+
  ylab("Proportion") +
  scale_fill_discrete(name = "Genetic Stock")

ggsave(here::here("Fine-scale migration dynamics", "figs", "weekly_gsi.png"), width = 15, height = 6)

```

```{r gsi prop by seine}
by_seine_okisollo_gsi <- okisollo %>% 
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  filter(year(survey_date) != 2016) %>% 
  group_by(org, survey_date, site_id, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  mutate(set = paste(org,"_", survey_date,"_", site_id)) %>% 
  ungroup()

#spread stocks for analysis in vegan
by_seine_okisollo_gsi_for_vegan <- by_seine_okisollo_gsi %>% 
  select(set, collapsed_fraser_stocks, proportion) %>% 
  spread(key = collapsed_fraser_stocks, proportion, fill = 0) %>% 
  separate(set, into = c("org", "survey_date", "site_id"), sep = "_", remove = FALSE) %>% 
  select(-site_id)

write_csv(by_seine_okisollo_gsi_for_vegan, here::here("Fine-scale migration dynamics", "data", "stock_props_for_NMDS.csv"))

row_names <- c(paste("dfo", 1:15, sep = ""), paste("hakai", 16:33, sep = ""))
row.names(by_seine_okisollo_gsi_for_vegan) <- row_names

by_seine_okisollo_gsi_for_vegan <- by_seine_okisollo_gsi_for_vegan %>% 
  select(-set, -survey_date, -org)

test_nmds <- metaMDS(by_seine_okisollo_gsi_for_vegan, k = 2)
stressplot(test_nmds)


# Create treatment groups for hakai and dfo seines to visually group
treat=c(rep("dfo",15),rep("hakai", 18))
# First, create a vector of color values corresponding of the 
# same length as the vector of treatment values
colors=c(rep("red",15),rep("blue",18))
ordiplot(test_nmds,type="n")
#Plot convex hulls with colors baesd on organization
for(i in unique(treat)) {
  ordiellipse(test_nmds$point[grep(i,treat),],draw="polygon",
   groups=treat[treat==i],col=colors[grep(i,treat)],label=F) } 
orditorp(test_nmds,display="sites",col=c(rep("red",15),
  rep("blue",18)),air=0.01,cex=1.)
```

### Additional stock ID

Something that is important is to try to increase the sample size of hakai 
fish identified from a few key seines that dfo conducted on the same day.

To do that I calculate the number of fish that are currently compared, and 
identify where we have additional un-dissected fish.


```{r addtional possible stock_ids}
dfo_so <- dfo_data %>% 
  filter(species == "SO")

hakai_so <- left_join(survey_seines_fish_stock_id, package_data) %>% 
  filter(site_id == "D09", species == "SO") %>% 
  select(survey_date, site_id, species, fork_length, weight, stock_1,
         prob_1, ufn, semsp_id, package_id) %>% 
  mutate(org = "hakai")

hakai_same_date <- semi_join(hakai_so, dfo_so, by = "survey_date") %>% 
  filter(is.na(prob_1)) # removes fish that have already been stock ID'd 

# summarize how many fish DFO have stock ID'd per sampling event
dfo_same_date <- semi_join(dfo_so, hakai_same_date, by = "survey_date") %>% 
  filter(stock_1 != "NA") %>% 
  group_by(survey_date) %>% 
  summarize(n = n())

hakai_same_date_summary <- hakai_same_date %>% 
  group_by(survey_date) %>% 
  summarise(n_hakai = n())

dates_worth_comparing <- full_join(dfo_same_date, hakai_same_date_summary, 
                                   by = "survey_date") %>% 
  drop_na(n) %>% 
  mutate(diff = n - n_hakai) %>% 
  filter(diff > 0)

dates_worth_comparing <- as.Date(dates_worth_comparing$survey_date)

additional_2015_hakai_fish <- hakai_same_date %>% 
  filter(survey_date %in% dates_worth_comparing) %>% 
  left_join(package_data, additional_2015_hakai_fish, by = "package_id") %>% 
  select(survey_date, site_id, species, semsp_id) %>% 
  mutate(date_site = paste(survey_date, "-", site_id)) %>% 
  distinct(date_site)

print(additional_2015_hakai_fish)
write_csv(additional_2015_hakai_fish, here::here("Fine-scale migration dynamics",
                                                 "data", "additional_2015_hakai_fish.csv"))

rm(dfo_same_date, hakai_same_date, dates_worth_comparing, dfo_so, hakai_so, hakai_same_date_summary)
```

Based on the seines that DFO has done stock IDs, there is opportunity to stock ID an additional `r nrow(additional_2015_hakai_fish)` fish from the Hakai collection, although none of these fish have actually been dissected.

If analyzing additional DFO fish is an option, then I should redo the above analysis.

Also I should consider how important it is to compare the proportion of stocks observed by organization on the same date. If I only summarize proportions by the entire sampling season then it is not neccessary.

### Stock Proportions Chi Square Test

I need to develop a method to paramaterize the difference in proportions
of stocks sampled. The simplest way to do this would be to summarize the stock proportions caught over the entire year. However, because we often sampled at different times of the season, ie our temporal distribution is
dissimilar, an integration of stock proportions caught would likely show a difference in proportions caught but would be influenced mainly by the temporal distribution of sampling. Therefore, I want to compare proportions of stocks caught by both groups on the same day in the best case. This is sort of like a repeated measure, except from one week to the next I expect very different stock proportions. I therefore need to do  multiple proportion tests and parameterize the difference of each seine, and then average that parameter from every comparison I make. 

I will try to do this fitst by calculating stock proportion over the whole year, with a chi square test. This should serve as a test case that I expect to show that these fish were sampled from different populations.

First, I need to convert proportions to integers by multiplying them by 100.
```{r proportions test}
#TODO: re-work this whole section
# First, test proportion over the whole year
gsi_okisollo_2015_dfo <- okisollo %>%
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "",
         year == 2015, org == "DFO") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  group_by(collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  mutate(dfo_prop_count = as.integer(proportion * 100)) %>% 
  select(collapsed_fraser_stocks, dfo_prop_count)

gsi_okisollo_2015_hakai <- okisollo %>%
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "",
         year == 2015, org == "hakai") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  group_by(collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  mutate(hakai_prop_count = as.integer(proportion * 100)) %>% 
  select(collapsed_fraser_stocks, hakai_prop_count)

both_gsi <- left_join(gsi_okisollo_2015_dfo, gsi_okisollo_2015_hakai, by = "collapsed_fraser_stocks") %>% 
  add_row(collapsed_fraser_stocks =  "other", dfo_prop_count = 2, hakai_prop_count = 4) %>% 
  filter(!collapsed_fraser_stocks %in% c("Pitt", "Raft_North_Thompson", "Weaver_Cultus"))


chisq.test(both_gsi$dfo_prop_count, both_gsi$hakai_prop_count)

```

According to the chi square test for the entire seasons proportions, the two methods of sampling are not independent. Given that I really didn't expect this result, and given that when I plot the proportions annually it is clear that they are quite different, I'm not sure that a chi square test is the appropriate statistical test to use.

### Stock Proportions by Week

```{r plot proportions by week}
comp_dates <- semi_join(dfo_data, hakai_okisollo, by = "survey_date") %>% 
  filter(species == "SO", collapsed_fraser_stocks != "NA") %>% 
  group_by(survey_date) %>% 
  summarize(n = n())

comparable_dates <- as.list(comp_dates$survey_date)

okisollo %>% 
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  filter(survey_date %in% comparable_dates, collapsed_fraser_stocks != "x") %>% 
  group_by(org, survey_date, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(org) %>% 
  ggplot(aes(x = org, y = proportion, fill = collapsed_fraser_stocks, label = n)) +
    geom_bar(colour="black", stat="identity", position = 'stack') +
   geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  facet_wrap(~ survey_date) + 
  scale_x_discrete(breaks=c("DFO", "hakai"),
                      labels=c("Deep", "Shallow"))+
  xlab("Habitat") +
  ylab("Proportion")+ theme(legend.position="none")

#TODO: Label stocks on bar plots
#TODO: sort out 2016 dfo stock cateegorizations

ggsave(here::here("Fine-scale migration dynamics", "figs", "gsi_props_by_week.png"))
```

# Lengths 

## All species lengths

```{r}
okisollo %>%  
  group_by(year, org, species) %>% 
  summarize(n = n()) %>% 
  kable()

okisollo %>% 
  filter(species != "CO", fork_length < 200) %>% 
  ggplot() +
  geom_density_ridges(aes(x = fork_length, y = org)) +
  facet_wrap(year ~ species, nrow = 2)
  
ggsave(here::here("Fine-scale migration dynamics", "figs", "annual_fork_lengths.png"))
dfo_so_lengths <- okisollo %>%  
  filter(species == "SO")
```


## All sockeye stock lengths

```{r late shuswap portage}
# lsp: late shuswap portage
lsp_2015 <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Late_Shuswap_Portage", year == 2015) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  select(org, fork_length) 

t.test(fork_length ~ org, data = lsp_2015)

lsp_2016 <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Late_Shuswap_Portage", year == 2016) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  select(org, fork_length) 

t.test(fork_length ~ org, data = lsp_2016)
```


```{r Chilko}
# chilko
chilko_2015 <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Chilko", year == 2015) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  select(org, fork_length) 

t.test(fork_length ~ org, data = chilko_2015)

chilko_2016 <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Chilko", year == 2016) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  select(org, fork_length) 

t.test(fork_length ~ org, data = chilko_2016)
```

```{r Quesnel}
# Quesnel: 
Quesnel_2015 <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Quesnel", year == 2015) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  select(org, fork_length) 

t.test(fork_length ~ org, data = Quesnel_2015)

Quesnel_2016 <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Quesnel", year == 2016) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  select(org, fork_length) 

t.test(fork_length ~ org, data = Quesnel_2016)
```

## Chilko lengths {.tabset}

### Sampling distributions

```{r sampling distributions}
okisollo %>%
  #filter(year == 2015) %>% 
  ggplot(aes(x = survey_date, y = org)) +
  geom_density_ridges() +
  facet_grid(~year, scales = "free") +
    ggtitle("DFO and Hakai temportal sampling distribution in 2015")

Chilko <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Chilko") %>% 
  #filter(year == 2015) %>% 
  mutate(stock_group = "Chilko")

other <- okisollo %>% 
  #filter(year == 2015) %>% 
  filter(collapsed_fraser_stocks != "Chilko") %>% 
  mutate(stock_group = "all_others")

chilko_and_other <- rbind(Chilko, other) %>% 
  # remove obvious 2 year old sockeye
  filter(fork_length < 175)

chilko_other_summary <- chilko_and_other %>% 
  group_by(year, org, stock_group, sampling_week) %>% 
  summarise(n=n())

# Plot samplind distribution to see if temporal sampling overlaps sufficiently
# to remove the bias incurred from increasing fork_length over the season. 
ggplot(chilko_and_other, aes(x = survey_date, fill = stock_group)) +
         geom_density(alpha = 0.5) +
  ggtitle("sampling distribution of stock groups") +
  facet_grid(org~year, scales = "free")

# Plot length distributions by week
ggplot(chilko_and_other, aes(x = fork_length, y = sampling_week, fill = stock_group)) +
  geom_density_ridges(alpha = 0.5) +
  ggtitle("Chilko Sockeye Length Distribution") +
  facet_grid(org~year)
```


### Chilko lengths amongst habitats

There is no significant trend in the difference between hakai and dfo chilko sockeye over time.

```{r diff in lengths of chilko between orgs}
chilko_lengths_hakai_dfo_2015 <- Chilko %>% 
  filter(year == "2015") %>% 
  group_by(org, sampling_week) %>% 
  summarise(mean_fl = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean_fl) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na() %>% 
  mutate(numeric_sampling_week = c(1,2,3,4,5,6,7))

ggplot(chilko_lengths_hakai_dfo_2015, aes(x = numeric_sampling_week, y = diff)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggtitle("Diff in lengths of chilko between hakai and dfo")

lm_dfo_hakai_chilko_2015 <- lm(diff ~ numeric_sampling_week, data = chilko_lengths_hakai_dfo_2015)
summary(lm_dfo_hakai_chilko_2015)

okisollo %>% 
  filter(species == "SO", year == "2015",
         collapsed_fraser_stocks == "Chilko") %>%
  mutate(year = year(survey_date)) %>% 
  ggplot(aes(x = fork_length, y = sampling_week, fill = org)) + 
  geom_density_ridges(alpha = 0.5) + 
  facet_wrap(~year)

okisollo %>% 
  filter(species == "SO", year == "2015", !sampling_week %in% c("July 13", "July 6", "May 19"),
         collapsed_fraser_stocks == "Chilko") %>%
  mutate(year = year(survey_date)) %>% 
  ggplot(aes(x = sampling_week , y = fork_length, fill = org)) + 
  geom_boxplot() +
  ggtitle("Chilko sockeye lengths in 2015") +
  scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))+
  ylab("Fork Length (mm)") +
  xlab("Week")

ggsave(here::here("Fine-scale migration dynamics", "figs", "chilko_lengths_weekly_boxplot.png"))
```

There is no significant difference in the lenth of chilko sockeye caught by DFO compared to length of chilko sockeye caught by hakai. 

```{r chilko fork length t-test by org}
dfo_chi_2015 <- as.numeric(chilko_lengths_hakai_dfo_2015$DFO)
hakai_chi_2015 <- as.numeric(chilko_lengths_hakai_dfo_2015$hakai)

t.test(dfo_chi_2015, hakai_chi_2015, paired = TRUE)
```


## Late Shuswap Portage Lengths

### 2016
Their is a significant trend in the difference of hakai and dfo shuswap stocks in 2016
```{r length trend 2016}
Late_Shuswap_Portage <- okisollo %>% 
  filter(year == "2016", collapsed_fraser_stocks == "Late_Shuswap_Portage")

shuswap_lengths_hakai_dfo_2016 <- Late_Shuswap_Portage %>% 
  filter(collapsed_fraser_stocks == "Late_Shuswap_Portage") %>% 
  filter(year == "2016") %>% 
  group_by(org, sampling_week) %>% 
  summarise(mean_fl = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean_fl) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na() %>% 
  mutate(numeric_sampling_week = c(1,2,3,4))

ggplot(shuswap_lengths_hakai_dfo_2016, aes(x = numeric_sampling_week, y = diff)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggtitle("Diff in lengths of shuswap between hakai and dfo")

lm_dfo_hakai_shuswap_2016 <- lm(diff ~ numeric_sampling_week, data = shuswap_lengths_hakai_dfo_2016)
summary(lm_dfo_hakai_shuswap_2016)

okisollo %>% 
  filter(species == "SO", year == "2016", !sampling_week %in% c("July 6", "May 19"),
         collapsed_fraser_stocks == "Late_Shuswap_Portage") %>%
  mutate(year = year(survey_date)) %>% 
  ggplot(aes(x = sampling_week , y = fork_length, fill = org)) + 
  geom_boxplot() +
  ggtitle("Late Shuswap and Portage sockeye lengths in 2016") +
  scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))+
  ylab("Fork Length (mm)") +
  xlab("Week")

ggsave(here::here("Fine-scale migration dynamics", "figs", "shuswap_weekly_lengths_boxplot_2016.png"))
```

No significant difference in the length of hakai and dfo shuswap sockeye in 2016
```{r shuswap fork length t-test by org}

dfo_shu_2016 <- as.numeric(shuswap_lengths_hakai_dfo_2016$DFO)
hakai_shu_2016 <- as.numeric(shuswap_lengths_hakai_dfo_2016$hakai)

t.test(dfo_shu_2016, hakai_shu_2016, paired =  TRUE)
```

### 2015



```{r length trend 2015}
Late_Shuswap_Portage <- okisollo %>% 
  filter(year == "2015", collapsed_fraser_stocks == "Late_Shuswap_Portage")

shuswap_lengths_hakai_dfo_2015 <- Late_Shuswap_Portage %>% 
  filter(collapsed_fraser_stocks == "Late_Shuswap_Portage") %>% 
  filter(year == "2015") %>% 
  group_by(org, sampling_week) %>% 
  summarise(mean_fl = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean_fl) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na() %>% 
  mutate(numeric_sampling_week = c(1,2,3,4))

ggplot(shuswap_lengths_hakai_dfo_2015, aes(x = numeric_sampling_week, y = diff)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggtitle("Diff in lengths of shuswap between hakai and dfo")

lm_dfo_hakai_shuswap_2015 <- lm(diff ~ numeric_sampling_week, data = shuswap_lengths_hakai_dfo_2015)
summary(lm_dfo_hakai_shuswap_2015)

okisollo %>% 
  filter(species == "SO", year == "2015", !sampling_week %in% c("July 6", "May 19"),
         collapsed_fraser_stocks == "Late_Shuswap_Portage") %>%
  mutate(year = year(survey_date)) %>% 
  ggplot(aes(x = sampling_week , y = fork_length, fill = org)) + 
  geom_boxplot() +
  ggtitle("Late Shuswap and Portage sockeye lengths in 2015") +
  scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))+
  ylab("Fork Length (mm)") +
  xlab("Week")

ggsave(here::here("Fine-scale migration dynamics", "figs", "shuswap_weekly_lengths_boxplot_2015.png"))
```

No significant difference in the length of hakai and dfo shuswap sockeye in 2015
```{r shuswap fork length t-test by org}

dfo_shu_2015 <- as.numeric(shuswap_lengths_hakai_dfo_2015$DFO)
hakai_shu_2015 <- as.numeric(shuswap_lengths_hakai_dfo_2015$hakai)

t.test(dfo_shu_2015, hakai_shu_2015, paired =  TRUE)
```

## Quesnel

```{r length trend 2015}
Quesnel <- okisollo %>% 
  filter(year == "2015", collapsed_fraser_stocks == "Quesnel")

Quesnel_lengths_hakai_dfo_2015 <- Quesnel %>% 
  filter(collapsed_fraser_stocks == "Quesnel") %>% 
  filter(year == "2015") %>% 
  group_by(org, date) %>% 
  summarise(mean_fl = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean_fl) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na() %>% 
  mutate(numeric_sampling_week = c(1,2,3))

ggplot(Quesnel_lengths_hakai_dfo_2015, aes(x = numeric_sampling_week, y = diff)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggtitle("Diff in lengths of Quesnel between hakai and dfo")

lm_dfo_hakai_Quesnel_2015 <- lm(diff ~ numeric_sampling_week, data = Quesnel_lengths_hakai_dfo_2015)
summary(lm_dfo_hakai_Quesnel_2015)

okisollo %>% 
  filter(species == "SO", year == "2015", !sampling_week %in% c("July 6", "May 19"),
         collapsed_fraser_stocks == "Quesnel") %>%
  mutate(year = year(survey_date)) %>% 
  ggplot(aes(x = sampling_week , y = fork_length, fill = org)) + 
  geom_boxplot() +
  ggtitle("Late Quesnel and Portage sockeye lengths in 2015") +
  scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))+
  ylab("Fork Length (mm)") +
  xlab("Week")

ggsave(here::here("Fine-scale migration dynamics", "figs", "Quesnel_weekly_lengths_boxplot_2015.png"))
```

No significant difference in the length of hakai and dfo Quesnel sockeye in 2015
```{r Quesnel fork length t-test by org}

dfo_Quesnel_2015 <- as.numeric(Quesnel_lengths_hakai_dfo_2015$DFO)
hakai_Quesnel_2015 <- as.numeric(Quesnel_lengths_hakai_dfo_2015$hakai)

t.test(dfo_Quesnel_2015, hakai_Quesnel_2015, paired =  TRUE)

```
 
## Sockeye, pink, chum length comparison {.tabset}

Here I compute the average fork length for each species by week and then calculate the difference in average lengths for each week. I then conduct a t-test on the averaged length for each week, for each species.
I do this in an attempt to standardize the sampling over time, because we know fish are growing longer over time, and having unequal temporal sampling distribution would skew the results.

### Sockeye
There is a significant trend of an increasing difference in lengths of Hakai and DFO sockeye over the 2015 season.
```{r sockeye averaged by week for 2015}

all_SO_by_week_by_org_2015 <- okisollo %>% 
  filter(year == "2015", species == "SO") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai)

all_SO_by_week_by_org_2015$numeric_sampling_week <- c(1,2,3,4,5,6,7,8,9,10)
ggplot(all_SO_by_week_by_org_2015, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm) +
  coord_cartesian(xlim = c(3, 10)) + 
  ylab("Length Difference (mm)") +
  xlab("Week") +
  scale_x_continuous(breaks=c(3, 4, 5, 6, 7, 8, 9, 10),
                      labels=c("2015-05-26", "2015-06-02", "2015-06-09", 
                               "2015-06-16", "2015-06-23", "2015-06-30",
                               "2015-07-06", "2015-07-13")) +
  ggtitle("2015")

ggsave(here::here("Fine-scale migration dynamics", "figs", "2015_sockeye_diff_trend.png"))

lm_hakai_dfo_sockeye <- lm(diff ~ numeric_sampling_week, data = all_SO_by_week_by_org_2015)
summary(lm_hakai_dfo_sockeye)
```

```{r}
(okisollo_2015_so_lengths <- okisollo %>% 
  filter(year == "2015") %>% 
  filter(fork_length < 300, species == "SO")  %>% 
  # filter out the first week of sampling which was likely two years olds, and filter out the last week of sampling which were ocean-type sockeye, also filter out adult sockeye that DFO caught
  filter(survey_date > "2015-05-15" & survey_date < "2015-07-12", fork_length < 180) %>% 
ggplot(aes(x = survey_date, y = fork_length, colour = species)) +
  geom_point() +
  geom_smooth(method = lm)+ 
  facet_grid(~org))

okisollo %>% 
  filter(species == "SO", year %in% c("2015", "2016"), sampling_week != "May 12",
         sampling_week != "July 13", sampling_week != "May 19" | year != "2015",
         sampling_week != "July 6" & sampling_week != "May 19" | year != "2016") %>% 
  ggplot(aes(x = sampling_week, y = fork_length, fill = org)) +
    geom_boxplot() +
    facet_grid(~year, scales = "free") +
    scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore")) +
  ylab("Fork Length (mm)") +
  xlab("Week")+
   theme(axis.text.x  = element_text(angle=45, vjust=0.5))

  
ggsave(here::here("Fine-scale migration dynamics", "figs", "sockeye_weekly_boxplot.png"), width = 8, height = 5)


```

There is a significant trend in the difference in lengths of sockeye captured by dfo and hakai in 2016.

```{r sockeye averaged by week for 2016}
all_SO_by_week_by_org_2016 <- okisollo %>% 
  filter(year == "2016", species == "SO") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai)

all_SO_by_week_by_org_2016$numeric_sampling_week <- c(1,2,3,4,5,6,7)

ggplot(all_SO_by_week_by_org_2016, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm) +
  coord_cartesian(xlim = c(2, 6)) + 
  ylab("Length Difference (mm)") +
  xlab("Week") +
  scale_x_continuous(breaks=c(2, 3, 4, 5, 6),
                      labels=c("2016-05-20", "2016-05-26", "2016-06-02", "2016-06-09", 
                               "2016-06-16")) +
  ggtitle("2016")

ggsave(here::here("Fine-scale migration dynamics", "figs", "2016_sockeye_diff_trend.png"))

lm_hakai_dfo_sockeye <- lm(diff ~ numeric_sampling_week, data = all_SO_by_week_by_org_2016)
summary(lm_hakai_dfo_sockeye)

(okisollo_2016_so_lengths <- okisollo %>% 
  filter(year == "2016") %>% 
  filter(fork_length < 300, species == "SO") %>% 
ggplot(aes(x = survey_date, y = fork_length, colour = species)) +
  geom_point() +
  geom_smooth(method = lm)+ 
  facet_grid(~org))+
  ggtitle("2016 chilko lengths")

```


```{r length trend all years}
all_SO_by_week_by_org_2015 <- all_SO_by_week_by_org_2015 %>% 
  mutate(year = 2015)

all_SO_by_week_by_org_2016 <- all_SO_by_week_by_org_2016 %>% 
  mutate(year = 2016) 

all_SO_by_week_by_org_2016$numeric_sampling_week <- c(2,3,4,5,6,7,8)

all_diff <- rbind(all_SO_by_week_by_org_2015, all_SO_by_week_by_org_2016) %>% 
  drop_na()



ggplot(all_diff, aes(numeric_sampling_week, diff)) +
  geom_point() +
  geom_smooth(method = lm)+
  facet_grid(~year) +
  ylab("Difference in Lengths (mm)")+
  xlab("Sampling Week") +
  ggtitle("Sockeye Length Differences") +
  theme_classic(base_size = 18)

ggsave(here::here("Fine-scale migration dynamics", "figs", "sockeye_length_trends.png"), width = 12)

```
DFO sockeye from 2015 are significantly longer than Hakai sockeye
```{r}
dfo_2015 <- as.numeric(all_SO_by_week_by_org_2015$DFO)
hakai_2015 <- as.numeric(all_SO_by_week_by_org_2015$hakai)

(SO_lengths_by_week_t_test <- tidy(t.test(dfo_2015, hakai_2015, paired = TRUE)) %>% 
    mutate(species = "SO"))

#TODO: prove to myself that the difference in lengths isn't due to unequal temporal sampling distributions
#TODO: try and understand whether size differences are due to dfo catching a higher proportion of 2 year olds
```

DFO sockeye were significantly longer in 2016 compared with hakai sockeye

```{r}
dfo_2016 <- as.numeric(all_SO_by_week_by_org_2016$DFO)
hakai_2016 <- as.numeric(all_SO_by_week_by_org_2016$hakai)

(SO_lengths_by_week_t_test <- tidy(t.test(dfo_2016, hakai_2016, paired = TRUE)) %>% 
    mutate(species = "SO"))
```


```{r Both years sockeye length}
dfo_all <- c(dfo_2015, dfo_2016)
hakai_all <- c(hakai_2015, hakai_2016)

t.test(dfo_all, hakai_all, paired = TRUE)

```

### Pink

There doesn't appear to be a trend in the difference of pink lengths over time
```{r pink averaged by week}
all_PI_by_week_by_org <- okisollo %>% 
  filter(year == 2015, species == "PI") %>% 
  # There was a dfo pink that was 480 mm caught which is not the same age class so I filter it out.
  filter(fork_length < 480) %>%
  group_by(org, sampling_week) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na()

all_PI_by_week_by_org$numeric_sampling_week <- c(1,2,3,4,5,6)

# I noticed the difference in means of chilko lengths compared to all other
# lengths seemed to increase over the season so I plotted the difference over
# time and it is an intersting trend that I can't explain.
ggplot(all_PI_by_week_by_org, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)

lm_dfo_hakai_pink <- lm(diff ~ numeric_sampling_week, data = all_PI_by_week_by_org)
summary(lm_dfo_hakai_pink)
```

DFO Pink are not statistically longer than Hakai pink, though the average DFO pink is longer than Hakai Pinks
```{r}
dfo <- as.numeric(all_PI_by_week_by_org$DFO)
hakai <- as.numeric(all_PI_by_week_by_org$hakai)

(PI_lengths_by_week_t_test <- tidy(t.test(dfo, hakai, paired = TRUE)) %>% 
    mutate(species = "PI"))

```

### Chum

There is no signnificant trend in the difference in chum over time in 2015.
```{r 2015 length trend}
all_CU_by_week_by_org_2015 <- okisollo %>% 
  filter(year == 2015, species == "CU") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na()

all_CU_by_week_by_org_2015$numeric_sampling_week <- c(1,2,3,4,5,6,7,8)
# I noticed the difference in means of chilko lengths compared to all other
# lengths seemed to increase over the season so I plotted the difference over
# time and it is an intersting trend that I can't explain.
ggplot(all_CU_by_week_by_org_2015, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm) +
  ylab("Length Difference mm (mid-channel - nearshore)") +
  xlab("Week") +
  scale_x_continuous(breaks=c(1,2,3, 4, 5, 6, 7, 8),
                      labels=c("2015-05-26", "2015-06-02", "2015-06-09", 
                               "2015-06-16", "2015-06-23", "2015-06-30", "2015-07-06", "2015-07-13")) +
  ggtitle("2015")

ggsave(here::here("Fine-scale migration dynamics", "figs", "chum_trend_2015.png"))

lm_hakai_dfo_chum_2015 <- lm(diff ~ numeric_sampling_week, data = all_CU_by_week_by_org_2015) 
summary(lm_hakai_dfo_chum_2015)
```

Chum caught by DFO were significantly longer than chum caught by Hakai in 2015
```{r 2015 lengths}
dfo_cu_2015 <- as.numeric(all_CU_by_week_by_org_2015$DFO)
hakai_cu_2015 <- as.numeric(all_CU_by_week_by_org_2015$hakai)


(CU_lengths_by_week_t_test <- tidy(t.test(dfo_2015, hakai_2015, paired = TRUE)) %>% 
    mutate(species = "CU"))
```

There is a significant trend in length difference of chum in 2016
```{r 2016 lengths trend}
all_CU_by_week_by_org_2016 <- okisollo %>% 
  filter(year == 2016, species == "CU") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na()

all_CU_by_week_by_org_2016$numeric_sampling_week <- c(1,2,3,4,5)
# I noticed the difference in means of chilko lengths compared to all other
# lengths seemed to increase over the season so I plotted the difference over
# time and it is an intersting trend that I can't explain.
ggplot(all_CU_by_week_by_org_2016, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm) +
  ylab("Length Difference mm (mid-channel - nearshore)") +
  xlab("Week") +
  scale_x_continuous(breaks=c(1,2,3, 4, 5),
                      labels=c("2016-05-26", "2016-06-02", 
                               "2016-06-16", "2016-06-23", "2015-07-06")) +
  ggtitle("2016")

ggsave(here::here("Fine-scale migration dynamics", "figs", "chum_trend_2016.png"))
lm_hakai_dfo_chum_2016 <- lm(diff ~ numeric_sampling_week, data = all_CU_by_week_by_org_2016) 
summary(lm_hakai_dfo_chum_2016)
```

There was not a significant difference in the length of Chum between hakai and DFO in 2016
```{r 2016 lengths}
dfo_cu_2016 <- as.numeric(all_CU_by_week_by_org_2016$DFO)
hakai_cu_2016 <- as.numeric(all_CU_by_week_by_org_2016$hakai)


(CU_lengths_by_week_t_test <- tidy(t.test(dfo_2016, hakai_2016, paired = TRUE)) %>% 
    mutate(species = "CU"))

rm(CU_lengths_by_week_t_test)
rm(PI_lengths_by_week_t_test)
rm(SO_lengths_by_week_t_test)  
rm(dfo)
rm(hakai)
rm(all_CU_by_week_by_org)
rm(all_PI_by_week_by_org)
rm(all_SO_by_week_by_org)
```

```{r both years length trend}
all_cu_diff <- okisollo %>% 
  filter(species == "CU") %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na()

all_cu_diff$numeric_sampling_week <- c(3,4,5,6,7,8,9,10,3,4,5,6,7)

ggplot(all_cu_diff, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm) +
  ylab("Length Difference (mm)") +
  xlab("Sampling Week") +
  #scale_x_continuous(breaks=c(1,2,3, 4, 5),
                  #    labels=c("2016-05-26", "2016-06-02", 
                        #       "2016-06-16", "2016-06-23", "2015-07-06")) +
  ggtitle("Chum Length Differences") +
  facet_grid(~year)

ggsave(here::here("Fine-scale migration dynamics", "figs", "chum_length_trend.png"), width = 12)
```

```{r both years paired t test}
dfo_cu_all <- c(dfo_cu_2016, dfo_cu_2015) 
hakai_cu_all <- c(hakai_cu_2016, hakai_cu_2015)

t.test(dfo_cu_all, hakai_cu_all, paired = TRUE)
```


```{r}
okisollo %>% 
  filter(species %in% c("CU","SO"), year %in% c("2015", "2016")) %>% 
  filter(sampling_week != "May 12" & sampling_week != "May 19") %>% 
  #        sampling_week != "July 13", sampling_week != "May 19" | year != "2015",
  #        sampling_week != "July 6" & sampling_week != "May 19" | year != "2016") %>% 
  ggplot(aes(x = sampling_week, y = fork_length, fill = org)) +
    geom_boxplot() +
    scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore")) +
  ylab("Fork Length (mm)") +
  xlab("Week")+
   theme(axis.text.x  = element_text(angle=45, vjust=.9, hjust = 1)) +
  facet_grid(year ~ species, labeller = labeller(species = spp_labels)) +
  theme(legend.position = "bottom")

  
ggsave(here::here("Fine-scale migration dynamics", "figs", "chum_and_sockeye_weekly_boxplot.png"), width = 8, height = 5)
```

### Species lengths annually by region

In this barplot I don't average lengths by week to make sure that temporal distribution is comparable. Instead I just plot the average for the whole season.

When simply plotting the length of each species, you can see that deep fish 
were  longer than shallow caught fish. This is just based on the annual average for each species. A potential confounder with this comparison is that the temporal sampling distribution was not equal, and we know that over the length of the season, fish get longer.

It's possible that I need to use a more complicated model to include the variation that is introduced by the time variable.

```{r barplot of all species lengths}
lengths <- okisollo %>% 
  filter(fork_length < 300, species %in% c("SO", "PI", "CU", "CO")) %>%
  mutate(year = year(survey_date)) %>% 
  filter(!(year == 2016 & species %in% c("PI", "CO"))) %>% 
  group_by(year,org, species) %>% 
  summarise(mean = mean(fork_length, na.rm = T),
            sd = sd(fork_length, na.rm = T), 
            n = n()) %>% 
  mutate(CI = 1.96 * (sd/sqrt(n)))

lengths %>% ggplot(aes(x = species, y = mean, fill = org)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_errorbar(position = position_dodge(.9), width = .25, aes(ymin = mean - CI, ymax = mean +
                        CI)) +
  ylab("Fork Length (mm)") +
  xlab("Species")+
  facet_grid(~year, scales = "free") +
  scale_x_discrete(breaks=c("CO", "CU", "PI", "SO"),
          labels=c("Coho", "Chum", "Pink", "Sockeye")) +
  scale_fill_discrete(name="Habitat",
                         breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))+
  theme_classic(base_size = 18) +
  scale_fill_manual(values = wes_palette("Darjeeling1"))+
  scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))

ggsave(here::here("Fine-scale migration dynamics", "figs", "fork_length_barplot.png"), width = 8, height = 7)
```

## Map

```{r KDE map}
coords <- googlesheets::gs_title("dfo_hakai_coordinates")
dfo_coords <- googlesheets::gs_read(coords, ws = "dfo") %>% 
  mutate(org = "dfo") %>% 
  select(lat, lon, org, seine_id) 
  filter(lat > 50.3, lon < -125.315) 


hakai_coords <- googlesheets::gs_read(coords, ws = "semsp")
  
hakai_coords <- hakai_coords %>% 
  mutate(org = "hakai") %>% 
  select(lat, lon, org, seine_id) %>% 
  filter(lat > 50.3, lon < -125.315)

both_coords <- rbind(hakai_coords, dfo_coords)

okisollo_get_map <- ggmap::get_map(location = c(lon = -125.315 , lat = 50.300), maptype = "toner", zoom = 12)


ggmap::ggmap(okisollo_get_map) +  
  stat_density2d(data = both_coords, aes(x = lon, y = lat, fill=..level..,alpha=..level..,group = org, colour = org),geom='polygon', na.rm = TRUE)+
  scale_fill_continuous(low="green",high="red")+
  ylim(50.303, 50.31) +
  xlim(-125.340, -125.320) +
  guides(alpha="none") 
  
ggplot(both_coords, aes(x = lon, y = lat, colour = org, group = seine_id)) +
  geom_point() +
  stat_density2d(aes(fill=..level..,alpha=..level..,group = org, colour = org),geom='polygon', na.rm = TRUE) + 
  scale_fill_continuous(low="green",high="red") +
  ylim(50.303, 50.31) +
  xlim(-125.340, -125.320) +
  guides(alpha="none")

ggsave(here::here("Fine-scale migration dynamics", "figs", "KDE_map.png"))

same_as_dfo_sites <- survey_seines_fish_stock_id %>%
 filter(seine_id %in% c("DN391", "DN401", "DN251", "DN336"))
```


```{r Tag data}
tag_workbook <- googlesheets::gs_title("Q_C_mar_dets_OK.xlsx")
tag_data <- googlesheets::gs_read(tag_workbook, ws ="OK_res_times")

tag_plot <- tag_data %>% 
  select(res) %>% 
  drop_na()

ggplot(tag_plot, aes(x = res)) +
  geom_histogram() +
  xlab("Okisollo Residency Duration (hh:mm:ss)")+
  ylab("count")

ggsave(here::here("Fine-scale migration dynamics", "figs", "okisollo_tag_duration.png"))
```




# Species Proportions 

```{r annual proportions}

(annual_prop <- okisollo %>% 
  group_by(year, org, species) %>% 
  summarize(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  ggplot(aes(x = org, y = prop, fill = species)) +
    geom_bar(stat="identity")) +
    facet_wrap(. ~ year)

ggsave(here::here("Fine-scale migration dynamics", "figs", "annual_spp_proportion.png"))

```


```{r NMDS}
species_prop_nmds_ <- okisollo %>% 
  mutate(year = year(survey_date)) %>%
  #remove 2016 because I don't have every seine conducted by DFO in 2016
  filter(year == 2015) %>% 
  group_by(org, survey_date, site_id, species) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(set = paste(org, "_", survey_date, "_", site_id)) %>% 
  select(set, species, prop) %>% 
  spread(key = species, value = prop, fill = 0) %>% 
  separate(set, into = c("org", "survey_date", "site_id"), sep = "_", remove = FALSE) %>% 
  ungroup() %>% 
  select(set, survey_date, org, SO, PI, CU, CO, HE)

write_csv(species_prop_nmds_, here::here("Fine-scale migration dynamics", "data", "species_props_for_NMDS.csv"))

row_names <- c(paste("dfo", 1:17, sep = ""), paste("hakai", 18:36, sep = ""))
row.names(species_prop_nmds_) <- row_names

species_prop_nmds_ <- species_prop_nmds_ %>% 
  select(-set, -survey_date, -org)

test_nmds <- metaMDS(species_prop_nmds_, k = 2)
stressplot(test_nmds)


# Create treatment groups for hakai and dfo seines to visually group
treat=c(rep("dfo",17),rep("hakai",18))
# First, create a vector of color values corresponding of the 
# same length as the vector of treatment values
colors=c(rep("red",17),rep("blue",18))
ordiplot(test_nmds,type="n")
#Plot convex hulls with colors baesd on organization
for(i in unique(treat)) {
  ordiellipse(test_nmds$point[grep(i,treat),],draw="polygon",
   groups=treat[treat==i],col=colors[grep(i,treat)],label=F) } 
# orditorp(test_nmds,display="species",col="red",air=0.01)
orditorp(test_nmds,display="sites",col=c(rep("red",17),
  rep("blue",18)),air=0.01,cex=1.)

```


```{r}
data(dune)
data(dune.env)
adonis(dune ~ Management*A1, data=dune.env, permutations=99)

### Example of use with strata, for nested (e.g., block) designs.

dat <- expand.grid(rep=gl(2,1), NO3=factor(c(0,10)),field=gl(3,1) )
dat
Agropyron <- with(dat, as.numeric(field) + as.numeric(NO3)+2) +rnorm(12)/2
Schizachyrium <- with(dat, as.numeric(field) - as.numeric(NO3)+2) +rnorm(12)/2
total <- Agropyron + Schizachyrium
library(lattice)
dotplot(total ~ NO3, dat, jitter.x=TRUE, groups=field,
        type=c('p','a'), xlab="NO3", auto.key=list(columns=3, lines=TRUE) )

Y <- data.frame(Agropyron, Schizachyrium)
mod <- metaMDS(Y)
plot(mod)
### Hulls show treatment
ordihull(mod, group=dat$NO3, show="0")
ordihull(mod, group=dat$NO3, show="10", col=3)
### Spider shows fields
ordispider(mod, group=dat$field, lty=3, col="red")

### Correct hypothesis test (with strata)
adonis(Y ~ NO3, data=dat, strata=dat$field, perm=1e3)

### Incorrect (no strata)
adonis(Y ~ NO3, data=dat, perm=1e3)
```



# Migration Timing

```{r 2015 all species migration timing}

#build dataset of tidy catches per seine per species
dfo_2015_tidy_catch <- read_csv(here::here("Fine-scale migration dynamics", "data", "dfo_2015_tidy_catch.csv")) %>% 
  mutate(yday = yday(date)) %>% 
  group_by(species) %>% 
  mutate(org = "dfo", percent = cumsum(n / sum(n) * 100), non_cumul_prop = n / sum(n)) %>% 
  ungroup()
  
dfo_2015_tidy_catch <- dfo_2015_tidy_catch %>% 
  select(species, yday, n, org, percent, non_cumul_prop) 

hakai_2015 <- hakaisalmon::survey_seines %>% 
  filter(site_id == "D09", survey_type == "standard",
         year(survey_date) == 2015, collection_protocol == "SEMSP") %>%
  select(survey_date, so_total, cu_total) %>% 
  gather(`so_total`, `cu_total`, key = "species", value = "n") %>% 
  drop_na() %>% 
  mutate(species = dplyr::recode(species, "so_total" = "SO", "cu_total" = "CU")) %>% 
  mutate(yday = yday(survey_date)) %>% 
  group_by(species) %>% 
  mutate(org = "hakai", percent = cumsum(n / sum(n) * 100), non_cumul_prop = n / sum(n)) %>% 
  ungroup()

hakai_2015 <- hakai_2015 %>% 
  select(species, yday, n, org, percent, non_cumul_prop)

tidy_okisollo_catch_2015 <- rbind(hakai_2015, dfo_2015_tidy_catch)
# Plot non-modelled data

ggplot(tidy_okisollo_catch_2015, aes(x = yday, y = percent, colour = org)) + geom_point() +
  #geom_smooth(se = F) +
  facet_wrap(species ~., nrow = 2)

# Try and plot semsp cumulative abundance of hakai as a function of cumaltive abundance of dfo to create linear model

tidy_by_week <- tidy_okisollo_catch_2015 %>% 
  mutate(week = yday %/% 4) %>% 
  group_by(org, species, week) %>% 
  summarize(percent = sum(non_cumul_prop)) %>% 
  mutate(percent = cumsum(percent)) %>% 
  filter(week > 18) %>% 
  ungroup()

dfo_so_lm <- tidy_by_week %>% 
  filter(org == "dfo") %>% 
  select(species, week, percent)

hakai_so_lm <- tidy_by_week %>% 
  filter(org == "hakai") %>% 
  select(species, week, percent)

so_lm_data <- full_join(dfo_so_lm, hakai_so_lm, by = c('week', 'species')) %>% 
  drop_na()

so_lm <- lm(data = so_lm_data, percent.x ~ percent.y)

summary(so_lm)

ggplot(data = so_lm_data, aes(x = percent.x, y = percent.y)) +
  geom_point() +
 geom_smooth(method = lm, fullrange = TRUE, se = F) +
  ylab("Hakai Catch Proportion") +
  xlab("DFO Catch Proportion") +
  xlim(c(0,1))+
  ylim(c(0,1))

ggsave(here::here("Fine-scale migration dynamics", "figs", "timing_lm.png"))

```

## Modelled migration timing estimates

I see some potential issues with converting this to a normal distribution because its clear the distributions are right skewed. If I'm going to model this as thoguh it;s normal, I should try to include some parameter in the function that allows me to add a skew. The other potential issue, is how it seems to be sensitive to zeros. the more zeros at the front, likely the better estimate versus no zeroes?

```{r}
# Chum dfo
chum_dfo <- tidy_okisollo_catch_2015 %>% 
  filter(species == "CU", org == "dfo")

chum_dfo_predicted <- log_cumul_abund(chum_dfo$percent, chum_dfo$yday) %>% 
  mutate(org = "dfo", species = "CU") %>% 
  mutate(daily_percent = y - lag(y)) 

#chum hakai
chum_hakai <- tidy_okisollo_catch_2015 %>% 
  filter(species == "CU", org == "hakai")

chum_hakai_predicted <- log_cumul_abund(chum_hakai$percent, chum_hakai$yday) %>% 
  mutate(org = "hakai", species = "CU") %>% 
  mutate(daily_percent = y - lag(y)) 

# sockeye dfo
sockeye_dfo <- tidy_okisollo_catch_2015 %>% 
  filter(species == "SO", org == "dfo")

sockeye_dfo_predicted <- log_cumul_abund(sockeye_dfo$percent, sockeye_dfo$yday) %>% 
  mutate(org = "dfo", species = "SO") %>% 
  mutate(daily_percent = y - lag(y)) 

#sockeye hakai
sockeye_hakai <- tidy_okisollo_catch_2015 %>% 
  filter(species == "SO", org == "hakai")

sockeye_hakai_predicted <- log_cumul_abund(sockeye_hakai$percent, sockeye_hakai$yday) %>% 
  mutate(org = "hakai", species = "SO") %>% 
  mutate(daily_percent = y - lag(y)) 



predicted <- rbind(chum_dfo_predicted, chum_hakai_predicted, sockeye_dfo_predicted, sockeye_hakai_predicted)

medians_2 <- tidy_okisollo_catch_2015 %>% 
  select(org, species, yday, n) 

medians_2 <- medians_2[rep(row.names(medians_2), medians_2$n), 1:3] %>% 
  group_by(org, species) %>% 
  summarize(median = median(yday))

ggplot() +
  geom_line(data = predicted, aes(x = x, y = y, colour = org)) +
  geom_point(data = tidy_okisollo_catch_2015, aes(x = yday, y = percent, colour = org))+
  facet_wrap(species ~ ., nrow = 2, labeller = labeller(species = spp_labels)) +
  #geom_vline(data = medians_2, aes(xintercept = median, colour = org),
             # size=.75) +
  ylab("Cumulative Abundance (%)") +
  xlab("Julian Day") +
  scale_colour_discrete(name="Habitat",
                         breaks=c("dfo", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))

ggsave(here::here("Fine-scale migration dynamics", "figs", "timing_comparison.png"))


```

```{r sockeye stock specific migration timing}
#ssmt: stock specific migration timing

ssmt_dfo <- dfo_data %>% 
  filter(species == 'SO', site_id == 'D09') %>% 
  select(survey_date, collapsed_fraser_stocks) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
  mutate(year = year(survey_date)) %>% 
  group_by(year, survey_date, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  group_by(year, collapsed_fraser_stocks) %>% 
  mutate(percent = cumsum(n / sum(n) * 100), non_cumul_prop = n / sum(n),
         yday = yday(survey_date), org = 'dfo') %>% 
  ungroup()

ssmt_hakai <- hakai_okisollo %>% 
  filter(species == 'SO', site_id == 'D09') %>% 
  select(survey_date, collapsed_fraser_stocks) %>% 
  drop_na(collapsed_fraser_stocks) %>% 
   mutate(year = year(survey_date)) %>% 
  group_by(year, survey_date, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  group_by(year, collapsed_fraser_stocks) %>% 
  mutate(percent = cumsum(n / sum(n) * 100), non_cumul_prop = n / sum(n),
         yday = yday(survey_date), org = 'hakai') %>% 
  ungroup()

ssmt <- rbind(ssmt_dfo, ssmt_hakai) %>% 
  filter(collapsed_fraser_stocks %in% c('Chilko', 'Quesnel', 'Late_Shuswap_Portage')) 

(ssmt_plot <- ggplot(ssmt, aes(x = yday, y = percent, colour = org)) +
  geom_point() +
  facet_grid(year ~ collapsed_fraser_stocks) + 
  theme(legend.position="bottom")) +
  scale_colour_discrete(name="Habitat",
                         breaks=c("dfo", "hakai"),
                         labels=c("Mid-channel", "Nearshore"))

ggsave(here::here("Fine-scale migration dynamics", "figs", "stock_specific_migration_timing.png"))



```

```{r}
okisollo %>% 
  mutate(yday = yday(survey_date)) %>%
  drop_na(stock_1) %>% 
  filter(collapsed_fraser_stocks %in% c("Chilko", "Quesnel", "Late_Shuswap_Portage", 
  "Early_Thomson", "Late_Stuart_Stellako")) %>%
  ggplot(aes(x = collapsed_fraser_stocks, y = yday, fill = org)) +
    geom_boxplot() +
    facet_grid(~year) +
    scale_fill_discrete(name="Habitat",
                          breaks=c("DFO", "hakai"),
                         labels=c("Mid-channel", "Nearshore")) +
  ylab("Julian Date") +
  xlab("Sockeye Genetic Stock")+
   theme(axis.text.x  = element_text(angle=45, vjust=0.5),
         legend.position = "bottom") +
  coord_flip()

ggsave(here::here("Fine-scale migration dynamics", "figs", "box_plot_stock_specific_migration_timing.png"))
```

```{r stock specific migration timing stats}

okisollo %>% 
  filter(year == 2015, collapsed_fraser_stocks %in% c("Chilko", "Quesnel", "Late_Shuswap_Portage", 
  "Early_Thomson", "Late_Stuart_Stellako")) %>% 
  mutate(yday = yday(survey_date)) %>% 
  select(yday, org, collapsed_fraser_stocks) %>%
  group_by(collapsed_fraser_stocks) %>%
  do(tidy(t.test(yday~org, data=.)))


okisollo %>% 
  filter(year == 2016, collapsed_fraser_stocks %in% c("Chilko", "Quesnel", "Late_Shuswap_Portage", 
  "Early_Thomson", "Late_Stuart_Stellako")) %>% 
  mutate(yday = yday(survey_date)) %>% 
  select(yday, org, collapsed_fraser_stocks) %>% group_by(collapsed_fraser_stocks) %>% do(tidy(t.test(yday~org, data=.)))
```

```{r t test lengths}
okisollo %>% 
  filter(year == 2015, collapsed_fraser_stocks %in% c("Chilko", "Quesnel", "Late_Shuswap_Portage", 
  "Early_Thomson", "Late_Stuart_Stellako")) %>% 
  mutate(yday = yday(survey_date)) %>% 
  select(sampling_week, fork_length, org, collapsed_fraser_stocks) %>%
  group_by(collapsed_fraser_stocks) %>% do(tidy(t.test(fork_length~org, data=.)))

okisollo %>% 
  filter(year == 2016, collapsed_fraser_stocks %in% c("Chilko", "Quesnel", "Late_Shuswap_Portage", 
  "Early_Thomson", "Late_Stuart_Stellako")) %>% 
  mutate(yday = yday(survey_date)) %>% 
  select(fork_length, org, collapsed_fraser_stocks) %>%
  group_by(collapsed_fraser_stocks) %>% do(tidy(t.test(fork_length~org, data=.)))

okisollo %>% 
  group_by(collapsed_fraser_stocks, year(survey_date)) %>% 
  summarize(n = n(), mean_fl = mean(fork_length)) %>% 
  arrange(mean_fl)
```


# Species Diversity

Not sure if below is the best method. I should consider rarefaction

```{r species}

# Create dataset of comparable species matrices
library(vegan)

dfo_diversity <- dfo_data %>% 
  filter(site_id == "D09") %>% 
  group_by(species) %>% 
  summarize(n = n()) %>% 
  spread(key = species, value = n, fill = 0) %>% 
  ungroup()
  
H_dfo <- diversity(dfo_diversity)
H_dfo

J_dfo <- H_dfo / log(specnumber(dfo_diversity))
J_dfo 

hakai_diversity <- okisollo %>% 
  filter(Habitat == "Nearshore") %>% 
  group_by(species) %>% 
  summarize(n = n()) %>% 
  spread(key = species, value = n, fill = 0) %>% 
  ungroup()

H_hakai <- diversity(hakai_diversity) 
H_hakai

J_hakai <- H_hakai / log(specnumber(hakai_diversity))
J_hakai
```

## Stock Diversity

```{r}
dfo_diversity <- dfo_data %>% 
  filter(site_id == "D09") %>% 
  group_by(year_tow, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  spread(key = collapsed_fraser_stocks, value = n, fill = 0) %>% 
  ungroup() %>% 
  select(-year_tow)
  
H_dfo <- diversity(dfo_diversity)
H_dfo

J_dfo <- H_dfo / log(specnumber(dfo_diversity))
J_dfo 

hakai_diversity <- hakai_okisollo %>% 
  group_by(survey_date, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  spread(key = collapsed_fraser_stocks, value = n, fill = 0) %>% 
  ungroup() %>% 
  select(-survey_date)

H_hakai <- diversity(hakai_diversity) 
H_hakai

J_hakai <- H_hakai / log(specnumber(hakai_diversity))
J_hakai


t.test(H_hakai, H_dfo)

rarefy <- rarefy(dfo_diversity, min(rowSums(dfo_diversity)))

plot(rarefy)
```

