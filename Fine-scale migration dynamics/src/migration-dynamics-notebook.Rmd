---
title: "Fine Scale Migration Dynamics"
author: "Brett Johnson"
date: "February 5, 2018"
output: 
  bookdown::html_document2:
    theme: "sandstone"
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
---

Draft Title: Fine scale migration dynamics of juvenile salmon

Focus on fine scale spatial distribution of outmigrating sockeye, pink and chum salmon, including:
* Size structure
* Stock composition
* Migration timing?
* Detailed descriptions of net design and operation.  
* Measurement process - make sure that these are aligned!

Data needs:
* DFO lat and longs

Lit Review:

__Gerbrandt, N., Sc, B., & Routledge, R. (2013). Early Marine Distribution of Out-Migrating Juvenile Sockeye Salmon ( Oncorhynchus nerka ). M.Sc. Thesis, Simon Fraser University.__

Most sockeye swim within 2 m of surface
Bigger fish enter more saline water
Systems that enter directly into highly saline waters have higher proportion of 2 year olds.
Populations migrating through systems with no surface freshwater layer actually swam deeper than populations with a fresh surface water layer.
Surface salinity and day of year were significant predictors of fork length
Beamish, R. J., Pearsall, I. a, & Healey, M. C. (2003). A history of the research on the early marine life of Pacific salmon off Canada’s Pacific coast. NPAFC Bulletin, 3(3), 1–40.

__Brodeur, R. D., Myers, K. W., & Helle, J. H. (2003). Research conducted by the United States on the early ocean life history of Pacific salmon. North Pacific Anadromous Fish Commission Bulletin Number 3, (3), 89–131.__

To read:
Straty 1974: Looks like a good one
Farley et al. (1999, 2000a, 2001a, c)
Straty and Jaenicke 1980
Straty 1981

"Historical marking studies indicate some separa-
tion in major stocks of juvenile Bristol Bay sockeye salmon as far seaward as Port Moller (Straty 1974). Differences that may contribute to stock-specific dis- tributions include time of out migration, travel dis- tance from the lake system of origin, age, and size."
  - This is more related to once they reach open ocean. 
  __Farley, E. V, Murphy, J. M., Wing, B. W., Moss, J. H., & Middleton, A. (2005). Distribution , Migration Pathways , and Size of Western Alaska Juvenile Salmon Along the Eastern Bering Sea Shelf. Alaska Fishery Research Bulletin, 11(1), 15–26.__
  
This paper used a GAM with distance from shore, distance from river mouth, and Julian date to understand what was affecting fork length
To read:
Hartt and Dell 1986; 
Isakson et al. 1986; 
Straty 1974

For pink, chum, chinook, and sockeye.
"In general, length of juvenile salmon increased with the distance from freshwater rearing locations (Figures 4a–e; 5a–c). The length of juvenile age-1.0 and -2.0 sockeye salmon increased with distance from river mouth and displayed a bell shaped curve offshore from the southern shoreline of the SBS region, with the largest fish distributed within middle Bristol Bay and the smallest fish along the southern and northern shorelines (Figures 4a and b)."


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(hakaisalmon)
library(here)
library(tidyverse)
library(ggridges)
library(lubridate)
library(knitr)
library(broom)

mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
  condition <- eval(substitute(condition), .data, envir)
  .data[condition, ] <- .data[condition, ] %>% mutate(...)
  .data
}

collapse_fraser_sockeye_stocks_neville_pdf <- function(x) {
 as.factor(x) %>% 
    forcats::fct_collapse(x,
      Early_Stuart = c("Driftwood", "Narrows", "Dust", "Bivouac", "Rossette",
                       "Sinta", "Porter_Cr", "Forfar", "Blackwater", "Gluskie", 
                       "Paula", "Felix", "Kynock", "Hudson_Bay", "Sandpoint",
                       "FiveMile", "early stuart"),
      Chilliwack = c("Chilliw_lake", "DollyVarden_Cr"),
      Pitt = c("Pitt"),
      Nadina_Gates_Bowron_Nahatlatch = c("Nadina", "Gates_Cr", "Bowron",
                                                "Nahatlatch"),
      Early_Thompson = c("Seymour", "Scotch", "Eagle", "U_Adams", "Cayenne",
                         "Fennell", "early thompson"),
      Harrison_Widgeon = c("Harrison", "WidgeonSlough"),
      Late_Stuart_Stellako = c("Middle", "Pinchi_Cr", "Tachie", "Stellako",
                               "Kuzkwa_Cr", "late stuart"),
      Chilko = c("Chilko", "Chilko-North", "Chilko_south"),
      Quesnel = c("L_Horsefly", "U_Horsefly", "Horsefly", "McKinley", 
                  "Mitchell", "Wasko_Cr", "Blue_Lead_Ck", "Quesnel_Decept",
                  "Quesnel_Horsef", "Quesnel_Mitche", "Roaring", "quesnel", "Quesnel"),
      Raft_North_Thompson = c("Raft", "Thompson_N"),
      Birkenhead_Big_Silver = c("Birkenhead", "Big_Silver"),
      Late_Shuswap_Portage = c("Eagle_L", "Little", "L_Shuswap", "MiddleShuswap",
                               "L_Adams", "Portage_Cr", "late shuswap", "shuswap"),
      Weaver_Cultus = c("Weaver", "Cultus_Lake")
    )
}

# read in dfo data that Chrys Neville provided that I tidied up first in excel
dfo_data <- read_csv(here::here("data","dfo_data.csv"))

dfo_data <- dfo_data %>% 
  add_column(ufn = "ufn", .before = "org") %>% 
  select(-prob_1) %>% 
  mutate(collapsed_fraser_stocks = collapse_fraser_sockeye_stocks_neville_pdf(stock_1)) %>% 
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "")

# create a table of hakai data from the same site that I want to compare to
# dfo.
hakai_okisollo <- survey_seines_fish_stock_id %>% 
  filter(site_id == "D09", prob_1 > 0.6) %>% 
  select(survey_date, site_id, lat, lon, species, fork_length, weight, stock_1,
         ufn) %>% 
  add_column(org = "hakai", .after = "ufn") %>% 
  add_column(DNA = NA, .after = "weight") %>% 
  add_column(year_tow = NA, .before = "survey_date") %>% 
  mutate(collapsed_fraser_stocks = collapse_fraser_sockeye_stocks_neville_pdf(stock_1)) %>% 
  filter(collapsed_fraser_stocks != 0, collapsed_fraser_stocks != "")

okisollo <- rbind(hakai_okisollo, dfo_data) %>%
  # categorize sampling events into categorical week and recod the categories so
  # that the middle of the week is the label
  mutate(sampling_week = as.numeric((yday(survey_date) + 4) %/% 7)) %>%
  mutate(
  sampling_week = recode_factor(sampling_week,
  `18` = "May 5",
  `19` = "May 12" ,
  `20` = "May 19",
  `21` = "May 26",
  `22` = "June 2",
  `23` = "June 9",
  `24` = "June 16",
  `25` = "June 23",
  `26` = "June 30",
  `27` = "July 6",
  `28` = "July 13"
  )
  ) %>% 
  mutate(k = 10^5*(weight / fork_length ^ 3)) %>% 
  mutate(year = year(survey_date))

test <- survey_seines_fish_stock_id %>% 
  filter(stock_1 != "NA") %>% 
  select(stock_1)

dfo_sockeye_stocks <- dfo_data %>% 
  select(stock_1) %>% 
  distinct()
```

# GSI 

## Stock Proportions {.tabset}

### Annual proportion
One of the first things I want to do is simply look at the stock ID proportions
across the whole year for both organizations to see very grossly if there are
obvious differences. 

It becomes clear that DFO caught a greater proportion of chilko (0.370) compared to Hakai (0.165). Also, DFO caught 20 % Stellako while Hakai caught a very low proportion.

```{r annual gsi, fig.cap= "Genetic stock proportions of all stocks of sockeye captured in 2015 in Okisollo channel"}
gsi_okisollo_2015 <- okisollo %>% 
  filter(year == "2015") %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  group_by(org, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(org) %>% 
  filter(proportion >= 0.04) %>% 
  ungroup()

prop_remaining <- gsi_okisollo_2015  %>% 
  group_by(org) %>% 
  summarize(remaining = 1 - sum(proportion))

dfo_prop_remaining_2015 <- as.numeric(prop_remaining[1,2])
hakai_prop_remaining_2015 <- as.numeric(prop_remaining[2,2])


gsi_okisollo_2015 <- gsi_okisollo_2015 %>% 
  add_row(org = "DFO", collapsed_fraser_stocks = NA, proportion = dfo_prop_remaining_2015) %>% 
  add_row(org = "hakai", collapsed_fraser_stocks = NA, proportion = hakai_prop_remaining_2015)
  
ggplot(gsi_okisollo_2015, aes(x = org, y = proportion, fill = collapsed_fraser_stocks)) +
  geom_bar(colour="black", stat="identity", position = 'stack') + 
  ggtitle("2015 Genetic Stock Proportions for DFO and Hakai at Okisollo") 

ggsave(here::here("figs", "2015_annual_gsi.png"))

#TODO: update figure lables and include n

rm(prop_remaining)
rm(gsi_okisollo_2015)
```

```{r annual gsi, fig.cap= "Genetic stock proportions of all stocks of sockeye captured in 2016 in Okisollo channel"}
gsi_okisollo_2016 <- okisollo %>% 
  filter(year == "2016") %>% 
  drop_na(collapsed_fraser_stocks) %>%
  group_by(org, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(org) %>% 
  filter(proportion >= 0.04) %>% 
  ungroup()

prop_remaining <- gsi_okisollo_2016  %>% 
  group_by(org) %>% 
  summarize(remaining = 1 - sum(proportion))

dfo_prop_remaining_2016 <- as.numeric(prop_remaining[1,2])
hakai_prop_remaining_2016 <- as.numeric(prop_remaining[2,2])


gsi_okisollo_2016 <- gsi_okisollo_2016 %>% 
  add_row(org = "DFO", collapsed_fraser_stocks = NA, proportion = dfo_prop_remaining_2016) %>% 
  add_row(org = "hakai", collapsed_fraser_stocks = NA, proportion = hakai_prop_remaining_2016)
  
ggplot(gsi_okisollo_2016, aes(x = org, y = proportion, fill = collapsed_fraser_stocks)) +
  geom_bar(colour="black", stat="identity", position = 'stack') + 
  ggtitle("2016 Genetic Stock Proportions") 

ggsave(here::here("figs", "2016_annual_gsi.png"))

#TODO: update figure labels and include n

rm(prop_remaining, dfo_prop_remaining_2015, dfo_prop_remaining_2016, hakai_prop_remaining_2015, hakai_prop_remaining_2016)
rm(gsi_okisollo_2016)
```


### Additional stock ID

Something that is important is to try to increase the sample size of hakai 
fish identified from a few key seines that dfo conducted on the same day.

To do that I calculate the number of fish that are currently compared, and 
identify where we have additional un-dissected fish.


```{r addtional possible stock_ids}
dfo_so <- dfo_data %>% 
  filter(species == "SO")

hakai_so <- left_join(survey_seines_fish_stock_id, package_data) %>% 
  filter(site_id == "D09", species == "SO") %>% 
  select(survey_date, site_id, species, fork_length, weight, stock_1,
         prob_1, ufn, semsp_id, package_id) %>% 
  mutate(org = "hakai")

hakai_same_date <- semi_join(hakai_so, dfo_so, by = "survey_date") %>% 
  filter(is.na(prob_1)) # removes fish that have already been stock ID'd 

# summarize how many fish DFO have stock ID'd per sampling event
dfo_same_date <- semi_join(dfo_so, hakai_same_date, by = "survey_date") %>% 
  filter(stock_1 != "NA") %>% 
  group_by(survey_date) %>% 
  summarize(n = n())

hakai_same_date_summary <- hakai_same_date %>% 
  group_by(survey_date) %>% 
  summarise(n_hakai = n())

dates_worth_comparing <- full_join(dfo_same_date, hakai_same_date_summary, 
                                   by = "survey_date") %>% 
  drop_na(n) %>% 
  mutate(diff = n - n_hakai) %>% 
  filter(diff > 0)

dates_worth_comparing <- as.Date(dates_worth_comparing$survey_date)

additional_2015_hakai_fish <- hakai_same_date %>% 
  filter(survey_date %in% dates_worth_comparing) %>% 
  left_join(package_data, additional_2015_hakai_fish, by = "package_id")

print(additional_2015_hakai_fish)

rm(dfo_same_date, hakai_same_date, dates_worth_comparing, dfo_so, hakai_so, hakai_same_date_summary)
```

Based on the seines that DFO has done stock IDs, there is opportunity to stock ID an additional `r nrow(additional_2015_hakai_fish)` fish from the Hakai collection, although none of these fish have actually been dissected.

If analyzing additional DFO fish is an option, then I should redo the above analysis.

Also I should consider how important it is to compare the proportion of stocks observed by organization on the same date. If I only summarize proportions by the entire sampling season then it is not neccessary.

### Stock Proportions Chi Square Test

I need to develop a method to paramaterize the difference in proportions
of stocks sampled. The simplest way to do this would be to summarize the stock proportions caught over the entire year. However, because we often sampled at different times of the season, ie our temporal distribution is
dissimilar, an integration of stock proportions caught would likely show a difference in proportions caught but would be influenced mainly by the temporal distribution of sampling. Therefore, I want to compare proportions of stocks caught by both groups on the same day in the best case. This is sort of like a repeated measure, except from one week to the next I expect very different stock proportions. I therefore need to do  multiple proportion tests and parameterize the difference of each seine, and then average that parameter from every comparison I make. 

I will try to do this fitst by calculating stock proportion over the whole year, with a chi square test. This should serve as a test case that I expect to show that these fish were sampled from different populations.

First, I need to convert proportions to integers by multiplying them by 100.
```{r proportions test}
#TODO: re-work this whole section
# First, test proportion over the whole year
okisollo_2015 <- okisollo %>% 
  filter(year(survey_date) == 2015, species == "SO") %>% 
  mutate(n = round(k * 100, 0)) %>% 
  dplyr::select(org, stock_1, n) %>% 
  drop_na(stock_1) %>% 
  drop_na(n) %>% 
  filter(n > 0)

df <- as.data.frame(okisollo_2015)

df.expanded <- df[rep(row.names(df), df$n), 1:2]

table <- table(df.expanded$org, df.expanded$stock_1)
head(table)

(x2 <- chisq.test(table))


rm(okisollo_2015, x2, df, df.expanded)
# Then, test proportions over each week
#TODO: Figure out if the chi square test is the best way to test this, it may
# be sufficient to plot this by date.
#TODO: Test proportions over each week.
```

According to the chi square test for the entire seasons proportions, the two methods of sampling are not independent. Given that I really didn't expect this result, and given that when I plot the proportions annually it is clear that they are quite different, I'm not sure that a chi square test is the appropriate statistical test to use.

### Stock Proportions by Week

```{r plot proportions by week}
comp_dates <- semi_join(dfo_data, hakai_okisollo, by = "survey_date") %>% 
  filter(species == "SO", collapsed_fraser_stocks != "NA") %>% 
  group_by(survey_date) %>% 
  summarize(n = n())

comparable_dates <- as.list(comp_dates$survey_date)

okisollo %>% 
  drop_na(site_id) %>% 
  drop_na(collapsed_fraser_stocks) %>%
  filter(survey_date %in% comparable_dates, collapsed_fraser_stocks != "x") %>% 
  group_by(org, survey_date, collapsed_fraser_stocks) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(org) %>% 
  ggplot(aes(x = org, y = proportion, fill = collapsed_fraser_stocks, label = n)) +
    geom_bar(colour="black", stat="identity", position = 'stack') +
   geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  facet_wrap(~ survey_date) + 
  scale_x_discrete(breaks=c("DFO", "hakai"),
                      labels=c("Deep", "Shallow"))+
  xlab("Habitat") +
  ylab("Proportion")

#TODO: Label stocks on bar plots
#TODO: sort out 2016 dfo stock cateegorizations

ggsave(here::here("figs", "gsi_props_by_week.png"))
```

# Lenghts 

## Chilko lengths {.tabset}

### Sampling distributions

```{r sampling distributions}
okisollo %>%
  #filter(year == 2015) %>% 
  ggplot(aes(x = survey_date, y = org)) +
  geom_density_ridges() +
  facet_grid(~year, scales = "free") +
    ggtitle("DFO and Hakai temportal sampling distribution in 2015")

Chilko <- okisollo %>% 
  filter(collapsed_fraser_stocks == "Chilko") %>% 
  #filter(year == 2015) %>% 
  mutate(stock_group = "Chilko")

other <- okisollo %>% 
  #filter(year == 2015) %>% 
  filter(collapsed_fraser_stocks != "Chilko") %>% 
  mutate(stock_group = "all_others")

chilko_and_other <- rbind(Chilko, other) %>% 
  # remove obvious 2 year old sockeye
  filter(fork_length < 175)

chilko_other_summary <- chilko_and_other %>% 
  group_by(year, org, stock_group, sampling_week) %>% 
  summarise(n=n())

# Plot samplind distribution to see if temporal sampling overlaps sufficiently
# to remove the bias incurred from increasing fork_length over the season. 
ggplot(chilko_and_other, aes(x = survey_date, fill = stock_group)) +
         geom_density(alpha = 0.5) +
  ggtitle("sampling distribution of stock groups") +
  facet_grid(org~year, scales = "free")

# Plot length distributions by week
ggplot(chilko_and_other, aes(x = fork_length, y = sampling_week, fill = stock_group)) +
  geom_density_ridges(alpha = 0.5) +
  ggtitle("Chilko Sockeye Length Distribution") +
  facet_grid(org~year)
```

### Chilko lengths within habitats

Chilko lake sockeye caught by DFO are significantly longer than other stocks caught by dfo.

```{r compare chilko lengths to other stocks within each habitat}
chilko_and_other_annual_dfo_2015 <- chilko_and_other %>% 
  # Remove first and last week becayse may 12 doesn't have comparison to chilko, and July 13 was a number of what I think were 1 year old fish that were identified as Lower Adams Sockeye.
  filter(sampling_week != "July 13", sampling_week != "May 12", org == "DFO",  year == 2015) 

t.test(fork_length ~ stock_group, data = chilko_and_other_annual_dfo_2015)

#TODO: change this test so that weekly lengths are calculated by region and paired t-test are conducted given the different temporal sampling distributions

```

Chilko lake sockeye caught by DFO are significantly longer than other stocks caught by Hakai.

```{r}
chilko_and_other_annual_hakai <- chilko_and_other %>% 
  # Remove first and last week becayse may 12 doesn't have comparison to chilko, and July 13 was a number of what I think were 1 year old fish that were identified as Lower Adams Sockeye.
  filter(sampling_week != "July 13", sampling_week != "May 12", org == "hakai", year == 2015) 

t.test(fork_length ~ stock_group, data = chilko_and_other_annual_hakai)

#TODO given the difference in sampling distributions, calculate weekly averages and conduct paired t-test
```

There is no significant trend over time in the difference between chilko and other stocks when each habitat is compared separately

```{r trend in difference in lengths within habitats over time}
chilko_by_day_dfo_2015 <- chilko_and_other %>% 
  filter(org == "DFO", year == 2015) %>% 
  group_by(survey_date, stock_group) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = stock_group, value = mean) %>% 
  drop_na("Chilko") %>% 
  mutate(diff = Chilko - all_others)

ggplot(chilko_by_day_dfo_2015, aes(x = survey_date, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)+
  ggtitle("Diff in lengths of Chilko vs other stocks from DFO catches")

lm_dfo <- lm(diff ~ survey_date, data = chilko_by_day_dfo_2015)
summary(lm_dfo)

chilko_by_day_hakai <- chilko_and_other %>% 
  filter(org == "hakai", year == "2015") %>% 
  group_by(survey_date, stock_group) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = stock_group, value = mean) %>% 
  drop_na("Chilko") %>% 
  mutate(diff = Chilko - all_others)

ggplot(chilko_by_day_hakai, aes(x = survey_date, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)+
  ggtitle("Diff in lengths of Chilko vs other stocks from hakai catches")

lm_hakai <- lm(diff ~ survey_date, data = chilko_by_day_hakai)
summary(lm_hakai)
```

### Chilko lengths amongst habitats

There is no significant trend in the difference between hakai and dfo chilko sockeye over time.

```{r diff in lengths of chilko between orgs}
chilko_lengths_hakai_dfo_2015 <- Chilko %>% 
  filter(year == "2015") %>% 
  group_by(org, sampling_week) %>% 
  summarise(mean_fl = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean_fl) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na() %>% 
  mutate(numeric_sampling_week = c(1,2,3,4,5,6,7))

ggplot(chilko_lengths_hakai_dfo_2015, aes(x = numeric_sampling_week, y = diff)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggtitle("Diff in lengths of chilko between hakai and dfo")

lm_dfo_hakai_chilko_2015 <- lm(diff ~ numeric_sampling_week, data = chilko_lengths_hakai_dfo_2015)
summary(lm_dfo_hakai_chilko_2015)
```

There is a significant difference in the lenth of chilko sockeye caught by DFO compared to length of chilko sockeye caught by hakai. 

```{r fork length t-test by org}
t.test(fork_length ~ org, data = Chilko)

rm(Chilko_by_week)
rm(other)
```

## Sockeye, pink, chum length comparison {.tabset}

Here I compute the average fork length for each species by week and then calculate the difference in average lengths for each week. I then conduct a t-test on the averaged length for each week, for each species.
I do this in an attempt to standardize the sampling over time, because we know fish are growing longer over time, and having unequal temporal sampling distribution would skew the results.

### Sockeye
There is a significant trend of an increasing difference in lengths of Hakai and DFO sockeye over the season.
```{r sockeye averaged by week for 2015}

all_SO_by_week_by_org_2015 <- okisollo %>% 
  filter(year == "2015", species == "SO") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai)

all_SO_by_week_by_org_2015$numeric_sampling_week <- c(1,2,3,4,5,6,7,8,9,10)
ggplot(all_SO_by_week_by_org_2015, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)

lm_hakai_dfo_sockeye <- lm(diff ~ numeric_sampling_week, data = all_SO_by_week_by_org_2015)
summary(lm_hakai_dfo_sockeye)

(okisollo_2015_so_lengths <- okisollo %>% 
  filter(year == "2015") %>% 
  filter(fork_length < 300, species == "SO")  %>% 
  # filter out the first week of sampling which was likely two years olds, and filter out the last week of sampling which were ocean-type sockeye, also filter out adult sockeye that DFO caught
  filter(survey_date > "2015-05-15" & survey_date < "2015-07-12", fork_length < 180) %>% 
ggplot(aes(x = survey_date, y = fork_length, colour = species)) +
  geom_point() +
  geom_smooth(method = lm)+ 
  facet_grid(~org))

```

There is a significant trend in the difference in lengths of sockeye captured by dfo and hakai.

```{r sockeye averaged by week for 2016}
all_SO_by_week_by_org_2016 <- okisollo %>% 
  filter(year == "2016", species == "SO") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai)

all_SO_by_week_by_org_2016$numeric_sampling_week <- c(1,2,3,4,5,6,7)
ggplot(all_SO_by_week_by_org_2016, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)

lm_hakai_dfo_sockeye <- lm(diff ~ numeric_sampling_week, data = all_SO_by_week_by_org_2016)
summary(lm_hakai_dfo_sockeye)

(okisollo_2016_so_lengths <- okisollo %>% 
  filter(year == "2016") %>% 
  filter(fork_length < 300, species == "SO") %>% 
ggplot(aes(x = survey_date, y = fork_length, colour = species)) +
  geom_point() +
  geom_smooth(method = lm)+ 
  facet_grid(~org))+
  ggtitle("2016 chilko lengths")

```

DFO sockeye from 2015 are significantly longer than Hakai sockeye
```{r}
dfo_2015 <- as.numeric(all_SO_by_week_by_org_2015$DFO)
hakai_2015 <- as.numeric(all_SO_by_week_by_org_2015$hakai)

(SO_lengths_by_week_t_test <- tidy(t.test(dfo_2015, hakai_2015, paired = TRUE)) %>% 
    mutate(species = "SO"))

#TODO: prove to myself that the difference in lengths isn't due to unequal temporal sampling distributions
#TODO: try and understand whether size differences are due to dfo catching a higher proportion of 2 year olds
```

DFO sockeye were significantly longer in 2016 compared with hakai sockeye

```{r}
dfo_2016 <- as.numeric(all_SO_by_week_by_org_2016$DFO)
hakai_2016 <- as.numeric(all_SO_by_week_by_org_2016$hakai)

(SO_lengths_by_week_t_test <- tidy(t.test(dfo_2016, hakai_2016, paired = TRUE)) %>% 
    mutate(species = "SO"))
```

### Pink

There doesn't appear to be a trend in the difference of pink lengths over time
```{r pink averaged by week}
all_PI_by_week_by_org <- okisollo %>% 
  filter(year == 2015, species == "PI") %>% 
  # There was a dfo pink that was 480 mm caught which is not the same age class so I filter it out.
  filter(fork_length < 480) %>%
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na()

all_PI_by_week_by_org$numeric_sampling_week <- c(1,2,3,4,5,6)

# I noticed the difference in means of chilko lengths compared to all other
# lengths seemed to increase over the season so I plotted the difference over
# time and it is an intersting trend that I can't explain.
ggplot(all_PI_by_week_by_org, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)

lm_dfo_hakai_pink <- lm(diff ~ numeric_sampling_week, data = all_PI_by_week_by_org)
summary(lm_dfo_hakai_pink)
```

DFO Pink are not statistically longer than Hakai pink, though the average DFO pink is longer than Hakai Pinks
```{r}
dfo <- as.numeric(all_PI_by_week_by_org$DFO)
hakai <- as.numeric(all_PI_by_week_by_org$hakai)

(PI_lengths_by_week_t_test <- tidy(t.test(dfo, hakai, paired = TRUE)) %>% 
    mutate(species = "PI"))

```

### Chum

There is no signnificant trend in the difference in chum over time.
```{r}
all_CU_by_week_by_org <- okisollo %>% 
  filter(year == 2015, species == "CU") %>% 
  group_by(sampling_week, org) %>% 
  summarize(mean = mean(fork_length, na.rm = TRUE)) %>% 
  spread(key = org, value = mean) %>% 
  mutate(diff = DFO - hakai) %>% 
  drop_na()

all_CU_by_week_by_org$numeric_sampling_week <- c(1,2,3,4,5,6,7,8)
# I noticed the difference in means of chilko lengths compared to all other
# lengths seemed to increase over the season so I plotted the difference over
# time and it is an intersting trend that I can't explain.
ggplot(all_CU_by_week_by_org, aes(x = numeric_sampling_week, y = diff)) +
    geom_point() +
  geom_smooth(method = lm)


lm_hakai_dfo_chum <- lm(diff ~ numeric_sampling_week, data = all_CU_by_week_by_org) 
summary(lm_hakai_dfo_chum)
```

Chum caught by DFO were significantly longer than chum caught by Hakai
```{r}
dfo <- as.numeric(all_CU_by_week_by_org$DFO)
hakai <- as.numeric(all_CU_by_week_by_org$hakai)


(CU_lengths_by_week_t_test <- tidy(t.test(dfo, hakai, paired = TRUE)) %>% 
    mutate(species = "CU"))

length_difference <- rbind(CU_lengths_by_week_t_test, PI_lengths_by_week_t_test,
                           SO_lengths_by_week_t_test)

rm(CU_lengths_by_week_t_test)
rm(PI_lengths_by_week_t_test)
rm(SO_lengths_by_week_t_test)  
rm(dfo)
rm(hakai)
rm(all_CU_by_week_by_org)
rm(all_PI_by_week_by_org)
rm(all_SO_by_week_by_org)
```

When looking at the average difference in length between deep and shallow water of fish for each week we see that chum and sockeye are significantly different between deep and shallow. Pink however, are not significantly different.

### Species lengths annually by region

In this barplot I don't average lengths by week to make sure that temporal distribution is comparable. Instead I just plot the average for the whole season.

When simply plotting the length of each species, you can see that deep fish 
were  longer than shallow caught fish. This is just based on the annual average for each species. A potential confounder with this comparison is that the temporal sampling distribution was not equal, and we know that over the length of the season, fish get longer.

It's possible that I need to use a more complicated model to include the variation that is introduced by the time variable.

```{r barplot of all species lengths}
lengths_2015 <- okisollo %>% 
  filter(year == 2015, fork_length < 300, species %in% c("SO", "PI", "CU", "CO")) %>%
  group_by(org, species) %>% 
  summarise(mean = mean(fork_length, na.rm = T),
            sd = sd(fork_length, na.rm = T), 
            n = n()) %>% 
  mutate(CI = 1.96 * (sd/sqrt(n)))

lengths_2015 %>% ggplot(aes(x = species, y = mean, fill = org)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_errorbar(position = position_dodge(.9), width = .25, aes(ymin = mean - CI, ymax = mean +
                        CI)) +
  ylab("Fork Length (mm)") +
  xlab("Species")

ggsave(here::here("figs", "fork_length_barplot.png"))
```
