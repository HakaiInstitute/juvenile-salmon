---
title: "Juvenile Salmon Survival Program Time Series"
author: "Brett Johnson"
date: "October 13, 2017"
output: 
  html_document:
    toc: true
    toc_float: true
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(hakaisalmon)
library(tidyverse)
library(lubridate)
library(plotly)
library(googlesheets)
library(ggridges)
library(forcats)
```
```{r}
# Because we haven't measured weight or length of fish in the lab yet, I replace
# NA lab weights or lengths with field weights or lengths if they were taken.
# This comparison may not be the best because the difference in weight between
# lab and field is unknown. Therefore weights and condition are not publishable
# at this stage.
survey_seines_fish <- survey_seines_fish %>% 
  mutate(k = 10^5*(weight / fork_length ^ 3)) 

#not sure if this will work or if it needs to be re-written
survey_seines_fish_stock <- left_join(survey_seines_fish, stock_id)
```


```{r}
survey_data %>% 
  count(survey_id) %>% 
  filter(n > 1)

stock_id %>% 
  count(ufn) %>% 
  filter(n > 1)

survey_seines_fish_stock %>% 
  filter(k < .4)
```

## Aim 

To present time series of juvenile Fraser salmon migration catch statistics, health indices, and oceanographic conditions in the northern Strait of Georgia to Johnstone Strait region. 

## Background

The Hakai Institute Juvenile Salmon Program was launched in the spring of 2015 in a collaborative partnership with UBC, SFU, Salmon Coast, Pacific Salmon Foundation, and DFO. The program operates in the Discovery Islands and Johnstone Strait (Figure 1) and thus provides information on the health of juvenile Fraser River salmon after passage through: 

1) Strait of Georgia – stratified high plankton biomass zone; and 

2) Discovery Islands & Johnstone Strait – highly-mixed low-plankton-biomass zone, and area of high wild-farmed fish interactions.

## Program Objectives

1) Determine migration timing and pathways; 

2) Migration habitat mapping - oceanographic conditions along the migration route;

3) Understand the dynamics of the plankton food-webs that underpin juvenile salmon growth and
health;

4) Understand parasite and pathogen infection dynamics and their impact on juvenile salmon growth and
health.

## Key Parameters Reported
* Catch Statistics
* Sockeye Genetic Stock ID Proportions
* Fish Length, Weight, and Condition
* Oceanographic Conditions

The following plots are subject to change as the underlying data are preliminary and subject to further quality assurance. 

We are endeavouring to provide useful information for the entire salmon research community. As such we welcome any feedback. Please direct questions or comments to Brian Hunt (B.Hunt@oceans.ubc.ca) and/or Brett Johnson (Brett.Johnson@hakai.org). 

# Time Series Heatmap

```{r heatmap}
# I would like this to a be a summary plot showing key parameters in relation to the time series
# Peak migration date
# SO CPUE
# Length
# SST temp
# Chl a

```


# Catch Statistics

## Migration Timing and Abundance
```{r, CPUE}
    cpue <-  select(survey_seines, survey_date, sampling_week, site_id, region, so_total) %>%
  filter(site_id %in% c("D07", "D09", "D22", "D27", "D10", "D08", "D34",
                        "D20", "J03", "J02", "J09", "J11")) %>%
  # I only included the above sites, because they have been consistent
  # over the last few years.
  mutate(year = year(survey_date)) %>%
  select(-site_id, -survey_date) %>% 
  replace_na(list(so_total = 0)) %>% 
  group_by(year, region, sampling_week) %>% 
  summarise_each(funs(mean, sd, cpue.se=sd(.) / sqrt(n())))
  

cpue$year <- as.factor(cpue$year)
labels <- c(DI = "Discovery Islands", JS = "Johnstone Strait")
cpue$sampling_week <- as_factor(cpue$sampling_week)
dodge <- position_dodge(width=0.5)
  
cpue_plot_error_bars <- ggplot(data = cpue, aes(x = sampling_week, y = mean,
                                     colour = year, group = year)) +
  geom_errorbar(aes(ymin = mean - cpue.se, ymax = mean + cpue.se),
  position = position_dodge(width = 0.15),
  width = 0.3) +
  facet_wrap(~ region, nrow = 2, scales = "free_y",
             labeller = labeller(region = labels)) +
  theme(strip.text.x = element_text(size=12)) +
  geom_line(size = 1.5) +
  geom_point(size = 2, position = position_dodge(width = 0.15)) +
  xlab("Date") +
  ylab("Sockeye CPUE") +
  theme(legend.justification = c(1, 0), legend.position = c(.83, .67)) +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(colour = "black", size = 12)) +
  theme(axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        axis.title = element_text(size = 12, face = "bold")) 


cpue_plot_error_bars

    # The dates assigned to the scale breaks represent the middle of the 
    # categorical week assigned in the giant block above.
#so_cpue_plot
#ggsave("~/Google Drive/SEMSP/SEMSP Data/Analyses/Public Analyses/Time Series/Interactive Time Series Report/raw_data/figures/so_cpue.png", width = 6, height = 5)

```

## Migration Timing
```{r}
tidy_catch <- survey_seines %>%
  # remove ad-hoc collections from migration timing calcs
  filter(survey_type == "standard") %>% 
  select(survey_date, seine_id, region, so_total, pi_total, cu_total, co_total, he_total) %>% 
  mutate(year = year(survey_date)) %>% 
  # remove instances when the net was not set because no surface activity was observed
  drop_na() %>% 
  gather(`so_total`, `pi_total`, `cu_total`, `co_total`, `he_total`, key = "species",
         value = "n") 

tidy_catch <- as.data.frame(tidy_catch)

# Create one row for every fish ever caught based on a summary by seines
catch_expanded <- tidy_catch[rep(row.names(tidy_catch), tidy_catch$n), 1:5] %>% 
  mutate(yday = yday(survey_date), year = year(survey_date)) 

# Calculare mean and standard deviation of the julian date of every fish caught
so_mt <- catch_expanded %>% 
  filter(species == "so_total") %>% 
  group_by(year, region) %>% 
             summarize(avg_date = mean(yday),
                       sd = round(sd(yday),0))

# extract mean and sd
di_mean_date_2015 <- as.numeric(so_mt[1,3])
di_sd_2015 <- as.numeric(so_mt[1,4])
js_mean_date_2015 <- as.numeric(so_mt[2,3])
js_sd_2015 <- as.numeric(so_mt[2,4])
di_mean_date_2016 <- as.numeric(so_mt[3,3])
di_sd_2016 <- as.numeric(so_mt[3,4])
js_mean_date_2016 <- as.numeric(so_mt[4,3])
js_sd_2016 <- as.numeric(so_mt[4,4])
di_mean_date_2017 <- as.numeric(so_mt[5,3])
di_sd_2017 <- as.numeric(so_mt[5,4])
js_mean_date_2017 <- as.numeric(so_mt[6,3])
js_sd_2017 <- as.numeric(so_mt[6,4])

```

## Species Catch Proportions

```{r Catch Proportions}

```

# Sockeye Genetic Stock Proportions

Fifty six unique stocks of Sockeye have been identified as having migrated
through the discovery Islands and Johnstone Strait. 

To see which stocks have 
been the most numerous each year, have a look at the figure below. The number of stocks you
select to view will filter a ranked list of top stock contributions for each year.
Ie. select 3 and you will see the proportion of total yearly catch for top 3 most commonly caught genetic stocks, and the remaining stocks proporortions will be lumped as NA.

```{r GSI, echo=FALSE}

inputPanel(
  sliderInput("n_stocks", label = h4("Select the number of stocks"), 
              min = 1, 
        max = 56, value = 5, step = 1)
    )

renderPlot({
contribs_all_years <- survey_seines_fish_stock %>% 
  drop_na(site_id) %>% 
  drop_na(stock_1) %>% 
  mutate(year = as.factor(year(survey_date))) %>% 
  group_by(year, stock_1) %>% 
  summarize(n = n()) %>% 
  mutate(proportion = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  slice(1:input$n_stocks) %>% 
  ungroup()
  
prop_remaining_2016_tbl <- contribs_all_years %>%
  filter(year == 2016) 

prop_remaining_2015_tbl <- contribs_all_years %>% 
  filter(year == 2015)

remain_2016 <- 1 - sum(prop_remaining_2016_tbl$proportion)
remain_2015 <- 1 - sum(prop_remaining_2015_tbl$proportion)


contribs_all_years_w_others <- contribs_all_years %>% 
  add_row(year = 2015, stock_1 = NA, proportion = remain_2015) %>% 
  add_row(year = 2016, stock_1 = NA , proportion = remain_2016)

# stock_levels <- c(NA, "Chilko", "L_Adams", "Horsefly", "L_Shuswap", "MiddleShuswap",
#                   "Mitchell", "Pitt", "Quesnel_Horsef", "Scotch")
# 
# contribs_all_years_w_others$stock_1 <- factor(contribs_all_years_w_others$stock_1,
#                                            levels = stock_levels)



big_contribs_plot <- 
  ggplot(contribs_all_years_w_others, aes(x = year,
                                 y = proportion, fill = stock_1)) +
  geom_bar(colour="black", stat="identity", position = 'stack') + 
  # scale_fill_discrete(name  ="Genetic Stock",
  #                           breaks=c("NA"),
  #                           labels=c("Other")) +
  ggtitle("Genetic Stock Contribution to Total Catch")

big_contribs_plot}, width = 800, height = 800)


```

# Fish Length, Weight, and Condition

```{r, length, weight, condition}
inputPanel(
  selectInput("species3", label = "Species:",
              choices = c("Sockeye" = "SO", "Chum" = "CU", "Pink" = "PI", "Coho" = "CO", "Herring" = "HE")),
  
  selectInput("parameter", label = "Parameter:",
              choices = c("Weight" = "weight", "Length" = "fork_length", "Condition" = "k"), selected = "weight"
)
)

renderPlot({
  distributions_tbl <- survey_seines_fish %>% 
    filter(species == input$species3) %>% 
    mutate(year = lubridate::year(survey_date)) %>% 
    select(species, weight, fork_length, k, year) %>% 
    na.omit()
    
  ggplot(distributions_tbl, aes(x=get(input$parameter), y = year, group = year)) +
    geom_density_ridges() +
    labs(x = input$parameter)
  }, width = 800, height = 600)
```




```{r}
inputPanel(
  selectInput("arranged", label = "Facet Arrangement",
              choices = c("Years on Top" = "region ~ year", "Region on Top" =
                            "year ~ region",
                          "Compare Years (regions combined)" = "year ~ .", "Compare Regions (years combined)" = "region ~ ."
                           ),
              selected = "Years on Top")
  )

renderPlot({
  so_stock_cond_tbl <- survey_seines_fish_stock %>%
  drop_na(stock_1) %>%
  filter(prob_1 >= .5) %>%
  filter(stock_1 %in% c("Chilko", "L_Adams",
                          "Horsefly", "L_Shuswap",
                          "MiddleShuswap", "Mitchell",
                          "Pitt" , "Quesnel_Horsef",
                          "Scotch")) %>%
  mutate(year = year(survey_date)) %>%
  select(stock_1, sampling_week, region, k, year) %>%
  drop_na(k) %>% 
  drop_na(year)


so_cond_plot <- ggplot(data = so_stock_cond_tbl, aes(x = k, y = as.factor(stock_1), fill = stock_1)) +
           geom_density_ridges() +
  facet_grid(input$arranged) +
  xlim(.5:1.5)

so_cond_plot

  },width = 1000, height = 1000)


```

