---
title: Juvenile Salmon Migration Dynamics in the Discovery Islands and Johnstone Strait in 2018
preprint: true
author: 
  - name: Brett T. Johnson
    affiliation: 1
    corresponding: true
    email: brett.johnson@hakai.org
  - name: Julian C.L. Gan
  - name: Carly V. Janusson
  - name: Brian P.V. Hunt
    affiliation: 1, 2, 3
affiliation:
  - code: 1
    address: Hakai Institute Quadra Island Ecological Observatory, Heriot Bay, BC V0P 1H0
  - code: 2
    address: Institute for the Oceans and Fisheries, University of British Columbia Vancouver, B.C., Canada V6T 1Z4
  - code: 3
    address: Department of Earth, Ocean and Atmospheric Sciences, University of British Columbia Vancouver, B.C., Canada V6T 1Z4
abstract: >
  The majority of out-migrating juvenile Fraser River salmon (_Oncorhynchus_ spp.) pass northwest through the Strait of Georgia, the Discovery Islands, and Johnstone Strait. The Discovery Islands to Johnstone Strait leg of the migration is a region of poor survival for juvenile salmon relative to the Strait of Georgia. To better understand the factors that are driving early marine survival through this region the Hakai Institute Juvenile Salmon Program monitors key aspects of this migration. Here we report on the 2018 migration in comparison to averages from the 2015--2018 study period, which we use to define 'normal' in our building time series. In 2018 sockeye (_O. nerka_), pink (_O. gorbuscha_), and chum (_O. keta_) all migrated earlier than normal, though not more than by a week. The median capture date in the Discovery Isalnds was May 23rd for sockeye, five days earlier than normal; and June 12 for pink and chum, which is five days earlier for pink and three days earlier than normal for chum. Sea lice prevalence was lower than normal for sockeye, pink, and chum. Notably, there were no _Lepeophtheirus salmonis_ sea lice observed in Johnstone Strait in 2018. Sockeye were longer than normal in 2018 whereas pink and chum were smaller than normal. Pink salmon dominated the catch in 2018, followed by chum, and then socke Sea surface temperatures in May and June were the warmest on record in the study period (2015--2018). ye.
header-includes: >
  \usepackage{lipsum}
  \usepackage{multirow}
  \usepackage{float}
  \floatplacement{figure}{H}
bibliography: references.bib
output: 
  rticles::peerj_article:
    base_format: bookdown::pdf_document2 # for using \@ref()
---

```{r setup, include = FALSE, messages = FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
# All data used for this analysis is from the hakaisalmon R package v0.2.0 at https://hakaiinstitute.github.io/hakaisalmon/
library(hakaisalmon)
library(tidyverse)
library(lubridate)
library(knitr)
library(here)
library(car)
library(ggridges)
library(forcats)

theme_set(theme_bw())

survey_seines <- read_csv(here("data", "survey_seines.csv")) %>% 
  rename("Sockeye" = "so_total", "Pink" = "pi_total", "Chum" = "cu_total")
sealice_time_series <- read_csv(here("data", "sealice_time_series.csv"))
temperature_anomaly_data <- read_csv(here("data", "temperature_anomaly_data.csv"))
min_max_data <- read_csv(here("data", "min_max_temps.csv"))
average_temps <- read_csv(here("data", "average_temps.csv"))
tidy_catch <- read_csv(here("data", "tidy_catch.csv"))
proportion <- read_csv(here("data", "proportion.csv"))
ctd_all <- read_csv(here("data", "ctd_all.csv"))
predict_average_prop <- read_csv(here("data", "predict_average_prop.csv"))
length_histo <- read_csv(here("data", "length_histo.csv"))
peak_dates <- read_csv(here("data", "peak_dates.csv"))

spp_labels <- c(CU = "Chum", PI = "Pink", SO = "Sockeye", DI = "Discovery Islands", 
                JS = "Johnstone Strait")

pl_colours <- c("pi_total" = "pink", "so_total" = "#00BFC4", "cu_total" = "#7CAE00", 
                    "co_total" = "#F8766D", "he_total" = "#C77CFF")

current_year <- max(year(survey_data$survey_date))
project_years <- current_year - 2015 + 1
```

# Introduction {-}

The first months after marine entry have been identified as a potentially critical period [@Beamish2001] for salmon stock recruitment, which may ultimately be responsible for inter-annual variability and long term declines in salmon stocks in British Columbia [@Peterman2010; @Beamish2012]. Pathogens, parasites, predators and the impacts of climate change on food web dynamics have emerged as leading causes for the decline. The Hakai Institute Juvenile Salmon Program has been monitoring juvenile salmon migrations in the Discovery Islands and Johnstone Strait (Figure \@ref(fig:map)) since 2015 in an effort to understand what factors may be influencing early marine survival of sockeye, pink, and chum [@Hunt2018]. This report summarizes migration timing, fish length, parasite loads, species composition, and sea-surface temperature observed from the first `r project_years` years of this research and monitoring program. These estimates will provide the context from which to investigate questions and interpret results related to growth, survival, and the conditions salmon experience during their migration through this critical region. 



```{r map, fig.cap = "Sampling locations in 2018", fig.align='left', out.width='80%'}
include_graphics('map.png')
```

# Methods {-}

## Field methods {-}

See Hunt et al. (2018) for a detailed description of field and lab methods. Briefly, we collect juvenile salmon weekly from the Discovery Islands and Johnstone Strait during their northward migration from the Strait of Georgia to Queen Charlotte Strait near northern Vancouver Island, British Columbia. Sampling is conducted from May to July each year since 2015 using purse seine nets (bunt: 27 m x 9 m with 13 mm mesh; tow: 46 m x 9 m with 76 mm mesh). We sample in nearshore marine habitats with depth > 10 m and effectively sample sockeye (_Oncorhynchus nerka_), pink (_O. gorbuscha_), chum (_O. keta_) and incidentally capture coho (_O. kisutch_), chinook (_O. tshawytschya_) and Pacific herring (_Clupea pallasii_). All animal care was in accordance with Animal Care Guidelines under permit A16-0101. Temperature data were collected by deploying an RBR conductivity, temperature, and depth profiler to depths > 30 m at station QU39 (Figure \@ref(fig:map)) in the northern Strait of Georgia.

## Statistical methods {-}

All metrics reported are in relation to the time series average (2015-2018). The mean for each parameter of interest was calculated for all years combined, and the z-score was calculated for each parameter to determine the number of standard deviations away from the mean a given parameter was in each year.

The peak migration date for each species was estimated by calculating the median date of capture in the Discovery Islands—the date at which 50 percent of the fish passed through the region. Because very few pink are caught in odd years, only even years were included in the calculation of the time serie average. To visualize migration timing we plotted cumulative catch abundance between May 1st and July 9th each year and fit a logistic growth line. Species proportions were calculated by dividing the total number of each species caught, by the sum of all species caught that season. Only seines that contained sockeye were used in the calculation of species proportions, so in effect this species proportion measure is representative of the salmon community composition  that co-migrate with sockeye. Fork length distributions were visualized by calculating kernel density estimates from fork length data. The prevalence, intensity, and abundance of sealice was calculated as detailed in @Margolis1990. The mean sea surface temperature was calculated from the top 30 m of the water column in May and June from all years. To visualize temperature anomalies we applied a loess regression to sea surface temperatures from all four years to develop a model that would represent the seasonal trend. 

# Results and Discussion {-}

## Migration Timing {-}


```{r migration stats, include=FALSE}

iqr_DI_tsa <- peak_dates %>% 
  group_by(species) %>% 
  summarise(q1= mean(q1),
            median= mean(median),
            q3= mean(q3),
            n = n()) %>% 
  mutate(year = paste(2015, "-", current_year), region = "DI") %>% 
  ungroup()%>% 
  arrange(year, desc(species))

peak_dates <- peak_dates %>% 
  arrange(year, desc(species))

iqr_DI_allyears <- rbind(iqr_DI_tsa,peak_dates) %>% 
  mutate_if(is.numeric, round) 

so_q1_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "SO" & year == paste(2015, "-", current_year)) %>% 
  select(q1))
so_q2_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "SO" & year == paste(2015, "-", current_year)) %>% 
  select(median))
so_q3_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "SO" & year == paste(2015, "-", current_year)) %>% 
  select(q3))
so_q1_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "SO" & year == current_year) %>% 
  select(q1))
so_q2_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "SO" & year == current_year) %>% 
  select(median))
so_q3_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "SO" & year == current_year) %>% 
  select(q3))

pi_q1_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "PI" & year == paste(2015, "-", current_year)) %>% 
  select(q1))
pi_q2_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "PI" & year == paste(2015, "-", current_year)) %>% 
  select(median))
pi_q3_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "PI" & year == paste(2015, "-", current_year)) %>% 
  select(q3))
pi_q1_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "PI" & year == current_year) %>% 
  select(q1))
pi_q2_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "PI" & year == current_year) %>% 
  select(median))
pi_q3_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "PI" & year == current_year) %>% 
  select(q3))

cu_q1_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "CU" & year == paste(2015, "-", current_year)) %>% 
  select(q1))
cu_q2_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "CU" & year == paste(2015, "-", current_year)) %>% 
  select(median))
cu_q3_DI_TSA <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "CU" & year == paste(2015, "-", current_year)) %>% 
  select(q3))
cu_q1_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "CU" & year == current_year) %>% 
  select(q1))
cu_q2_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "CU" & year == current_year) %>% 
  select(median))
cu_q3_DI_current <- as.numeric(iqr_DI_allyears %>% 
  filter(species == "CU" & year == current_year) %>% 
  select(q3))

# Calculate Z-score for migration date
SO_mean_of_median_date <- peak_dates %>% 
  ungroup() %>% 
  filter(species == "SO") %>% 
  summarize(mean_date = mean(median)) %>% 
  as.numeric()

SO_sd_of_median_date <- peak_dates %>% 
  ungroup() %>% 
  filter(species == "SO") %>% 
  summarize(sd_date = sd(median)) %>% 
  as.numeric()

PI_mean_of_median_date <- peak_dates %>% 
  ungroup() %>% 
  filter(species == "PI") %>% 
  summarize(mean_date = mean(median)) %>% 
  as.numeric()

PI_sd_of_median_date <- peak_dates %>% 
  ungroup() %>% 
  filter(species == "PI") %>% 
  summarize(sd_date = sd(median)) %>% 
  as.numeric()


CU_mean_of_median_date <- peak_dates %>% 
  ungroup() %>% 
  filter(species == "CU") %>% 
  summarize(mean_date = mean(median)) %>% 
  as.numeric()

CU_sd_of_median_date <- peak_dates %>% 
  ungroup() %>% 
  filter(species == "CU") %>% 
  summarize(sd_date = sd(median)) %>% 
  as.numeric()

SO_z <- peak_dates %>%
  filter(species == "SO") %>% 
  arrange(desc(year), desc(species)) %>%
  mutate(z_score = (median - SO_mean_of_median_date) / SO_sd_of_median_date) %>% 
  select(year, z_score)

PI_z <- peak_dates %>%
  filter(species == "PI") %>% 
  arrange(desc(year), desc(species)) %>%
  mutate(z_score = (median - PI_mean_of_median_date) / PI_sd_of_median_date) %>% 
  select(year, z_score)

CU_z <- peak_dates %>%
  filter(species == "CU") %>% 
  arrange(desc(year), desc(species)) %>%
  mutate(z_score = (median - CU_mean_of_median_date) / CU_sd_of_median_date) %>% 
  select(year, z_score)


so_z_migration <- as.numeric(SO_z[1,2])
pi_z_migration <- as.numeric(PI_z[1,2])
cu_z_migration <- as.numeric(CU_z[1,2])

# calculate the differene in timing for current year soecies in DI compated to time series
so_timing_diff <- abs(so_q2_DI_current - so_q2_DI_TSA)

# Define whether the timing was earlier or later for use in inline text
so_later_or_earlier <- ifelse(so_q2_DI_current - so_q2_DI_TSA > 0, "later", "earlier")

# calculate the differene in timing for current year piecies in DI compated to time series
pi_timing_diff <- abs(pi_q2_DI_current - pi_q2_DI_TSA)

# Define whether the timing was earlier or later for use in inline text
pi_later_or_earlier <- ifelse(pi_q2_DI_current - pi_q2_DI_TSA > 0, "later", "earlier")

# calculate the differene in timing for current year cuecies in DI compated to time series
cu_timing_diff <- abs(cu_q2_DI_current - cu_q2_DI_TSA)

# Define whether the timing was earlier or later for use in inline text
cu_later_or_earlier <- ifelse(cu_q2_DI_current - cu_q2_DI_TSA > 0, "later", "earlier")

# Define function f here to convert Julian Days to dates
f <- function(x) {
  format(x + as.Date("2018-01-01") -1, format = "%B %d")
}

iqr_DI_allyears <- rbind(iqr_DI_tsa, peak_dates) %>% 
  rename(Year = year, Species = species, Region = region, n = n, Q1 = q1, "Peak Date" = median,
         Q3 = q3) %>% 
  select(Year, Region, Species, Q1, "Peak Date", Q3) %>% 
  mutate_if(is.numeric, round) 
```

Migration timing in the Discovery Islands in 2018 did not differ from the time series average by more than a week for sockeye, pink, or chum (Table \@ref(tab:mtdi)). The peak migration date for sockeye in the Discovery Islands was on `r f(so_q2_DI_current)`, `r round(so_timing_diff)` days `r so_later_or_earlier` than the time series average of `r f(so_q2_DI_TSA)` (z-score = `r round(so_z_migration,2)`) (Figure \@ref(fig:mt)). The peak migration date for pink in the Discovery Islands was on `r f(pi_q2_DI_current)`, `r round(pi_timing_diff)` days `r pi_later_or_earlier` than the average of `r f(pi_q2_DI_TSA)` (z-score = `r round(pi_z_migration,2)`). The peak migration date for chum in the Discovery Islands was on `r f(cu_q2_DI_current)`, `r round(cu_timing_diff)` days `r cu_later_or_earlier` than the average of `r f(cu_q2_DI_TSA)` (z-score = `r round(cu_z_migration,2)`).

```{r migration plot setup, include = FALSE}

daily_mean_cumul_abund_annual <- tidy_catch %>%
  ungroup() %>%
  filter(species == "so_total", region == "DI") %>%
  mutate(year = as.factor(year)) %>%
  group_by(year, region) %>%
  mutate(percent = cumsum(n / sum(n) * 100),
         non_cumul_prop = n / sum(n)) %>%
  ungroup() %>%
  transmute(
    year = year,
    survey_date = yday,
    region = region,
    percent = percent,
    non_cumul_prop = non_cumul_prop
  ) %>%
  ungroup() %>%
  group_by(year, region, survey_date) %>%
  summarize(
    percent = mean(percent),
    non_cumul_prop = mean(non_cumul_prop) * 100,
    n = n()
  )

#2015
cum_abund_annual_DI_2015 <- daily_mean_cumul_abund_annual %>%
  filter(region == "DI", year == 2015)

predict_annual_prop_DI_2015 <-
  log_cumul_abund(cum_abund_annual_DI_2015$percent,
                  cum_abund_annual_DI_2015$survey_date) %>%
  mutate(region = "DI", year = 2015) %>%
  mutate(daily_percent = y - lag(y))

#2016
cum_abund_annual_DI_2016 <- daily_mean_cumul_abund_annual %>%
  filter(region == "DI", year == 2016)

predict_annual_prop_DI_2016 <-
  log_cumul_abund(cum_abund_annual_DI_2016$percent,
                  cum_abund_annual_DI_2016$survey_date) %>%
  mutate(region = "DI", year = 2016) %>%
  mutate(daily_percent = y - lag(y))
#2017
cum_abund_annual_DI_2017 <- daily_mean_cumul_abund_annual %>%
  filter(region == "DI", year == 2017)

predict_annual_prop_DI_2017 <-
  log_cumul_abund(cum_abund_annual_DI_2017$percent,
                  cum_abund_annual_DI_2017$survey_date) %>%
  mutate(region = "DI", year = 2017) %>%
  mutate(daily_percent = y - lag(y))
#2018
cum_abund_annual_DI_2018 <- daily_mean_cumul_abund_annual %>%
  filter(region == "DI", year == 2018)

predict_annual_prop_DI_2018 <-
  log_cumul_abund(cum_abund_annual_DI_2018$percent,
                  cum_abund_annual_DI_2018$survey_date) %>%
  mutate(region = "DI", year = 2018) %>%
  mutate(daily_percent = y - lag(y))

predict_annual_prop <-
  rbind(
    predict_annual_prop_DI_2015,
    predict_annual_prop_DI_2016,
    predict_annual_prop_DI_2017,
    predict_annual_prop_DI_2018
  )

# Filter out the timeseries (2015-2018) table based on inputs
predict_average_prop <- predict_average_prop %>%
  filter(species == "so_total", region == "DI")

# Run this commented out code to generate the code for nice colours
# library(scales)
# show_col(hue_pal()(project_years))

cols <-
  c(
    "2015-2018" = "black",
    "2018" = "#F8766D",
    "2017" = "#7CAE00",
    "2016" = "#00BFC4",
    "2015" = "#C77CFF"
  )
shapes <-
  c(
    "2015-2018" = "triangle",
    "2018" = "circle",
    "2017" = "circle",
    "2016" = "circle",
    "2015" = "circle"
  )

```

```{r mt, fig.cap="Cumulative catch of juvenile sockeye salmon migrating through the Discovery Islands compared to the average for 2015--2018. Migration curves were predicted by fitting a logistic growth equation to the cumulative percent of sockeye in each year.", out.width='80%'}
    cum_abund_plot <- ggplot()+
      labs(x = 'Date', y = 'Cumulative Catch %')+
      #geom_point(data = predict_average_prop, aes(x = x, y = y, shape = year, colour = year), size = 2) +
      #geom_point(data = daily_mean_cumul_abund_annual, aes(x = survey_date, y = percent, color = year), size = 3) +
      geom_line(data = predict_average_prop, aes(x = x, y = y, color = year), size = 2, alpha = 0.8) +
      scale_linetype_manual(values = c("dashed")) +
      geom_line(data = predict_annual_prop, aes(x = x, y = y, color = as.factor(year)), size = 1.25, alpha = 0.8, linetype = "longdash") +
      scale_x_continuous(breaks = c(135, 152, 166, 182, 196), 
                         labels = c("May 15", "June 1", "June 15", "July 1", "July 15")) +
      coord_cartesian(xlim = c(128, 182)) + 
      scale_shape_manual(values = shapes) +
      scale_colour_manual(values = cols, name="",
                         breaks=c("2015-2018", "2015", "2016", "2017", "2018"),
                         labels=c("Average", "2015", "2016", "2017", "2018")) +
  theme(legend.position = c(0.9, 0.5))

    cum_abund_plot
    
ggsave(here("figs", "migration_timing.png"))
```


## Length {-}

```{r, length stats}
length_histo_current <- length_histo %>% 
  filter(year == current_year) %>% 
  mutate(category = current_year)

summary_lengths <- length_histo %>% 
  group_by(year, region, species) %>% 
  summarize(SD = sd(fork_length, na.rm = TRUE),
            fork_length = round(mean(fork_length),1),
            n = n()) %>% 
  mutate(SE = SD / sqrt(n),
         CI = qt(1 - (0.05 / 2), n - 1) * SE) %>% 
  arrange(year, region, desc(species)) %>% 
  select(year, region, species, n, fork_length, CI) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  ungroup() %>% 
  mutate(year = as.character(year))

tsa_length <- summary_lengths %>% 
  ungroup() %>% 
  group_by(region, species) %>% 
  summarize(SD = sd(fork_length, na.rm = TRUE),
            fork_length = round(mean(fork_length),1),
            n = n()) %>% 
  mutate(SE = SD / sqrt(n),
         CI = qt(1 - (0.05 / 2), n - 1) * SE,
         year = paste(2015, "-", current_year)) %>% 
  arrange(year, region, desc(species)) %>% 
  select(year, region, species, n, fork_length, CI) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  bind_rows(summary_lengths) %>% 
  mutate("95% CI" = paste(fork_length - CI, "-", fork_length + CI)) %>% 
  rename(Year = year, Region = region, Species = species, 
         "Fork Length (mm)" = fork_length) %>% 
  select(Year, Region, Species, n, "Fork Length (mm)", "95% CI")
  
len_tt <- length_histo %>% 
  mutate(category = 'tsa') %>% 
  rbind(length_histo_current) %>% 
  group_by(species) %>% 
  do(broom::tidy(t.test(.$fork_length ~ .$category))) %>% 
  arrange(desc(species))

```


Fish lengths varied between regions, species and year (Figure \@ref(fig:lengthplot)).
In `r current_year` in the Discovery Islands and Johnstone Strait combined the average sockeye length was `r round(len_tt[1,3],1)` mm (Table \@ref(tab:length)), which is `r abs(round(len_tt[1,2],1))` mm `r ifelse(len_tt[1,2] > 0, "longer", "shorter")` than the time series average (_p_ < 0.0001, 95% CI `r abs(round(len_tt[1,8],1))`, `r abs(round(len_tt[1,9],1))`). Average pink lengths were `r round(len_tt[2,3],1)` mm, which is `r abs(round(len_tt[2,2],1))` mm `r ifelse(len_tt[2,2] > 0, "longer", "shorter")` than the time series average (_p_ < 0.0001, 95% CI `r abs(round(len_tt[2,8],1))`, `r abs(round(len_tt[2,9],1))`). Chum  were on average `r round(len_tt[3,3],1)` mm, which is `r abs(round(len_tt[3,2],1))` mm  `r ifelse(len_tt[3,2] > 0, "longer", "shorter")` than the time series average (_p_ < 0.0001, 95% CI `r abs(round(len_tt[3,8],1))`-`r round(len_tt[3,9],1)`).


```{r lengthplot, out.width='80%', fig.cap="Kernel density distributions of juvenile salmon fork lengths for each year in the selected region. Note that these distributions contain multiple age-classes."}

ggplot(length_histo, aes(fork_length, y = factor(year))) +
  ggridges::geom_density_ridges(color='black') +
  xlab("Fork Length (mm)") +
  facet_grid(species ~ region, labeller = labeller(region = spp_labels, species = spp_labels)) +
  coord_cartesian(xlim = c(60, 180)) +
  ylab("Year")

ggsave(here("figs", "lengths.png"))
```

## Species Proportions {-}

```{r species proportions stats}

current_prop <- proportion %>% 
  filter(year == current_year) %>% 
  filter(species %in% c("so_total", "pi_total", "cu_total")) %>% 
  arrange(species)

so_prop <- round(100 * current_prop[3,4], 1) %>% as.numeric()
pi_prop <- round(100 * current_prop[2,4], 1) %>% as.numeric()
cu_prop <- round(100 * current_prop[1,4], 1) %>% as.numeric()

remaining <- 100 - (so_prop + pi_prop + cu_prop)

 
new_spp_names <- dplyr::recode(proportion$species, so_total = "Sockeye",
                               pi_total = "Pink", cu_total = "Chum",
                               he_total = "Herring", co_total = "Coho",
                               ck_total = "Chinook")

proportions_table <- proportion %>% 
  mutate(species = new_spp_names,
         proportion = round(proportion, 3)) %>% 
  rename(Year = year, Species = species, Proportion = proportion) %>% 
  select(Year, Species, Proportion) %>% 
  spread(key = Species, value = Proportion)
```

Pink salmon dominated the catch in the Discovery Islands and Johnstone in 2018 making up `r pi_prop` % of the catch (Table \@ref(tab:proptable)) while chum made up `r cu_prop` percent and sockeye `r so_prop` % (Figure \@ref(fig:prop)).

```{r prop, out.width = '80%', fig.cap="The annual proportion of fish captured in the Discovery Islands and Johnstone Strait combined."}
    
    ggplot(data = proportion, aes(x = year, y = proportion, fill = fct_reorder(species, proportion, .desc = TRUE))) +
      geom_bar(stat="identity", position = 'stack') +
      scale_fill_manual(values = pl_colours, name = "Species",
                        breaks=c("so_total","cu_total","pi_total","co_total", "he_total"),
                        labels=c("sockeye", "chum", "pink", "herring", "coho")) +
      xlab("Year") +
      ylab("Proportion") 

ggsave(here("figs", "proportions.png"))
```


## Parasite Loads {-}


```{r}
# Parasite loads Z scores
## The idea here is to create an aggregated parasite index for both motile leps and caligus sealice for both regions separatlely

abundance_df <- sealice_time_series %>% 
      group_by(year, region, louse_species, species) %>% 
      summarize(abundance =  mean(n_lice, na.rm = T), 
                           sd = sd(n_lice, na.rm = T),
                           n = n()) %>% 
                   mutate(se = sd / sqrt(n),
                          lower_ci = qt(1 - (0.05 / 2), n - 1) * se,
                          upper_ci = qt(1 - (0.05 / 2), n - 1) * se) %>% 
   filter(louse_species == "all_lice") %>%
  ungroup() %>% 
  mutate_if(is.numeric, round, 2) %>% 
  rename(Abundance = abundance) %>%  
  mutate("Abundance, 95% CI" = paste(Abundance, "+/-", lower_ci)) %>% 
  select(year, region, species, n, Abundance, "Abundance, 95% CI")

prevalence <- sealice_time_series %>%
      mutate(lousy = ifelse(n_lice > 0, "has_lice", "no_lice")) %>% 
      group_by(year, region, louse_species, species, lousy) %>% 
      summarize(n = n()) %>% 
      spread(key = lousy, value = n) %>% 
      mutate(n = sum(has_lice, no_lice), prevalence = has_lice / n) %>% 
      drop_na() %>% 
      do(broom::tidy(binom.test(.$has_lice, .$n, 0.5, alternative = "two.sided",
                                conf.level = 0.95))) %>% 
      rename("prevalence" = "estimate") %>% 
   filter(louse_species == "all_lice") %>% 
  ungroup() %>% 
  mutate_if(is.numeric, round, 2) %>% 
  rename(Prevalence = prevalence, n = parameter) %>% 
  mutate("Prevalence, 95% CI" = paste0(Prevalence, "+/-", conf.low)) %>% 
  select(year, region, species, n, Prevalence, "Prevalence, 95% CI")

intensity <- sealice_time_series %>%
      filter(n_lice > 0) %>%
      select(year, region,  louse_species, species, n_lice) %>%
      group_by(year, region, species, louse_species) %>%
      summarise(intensity =  mean(n_lice, na.rm = T), 
                sd = sd(n_lice, na.rm = T),
                n = n()) %>% 
      mutate(se = sd / sqrt(n),
             lower_ci = qt(1 - (0.05 / 2), n - 1) * se,
             upper_ci = qt(1 - (0.05 / 2), n - 1) * se) %>% 
  filter(louse_species == "all_lice") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  rename(Intensity = intensity) %>% 
  mutate("Intensity, 95% CI" = paste(Intensity, "+/-", lower_ci)) %>% 
  select(year, region, species, Intensity, "Intensity, 95% CI")

parasite_summary_table <- full_join(abundance_df, prevalence) %>% 
  full_join(intensity) %>% 
  rename(Year = year, Region = region, Species = species)



time_series_parasite_summary <- parasite_summary_table %>% 
  ungroup() %>% 
  group_by(Species) %>% 
  summarise(Prevalence_sd = sd(Prevalence),
            Prevalence = mean(Prevalence),
            Intensity_sd = sd(Intensity),
            Intensity = mean(Intensity),
            Abundance_sd = sd(Abundance),
            Abundance = mean(Abundance),
            n = sum(n)) %>% 
  mutate(Prevalence_se = Prevalence_sd / sqrt(n),
         Intensity_se = Intensity_sd/ sqrt(n),
         Abundance_se = Abundance_sd / sqrt(n)) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate("Prevalence, 95% CI" = paste(round(Prevalence,2), "+/-", round(qt(1 - (0.05 / 2), n - 1) * Prevalence_se,2)),
         "Intensity, 95% CI" = paste(round(Intensity,2), "+/-", round(qt(1 - (0.05 / 2), n - 1) * Intensity_se, 2)),
         "Abundance, 95% CI" = paste(round(Abundance,2), "+/-", round(qt(1 - (0.05 / 2), n - 1) * Abundance_se, 2))) %>% 
  mutate(Year = paste(2015, "-", current_year),
         Region = "DI & JS") %>% 
  select(Year, Region, Species, n, Abundance, "Abundance, 95% CI", Prevalence,
         "Prevalence, 95% CI", Intensity, "Intensity, 95% CI") %>% 
  rbind(parasite_summary_table) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(Year, Region, Species, n, "Abundance, 95% CI", "Prevalence, 95% CI", "Intensity, 95% CI")
```


The prevalence of motile (pre-adult and adult life stage) sea lice in 2018 was the lowest recorded in the time-series (Figure \@ref(fig:sealice)). Notably, no _Lepeophtheirus salmonis_ were detected on sockeye in Johnstone Strait, despite being present in the Discovery Islands. Pink salmon appeared to have higher counts of _Caligus clemensi_ in 2018 compared to chum and sockeye.  See Table \@ref(tab:parasites),


```{r sealice, out.width='80%', fig.cap="The abundance (+/- 95% CI) of motile sea lice on juvenile salmon in the Discovery Islands and Johnstone Strait."}

abundance <- sealice_time_series %>% 
      group_by(year, region, louse_species, species) %>% 
      summarize(abundance =  mean(n_lice, na.rm = T), 
                           sd = sd(n_lice, na.rm = T),
                           n = n()) %>% 
                   mutate(se = sd / sqrt(n),
                          lower_ci = qt(1 - (0.05 / 2), n - 1) * se,
                          upper_ci = qt(1 - (0.05 / 2), n - 1) * se) %>% 
  filter(louse_species == "all_lice")

ggplot(data = abundance, aes(x = factor(year), y = abundance, fill = factor(species),
                 group = factor(species))) +
      geom_bar(stat = "identity", position = position_dodge()) +
      geom_errorbar(aes(ymin = abundance - lower_ci, 
                        ymax = abundance + upper_ci), 
                    width = 0.2,
                    position = position_dodge(0.9)) +
      facet_grid(region ~., labeller = labeller(species = spp_labels, 
                                                       region = spp_labels)) +
      labs(x = "Year", y = "abundance") +
      scale_fill_discrete(name="Species",
                          breaks=c("SO", "CU", "PI"),
                          labels=c("Sockeye", "Chum", "Pink")) +
      theme(legend.position="bottom") +
      geom_text(aes(label = ifelse(abundance == 0, round(abundance, 1), '')),
                position = position_dodge(0.9), vjust = -0.5) +
      geom_text(aes(y = 0.0, label = paste0(n)), size = 3.15, vjust = 1.25,
                position = position_dodge(0.9)) +
      scale_y_continuous(expand = expand_scale(mult = c(.15, 0)))
```


## Sea Surface Temperature {-}

```{r}
# SST z-score
## I'm going to filter the time period down to May and Juen because that's the most relevant period that juvenile salmon are likely to be in the Strait of Georgia

sst_annual_mean <- ctd_all %>%
  ungroup() %>%
  mutate(date = as_date(date)) %>%
  mutate(month = month(date), year = year(date)) %>%
  filter(month >= 5 & month <= 6, station == "QU39") %>%
  select(year, mean_temp) %>%
  group_by(year) %>%
  summarise(mean_temp = mean(mean_temp, na.rm = T))

sst_mean <- mean(sst_annual_mean$mean_temp)
sst_sd <- sd(sst_annual_mean$mean_temp)

sst_z <- (sst_annual_mean$mean_temp - sst_mean) / sst_sd

sst_time_series_stats <- ctd_all %>%
  ungroup() %>%
  mutate(date = as_date(date)) %>%
  mutate(month = month(date), year = year(date)) %>%
  filter(month >= 5 & month <= 6, station == "QU39") %>%
  select(year, mean_temp) 

sst_current_year <- sst_time_series_stats %>% 
  filter(year == current_year)

sst_stats_table <- broom::tidy(t.test(sst_current_year$mean_temp, sst_time_series_stats$mean_temp))
```

Sea-surface temperatures in May and June at QU39 in the northern Strait of Georgia was `r round(sst_stats_table$estimate, 2)` degrees C warmer than normal (Z = `r round(last(sst_z),2)`). Sea surface temperatures between May and July of 2018 were warmer than the time series average. (Figure \@ref(fig:sst))

```{r sst, out.width="80%", fig.cap="Time series of 30 m depth integrated temperature anomalies observed at Hakai Oceanographic Monitoring station QU39. Blue areas represent temperatures that are below normal, red areas represent above normal temperatures at the selected station in 2018. Normal is the solid black line which is a loess regression based on temperatures from 2015-2018. The shaded grey area is 1 SE of the loess regression. The black dots are the daily minimum and maximum temperatures observed over the time series."}

temperature_anomaly_data <- temperature_anomaly_data %>% 
      filter(station == "QU39")
    
    min_max_data <- min_max_data %>% 
      filter(station == "QU39")
    
    average_temps <- average_temps %>% 
      filter(station == "QU39")

ggplot(data = temperature_anomaly_data, aes(x = yday, y = mean_temp)) +
      geom_point(aes(x = yday, y = predicted_mean_temp), size = 0.1)+
      geom_line(aes(x = yday, y = predicted_mean_temp)) +
      geom_ribbon(data = subset(temperature_anomaly_data, 
                                mean_temp >= predicted_mean_temp),
                  aes(ymin = predicted_mean_temp, ymax = mean_temp),
                  fill = 'red', size = 1)+
      geom_ribbon(data = subset(temperature_anomaly_data, 
                                mean_temp <= predicted_mean_temp), 
                  aes(ymin = mean_temp, ymax = predicted_mean_temp),
                  fill = 'blue', size = 1)+
      theme_bw() +
      geom_smooth(data = average_temps, aes(x = yday, y = mean_temp),
                  size = 1, colour = 'black', se = T, span = .65) +
      geom_point(data = min_max_data,
                 aes(x = yday, y = min_temp), size = 0.5) +
      geom_point(data = min_max_data,
                 aes(x = yday, y = max_temp), size = 0.5) + 
      scale_x_continuous(breaks = (c(32, 60, 91, 121, 152, 182, 213)),
                         labels = (c("Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug"))) +
      theme_bw(base_size = 17) +
      labs(x = "Date", y = "Temperature [°C]") +
      coord_cartesian(xlim = c(32,213)) 

ggsave(here("figs", "sst.png"))

```


# Tables {-}

```{r mtdi}
knitr::kable(iqr_DI_allyears, format = 'markdown')
```
Table: (\#tab:mtdi) Migration timing statistics for the cumulative catch of sockeye, pink, and chum salmon in the Discovery Islands in 2018, compared to the time-series average (2015 - `r current_year`). Q1 is when 25 % of the species passed through the regions, peak date is the median when 50 % passed through, and Q3 is 75%. The region DI indicates the Discovery Islands while for species SO is sockeye, PI is pink, and CU is chum. 

```{r length}
knitr::kable(tsa_length, format = 'markdown')
```
Table: (\#tab:length) Mean fork lengths for each year, species, and region including the time series average (2015 - `r current_year`), with the 95 % confidence interval (95% CI). The column n indicates the number of fish measured, except for the time series where n indicates the number of years averaged.

```{r proptable}
knitr::kable(proportions_table, format = 'markdown')
```
Table: (\#tab:proptable) The species proportions of total catch in each year for sockeye, pink, chum, herring, coho, and chinook.


```{r parasites, fig.cap = "Mean sea-lice loads (with 95% CI calculated from annual averages)"}
knitr::kable(time_series_parasite_summary, format = 'markdown', caption = "Mean sea-lice loads (with 95% CI calculated from annual averages) ")
```
Table: (\#tab:parasites) Mean sea-lice abundance, prevalence, and intensity (Margolis et al. 1990) for the time series (2015-`r current_year`) as well as for each species, region, and year with 95% confidence interval calculated from annual averages. The region DI indicates the Discovery Islands and JS Johnstone Strait. Species codes are SO for sockeye, PI for pink, and CU for chum.

# References {-}





