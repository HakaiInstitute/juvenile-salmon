---
title: "Sea Lice Samples"
author: "Brett Johnson"
date: "2017-11-15"
output:
  rmarkdown::pdf_document:
    
    fig_caption: yes
    includes:
      in_header: figure_opts.tex
    latex_engine: xelatex
sansfont: Times New Roman
fontsize: 12pt

header-includes:
- \usepackage{booktabs}
- \usepackage{sectsty} \sectionfont{\centering \emph}
      
---

\begin{center}
\large
— Hakai Institute Juvenile Salmon Program —
\end{center}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lubridate)
library(plotly)

#source("read_current_data_package.R")

fish_field_data <- read_csv("fish_field_data.csv")
sealice_lab_motile <- read_csv("sealice_lab_motiles.csv")
seine_data <- read_csv("seine_data.csv")
survey_data <- read_csv("survey_data.csv")
sample_metadata <- read_csv("sample_metadata.csv")
sample_container_inventory <- read_csv("sample_container_inventory.csv")
PI_CU_2015_core_dissections_update <- read_csv("PI_CU_2015_core_dissections_update.csv")

survey_data <- survey_data %>% 
  mutate(sampling_week = as.numeric((yday(survey_date) + 4) %/% 7))

survey_data <- survey_data %>%
  mutate(sampling_week = recode_factor(survey_data$sampling_week, `18` = "May 5", `19` = "May 12" , 
                                       `20` = "May 19", `21` = "May 26", `22` = "June 2",
                                       `23` = "June 9", `24` = "June 16", `25` = "June 23",
                                       `26` = "June 30", `27` = "July 6", `28` = "July 13"))

fish_data <- left_join(fish_field_data, fish_lab_data, by = "ufn")
survey_seines <- full_join(survey_data, seine_data)
survey_seines_fish <- full_join(survey_seines, fish_data)
lice_samples <- full_join(survey_seines_fish, sealice_lab_motiles)
lice_samples <- full_join(lice_samples, sample_metadata) 
lice_samples <- left_join(lice_samples, sample_container_inventory)

mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
  condition <- eval(substitute(condition), .data, envir)
  .data[condition, ] <- .data[condition, ] %>% mutate(...)
  .data
}
```

# All Sealice Life Stage Taxonomy Samples Stored in Formalin

In 2015 the SEMSP lab crew retained all life stages of sea-lice found on the
fish they dissected. Most of the fish dissected were sockeye. Figure 1 shows a plot
of formalin sealice samples currently available. Some of the sockeye data points already
have results associated with them.

Go to [this link](https://drive.google.com/open?id=1gUAgziF3GHbtKVEE_Sus3LRdyJ767RVn) to download the data table that underpins this plot.

```{r All Formalin Sea Lice Samples plot, fig.cap = "The spatial and temporal distribution of all life stages of sea lice stored in formalin from the 2015 sampling season."}
lice_samples_available <- lice_samples %>%  
  filter(sample_type %in% c("sealice", "sealice_cal", "sealice_lep")) %>% 
  filter(species %in% c("SO", "PI", "CU")) %>% 
  mutate(year = as.factor(year(survey_date))) %>% 
  select(survey_date, year, species, site_id, sample_type, sample_status, storage_medium, lice_id_protocol_lab, current_location,
         storage_unit, group_box, storage_shelf, storage_tray) %>% 
  filter(storage_medium == "Formalin") %>% 
  mutate_cond(is.na(lice_id_protocol_lab), sample_status = "collected") %>% 
  mutate_cond(is.na(sample_status), sample_status = "results") %>% 
  select(-sample_type, -lice_id_protocol_lab) %>% 
  group_by(survey_date, site_id, species, sample_status, current_location) %>% 
  summarize(n = n()) %>% 
  ungroup()

ggplot(lice_samples_available, aes(x = survey_date, y = site_id, colour = n, group = sample_status))+
    geom_point(size = 3) +
    scale_colour_gradient() +
    facet_wrap(~species, scales = "free")
```


```{r All Formalin Sea Lice Samples Table}
lice_samples_available_tbl <- lice_samples_available %>%
  mutate(sample_status = NA) %>% 
  mutate_cond(licing_protocol_lab == "labcount_noid", sample_status = "collected") %>% 
  mutate_cond(licing_protocol_lab == "lportner", sample_status = "results") %>% 
  select(species, survey_date, site_id, sample_status, n)
  
#write_csv(lice_samples_available_tbl, "Sea lice/Sea Lice Strategy/processed_data/formalin_lice_samples.csv")

```

# Undissected 2015 Pink and Chum Available For Sea Licing
If the goal is to
compare all life stages of sea lice between sockeye, pink, and chum,
then more fish will have to have lice picked off them. All of the core stations for 2015 and 2016 Pink and Chum have been dissected and 
have not had all taxonomic stages of sea lice retained. It will not be possible to
have all life stage sea lice data for core stations for Pink, or Chum for 2015 or
2016 because these fish have already been dissected. It would be tempting to try to enumerate 
lice from the carcasses of fish that have already been dissected but not
all the lice remain on the carcass. Therefore, Figure 2 indicates which Pink and Chum
have not been dissected and therefore could have their lice picked off of them.

See [this link](https://drive.google.com/open?id=1wC31wq1NuNOfLx6mQq9Ey7k9VaX3DpMk)
to download the data table that underpins Figure 2.

```{r Fish not yet processed, fig.cap="Pink and Chum caught in 2015 that are available to have all life stages of sealice picked off and identified"}
pi_cu_to_dissect <- PI_CU_2015_core_dissections_update %>% 
  filter(species %in% c("PI", "CU")) %>% 
  select(date_caught, site, species, n_to_dissect) %>% 
  rename(survey_date = date_caught, site_id = site)

pi_cu_dissected <- survey_seines_fish %>% 
  filter(survey_date < "2016-01-01") %>% 
  filter(species %in% c("PI", "CU")) %>% 
  group_by(survey_date, site_id, species) %>% 
  summarize(n_dissected = n())

pi_cu_dissected <- left_join(pi_cu_dissected, pi_cu_to_dissect, by = c("survey_date", "site_id", "species")) %>% 
  mutate_cond(is.na(n_to_dissect), n_to_dissect = 0) %>% 
  mutate(n_more_to_dissect = n_to_dissect - n_dissected) %>% 
  mutate_cond(n_more_to_dissect >=0, n_dissected = n_dissected + n_more_to_dissect) %>% 
  select(-n_to_dissect, -n_more_to_dissect)

to_dissect_not_joined <- anti_join(pi_cu_to_dissect, pi_cu_dissected, by = c("survey_date", "site_id", "species"))
  
pi_cu_dissected <- bind_rows(to_dissect_not_joined, pi_cu_dissected) %>% 
  mutate_cond(is.na(n_dissected), n_dissected = n_to_dissect) %>% 
  select(-n_to_dissect)

pi_cu_caught <- survey_seines %>% 
  filter(survey_date < "2016-01-01") %>% 
  rename(PI = pi_taken, CU = cu_taken) %>% 
  gather(`PI`, `CU`, key = "species", value = "n_taken") %>% 
  select(survey_date, site_id, species, n_taken) %>% 
  filter(n_taken > 0) %>% 
  drop_na(n_taken)
 

pi_cu_remaining <- left_join(pi_cu_caught, pi_cu_dissected, by = c("survey_date", "site_id", "species")) %>% 
  mutate_cond(is.na(n_dissected), n_dissected = 0) %>% 
  mutate(n_remaining = n_taken - n_dissected) %>% 
  filter(n_remaining > 0)


ggplot(pi_cu_remaining, aes(x = survey_date, y = site_id, colour = n_remaining))+
    geom_point(size = 3) +
    scale_colour_gradient() +
    facet_wrap(~species, scales = "free")

#write_csv(pi_cu_remaining, "./Sea lice/Sea Lice Strategy/processed_data/pi_cu_remaining.csv")
```

